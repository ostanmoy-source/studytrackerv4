<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Focus â€” Study Tracker</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<!-- Your Firebase config â€” fill in firebase-config.js -->
<script src="firebase-config.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#0e0d0b; --bg2:#161512; --bg3:#1e1c19; --bg4:#252320;
  --border:#2e2c28; --text:#f0ead8; --text2:#a09880; --text3:#5a5548;
  --accent:#e8a832; --accent2:#c47f15;
  --accent-dim:rgba(232,168,50,0.12); --accent-glow:rgba(232,168,50,0.25);
  --green:#6fcf87; --red:#e86868; --blue:#68a8e8; --purple:#a868e8;
  --radius:12px; --radius-sm:8px;
  --shadow:0 4px 24px rgba(0,0,0,0.4); --shadow-lg:0 8px 48px rgba(0,0,0,0.6);
  --transition:0.2s ease;
  --font-display:'DM Serif Display',serif;
  --font-body:'DM Sans',sans-serif;
  --font-mono:'DM Mono',monospace;
}
[data-theme="light"]{
  --bg:#f8f4ec;--bg2:#f0ead8;--bg3:#e8e0cc;--bg4:#ddd5be;
  --border:#d0c8b0;--text:#1a1810;--text2:#5a5040;--text3:#a09070;
  --accent:#c47f15;--accent2:#a06810;
  --accent-dim:rgba(196,127,21,0.12);--accent-glow:rgba(196,127,21,0.25);
  --shadow:0 4px 24px rgba(0,0,0,0.12);--shadow-lg:0 8px 48px rgba(0,0,0,0.2);
}
[data-theme="dim"]{
  --bg:#070707;--bg2:#0c0c0c;--bg3:#111111;--bg4:#161616;
  --border:#1f1f1f;--text:#c8c0a8;--text2:#706858;--text3:#3a3830;
  --accent:#c8881a;--accent2:#a06810;
  --shadow:0 4px 24px rgba(0,0,0,0.7);--shadow-lg:0 8px 48px rgba(0,0,0,0.9);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;transition:background .3s,color .3s}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.35}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH GATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#authGate{
  position:fixed;inset:0;background:var(--bg);z-index:10000;
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;
}
.gate-loader{width:32px;height:32px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.gate-text{font-family:var(--font-mono);font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-wrapper{display:flex;min-height:100vh}
.sidebar{width:224px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:100;transition:transform .3s ease}
.sidebar-logo{padding:20px 18px 14px;border-bottom:1px solid var(--border)}
.logo-name{font-family:var(--font-display);font-size:22px;color:var(--accent);letter-spacing:-.5px;text-shadow:0 0 20px var(--accent-glow)}
.logo-user{font-family:var(--font-mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sidebar-nav{flex:1;padding:12px 0;overflow-y:auto}
.nav-section{padding:0 10px;margin-bottom:4px}
.nav-label{font-family:var(--font-mono);font-size:9.5px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;padding:5px 8px;margin-bottom:2px}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:var(--radius-sm);cursor:pointer;color:var(--text2);font-size:13px;font-weight:400;transition:all var(--transition);border:none;background:none;width:100%;text-align:left}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.active{background:var(--accent-dim);color:var(--accent);font-weight:500}
.nav-icon{font-size:14px;min-width:18px;text-align:center}
.sidebar-bottom{padding:12px 14px;border-top:1px solid var(--border)}
.user-card{display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:8px 10px;background:var(--bg3);border-radius:var(--radius-sm);border:1px solid var(--border)}
.user-avatar{width:30px;height:30px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;color:#0e0d0b;flex-shrink:0}
.user-name{font-size:12px;font-weight:500;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.user-email{font-family:var(--font-mono);font-size:9px;color:var(--text3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.streak-row{display:flex;align-items:center;justify-content:space-between}
.streak-badge{display:flex;align-items:center;gap:5px;font-family:var(--font-mono);font-size:11px;color:var(--accent)}
.streak-num{font-size:18px;font-weight:500}
.main{margin-left:224px;flex:1;padding:26px 30px;max-width:calc(100vw - 224px)}
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;flex-wrap:wrap;gap:10px}
.topbar-left{display:flex;align-items:center;gap:14px}
.page-title{font-family:var(--font-display);font-size:24px;color:var(--text)}
.topbar-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.clock{font-family:var(--font-mono);font-size:12px;color:var(--text2);background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:5px 10px;letter-spacing:1px}
.page-section{display:none}
.page-section.active{display:block}
.hamburger{display:none;background:none;border:none;color:var(--text);font-size:18px;cursor:pointer;padding:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS & GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:border-color var(--transition);position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent-dim),transparent)}
.card:hover{border-color:var(--text3)}
.card-title{font-family:var(--font-mono);font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:12px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.grid-auto{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.mb{margin-bottom:12px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font-body);font-weight:500;transition:all var(--transition);display:inline-flex;align-items:center;gap:7px}
.btn-primary{background:var(--accent);color:#0e0d0b;padding:10px 24px;font-size:13.5px;border-radius:100px}
.btn-primary:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 14px var(--accent-glow)}
.btn-primary:active{transform:translateY(0)}
.btn-secondary{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:8px 16px;font-size:13px;border-radius:100px}
.btn-secondary:hover{background:var(--bg4);color:var(--text)}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--text3);padding:6px 12px;font-size:11.5px;border-radius:var(--radius-sm);font-family:var(--font-mono)}
.btn-ghost:hover{border-color:var(--text2);color:var(--text2)}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-icon{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px;border-radius:var(--radius-sm);font-size:14px;line-height:1;cursor:pointer;transition:all var(--transition)}
.btn-icon:hover{background:var(--bg4);color:var(--text)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.inp{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:var(--font-body);font-size:13px;padding:8px 12px;outline:none;width:100%;transition:border-color var(--transition)}
.inp:focus{border-color:var(--accent)}
.inp::placeholder{color:var(--text3)}
.form-label{display:block;font-family:var(--font-mono);font-size:9.5px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:5px}
.form-group{margin-bottom:12px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timer-hero{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:26px 22px;display:flex;flex-direction:column;align-items:center;gap:14px;position:relative;overflow:hidden}
.timer-hero::before{content:'';position:absolute;top:-70px;right:-70px;width:260px;height:260px;background:radial-gradient(circle,var(--accent-glow),transparent 70%);pointer-events:none;animation:glowPulse 4s ease-in-out infinite}
@keyframes glowPulse{0%,100%{opacity:.5;transform:scale(1)}50%{opacity:1;transform:scale(1.08)}}
.mode-row{display:flex;gap:5px;background:var(--bg3);border-radius:100px;padding:3px}
.mode-btn{background:none;border:none;padding:5px 13px;border-radius:100px;font-family:var(--font-mono);font-size:10.5px;color:var(--text2);cursor:pointer;transition:all var(--transition)}
.mode-btn.active{background:var(--accent);color:#0e0d0b;font-weight:500}
.timer-display{font-family:var(--font-mono);font-size:78px;font-weight:300;color:var(--text);letter-spacing:-3px;line-height:1;transition:color .3s,text-shadow .3s;position:relative;z-index:1}
.timer-display.running{color:var(--accent);text-shadow:0 0 30px var(--accent-glow)}
.timer-display.paused{color:var(--text2)}
.timer-phase{font-family:var(--font-mono);font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text3)}
.pomo-dots{display:flex;gap:6px}
.pomo-dot{width:8px;height:8px;border-radius:50%;background:var(--bg4);border:1px solid var(--border);transition:all .3s}
.pomo-dot.done{background:var(--accent);border-color:var(--accent)}
.pomo-dot.current{background:var(--accent-dim);border-color:var(--accent);box-shadow:0 0 6px var(--accent-glow)}
.timer-bar{width:100%;max-width:380px;height:3px;background:var(--bg4);border-radius:2px;overflow:hidden}
.timer-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px;transition:width 1s linear;box-shadow:0 0 6px var(--accent-glow)}
.timer-meta{display:flex;gap:9px;flex-wrap:wrap;justify-content:center;align-items:center}
.meta-select{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-family:var(--font-mono);font-size:11px;padding:6px 10px;outline:none;cursor:pointer}
.meta-select:focus{border-color:var(--accent)}
.timer-controls{display:flex;gap:9px;align-items:center}
.quote-strip{width:100%;text-align:center;font-family:var(--font-display);font-style:italic;font-size:13px;color:var(--text3);padding:7px 0;border-top:1px solid var(--border);margin-top:2px;transition:opacity .4s;position:relative;z-index:1}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAT ROW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stat-row{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:12px}
.stat-item{display:flex;flex-direction:column;gap:3px}
.stat-value{font-family:var(--font-mono);font-size:21px;font-weight:500;color:var(--text);line-height:1}
.stat-label{font-size:11px;color:var(--text3)}
.stat-div{width:1px;background:var(--border);margin:3px 0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ring-row{display:flex;align-items:center;gap:16px}
.ring-wrap{position:relative;display:flex;align-items:center;justify-content:center}
.ring-label{position:absolute;text-align:center}
.ring-pct{font-family:var(--font-mono);font-size:17px;font-weight:500;color:var(--text);display:block}
.ring-sub{font-size:9px;color:var(--text3);font-family:var(--font-mono)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOAL BARS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.goal-item{margin-bottom:12px}
.goal-hd{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px}
.goal-name{font-size:13px;color:var(--text)}
.goal-txt{font-family:var(--font-mono);font-size:10px;color:var(--text3)}
.goal-bar{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden}
.goal-fill{height:100%;border-radius:2px;transition:width .5s ease}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RATING BTNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rating-row{display:flex;gap:5px}
.r-btn{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-family:var(--font-mono);font-size:12px;width:33px;height:33px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all var(--transition)}
.r-btn:hover{border-color:var(--accent);color:var(--accent)}
.r-btn.sel{background:var(--accent);border-color:var(--accent);color:#0e0d0b;font-weight:600}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASK LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.task-list{display:flex;flex-direction:column;gap:5px}
.task-item{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);transition:all var(--transition);animation:slideIn .2s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}
.task-item:hover{border-color:var(--text3)}
.task-item.done{opacity:.4}
.task-item.done .task-text{text-decoration:line-through;color:var(--text3)}
.task-check{width:16px;height:16px;border:1.5px solid var(--border);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all var(--transition)}
.task-check.checked{background:var(--green);border-color:var(--green)}
.task-check.checked::after{content:'âœ“';font-size:10px;color:#fff;font-weight:700}
.task-text{flex:1;font-size:13px;color:var(--text)}
.task-sub{font-size:10px;color:var(--text3);font-family:var(--font-mono)}
.pdot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.pdot.high{background:var(--red)}.pdot.medium{background:var(--accent)}.pdot.low{background:var(--text3)}
.task-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:12px;padding:2px 4px;border-radius:3px;transition:all var(--transition);opacity:0}
.task-item:hover .task-del{opacity:1}
.task-del:hover{color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOG TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.log-wrap{overflow-x:auto;border-radius:var(--radius-sm);border:1px solid var(--border)}
.log-table{width:100%;border-collapse:collapse;font-size:12px}
.log-table th{font-family:var(--font-mono);font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);text-align:left;padding:8px 12px;background:var(--bg3);border-bottom:1px solid var(--border);white-space:nowrap}
.log-table td{padding:8px 12px;border-bottom:1px solid var(--border);color:var(--text2);white-space:nowrap}
.log-table tr:last-child td{border-bottom:none}
.log-table tr.log-row:hover td{background:var(--bg3);color:var(--text);cursor:pointer}
.log-expand{display:none;background:var(--bg3);border-bottom:1px solid var(--border)}
.log-expand td{white-space:normal;font-size:12.5px;color:var(--text2);padding:10px 12px 14px}
.log-expand.open{display:table-row}
.focus-stars{color:var(--accent);letter-spacing:1px}
.type-badge{display:inline-block;font-family:var(--font-mono);font-size:9px;padding:2px 7px;border-radius:100px;background:var(--accent-dim);color:var(--accent);border:1px solid rgba(232,168,50,.2)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEATMAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hm-col{display:flex;flex-direction:column;gap:3px}
.heatmap{display:flex;gap:3px}
.hm-cell{width:12px;height:12px;border-radius:2px;background:var(--bg4);position:relative;cursor:default}
.hm-cell:hover::after{content:attr(data-tip);position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:3px 7px;font-size:10px;color:var(--text);white-space:nowrap;z-index:10;pointer-events:none;font-family:var(--font-mono)}
.hm-cell.l1{background:rgba(232,168,50,.2)}.hm-cell.l2{background:rgba(232,168,50,.45)}.hm-cell.l3{background:rgba(232,168,50,.7)}.hm-cell.l4{background:rgba(232,168,50,.95);box-shadow:0 0 3px var(--accent-glow)}
.hm-day-label{font-family:var(--font-mono);font-size:9px;color:var(--text3);height:12px;line-height:12px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BADGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.badges-grid{display:flex;flex-wrap:wrap;gap:10px}
.badge{display:flex;flex-direction:column;align-items:center;gap:5px;padding:13px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);min-width:88px;transition:all .2s;opacity:.3;filter:grayscale(1)}
.badge.earned{opacity:1;filter:none;border-color:var(--accent);background:var(--accent-dim)}
.badge-icon{font-size:24px}
.badge-name{font-family:var(--font-mono);font-size:9px;color:var(--text3);text-align:center;text-transform:uppercase;letter-spacing:.5px}
.badge.earned .badge-name{color:var(--accent)}
.badge-desc{font-size:10px;color:var(--text3);text-align:center}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.note-toolbar{display:flex;gap:5px;flex-wrap:wrap;padding:6px 8px;background:var(--bg3);border-radius:var(--radius-sm) var(--radius-sm) 0 0;border:1px solid var(--border);border-bottom:none}
.note-tool{background:none;border:none;color:var(--text2);font-size:12px;padding:4px 6px;cursor:pointer;border-radius:3px;transition:all .2s;font-weight:500}
.note-tool:hover{background:var(--bg4);color:var(--text)}
.note-area{width:100%;min-height:280px;background:var(--bg2);border:1px solid var(--border);border-radius:0 0 var(--radius-sm) var(--radius-sm);color:var(--text);font-family:var(--font-body);font-size:13.5px;line-height:1.7;padding:14px;outline:none;resize:vertical;transition:border-color .2s}
.note-area:focus{border-color:var(--accent)}
.note-tag{display:inline-flex;align-items:center;gap:4px;background:var(--accent-dim);border:1px solid rgba(232,168,50,.2);border-radius:100px;padding:2px 9px;font-size:10px;color:var(--accent);font-family:var(--font-mono)}
.note-tag-del{cursor:pointer;color:var(--accent2);font-size:11px}
.note-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.note-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;cursor:pointer;transition:all .2s;margin-bottom:6px}
.note-card:hover{border-color:var(--accent)}
.note-card-title{font-size:13px;color:var(--text);margin-bottom:3px;font-weight:500}
.note-card-preview{font-size:11.5px;color:var(--text3);overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.note-card-meta{font-family:var(--font-mono);font-size:9px;color:var(--text3);margin-top:5px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUBJECT CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.subject-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:15px;position:relative;overflow:hidden;transition:all .2s}
.subject-card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--subject-color,var(--accent));box-shadow:2px 0 8px var(--subject-color,var(--accent-glow))}
.subject-card:hover{border-color:var(--text3);transform:translateY(-1px);box-shadow:var(--shadow)}
.subject-name{font-family:var(--font-display);font-size:16px;color:var(--text);margin-bottom:8px}
.s-stats{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px}
.s-stat{font-size:12px;color:var(--text2);font-family:var(--font-mono)}
.s-stat strong{color:var(--text)}
.s-bar{height:3px;background:var(--bg4);border-radius:2px;overflow:hidden}
.s-bar-fill{height:100%;border-radius:2px;transition:width .5s ease}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXAM COUNTDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.exam-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
.exam-item:last-child{border-bottom:none}
.exam-name{font-size:13px;color:var(--text)}
.exam-date{font-size:10px;color:var(--text3);font-family:var(--font-mono)}
.exam-days{font-family:var(--font-mono);font-size:20px;font-weight:500;color:var(--accent)}
.exam-days.urgent{color:var(--red);animation:urgentPulse 1s ease-in-out infinite alternate}
@keyframes urgentPulse{from{opacity:.7}to{opacity:1}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REVIEW CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.review-card{background:linear-gradient(135deg,var(--bg2),var(--bg3));border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;overflow:hidden}
.review-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--accent-dim),transparent 60%);pointer-events:none}
.review-headline{font-family:var(--font-display);font-size:16px;color:var(--text);margin-bottom:5px;position:relative;z-index:1}
.review-body{font-size:13px;color:var(--text2);line-height:1.6;position:relative;z-index:1}
.review-highlight{color:var(--accent);font-weight:600}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PUBLIC PROFILE PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.profile-banner{background:linear-gradient(135deg,var(--bg2),var(--bg3));border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:12px;position:relative;overflow:hidden}
.profile-banner::before{content:'';position:absolute;top:-40px;right:-40px;width:180px;height:180px;background:radial-gradient(circle,var(--accent-glow),transparent 70%);pointer-events:none}
.profile-avatar-lg{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:#0e0d0b;margin-bottom:12px;border:2px solid var(--border)}
.profile-display-name{font-family:var(--font-display);font-size:22px;color:var(--text);margin-bottom:3px}
.profile-handle{font-family:var(--font-mono);font-size:11px;color:var(--text3);margin-bottom:12px}
.profile-currently{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;display:flex;align-items:center;gap:10px;margin-bottom:14px}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 6px rgba(111,207,135,.5);animation:livePulse 1.5s ease-in-out infinite}
@keyframes livePulse{0%,100%{opacity:1}50%{opacity:.4}}
.currently-text{font-size:13px;color:var(--text)}
.currently-sub{font-size:11px;color:var(--text3);font-family:var(--font-mono)}
.pub-stats{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:14px}
.pub-stat{display:flex;flex-direction:column;gap:2px}
.pub-stat-val{font-family:var(--font-mono);font-size:20px;font-weight:500;color:var(--text)}
.pub-stat-lbl{font-size:11px;color:var(--text3)}
.share-btn{display:flex;align-items:center;gap:7px;background:var(--accent);color:#0e0d0b;border:none;border-radius:100px;padding:9px 20px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;font-family:var(--font-body)}
.share-btn:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 12px var(--accent-glow)}
.privacy-notice{font-family:var(--font-mono);font-size:9.5px;color:var(--text3);margin-top:10px;line-height:1.5}
.privacy-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.privacy-item{display:flex;align-items:center;gap:5px;font-family:var(--font-mono);font-size:10px}
.privacy-dot{width:6px;height:6px;border-radius:50%}
.privacy-dot.pub{background:var(--green)}
.privacy-dot.priv{background:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PUBLIC PROFILE VIEW (readonly)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#pubProfileOv{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:400;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
#pubProfileOv.active{display:flex}
.pub-profile-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:28px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:mIn .25s ease;position:relative}
@keyframes mIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.pub-profile-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:var(--radius) var(--radius) 0 0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOUND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sound-btns{display:flex;gap:7px;flex-wrap:wrap}
.sound-btn{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-size:12px;padding:7px 12px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px;font-family:var(--font-mono)}
.sound-btn:hover{border-color:var(--accent);color:var(--accent)}
.sound-btn.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LINK ITEMS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.link-item{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:6px;transition:all .2s;text-decoration:none;border-left:3px solid transparent}
.link-item:hover{border-left-color:var(--accent);background:var(--accent-dim)}
.link-name{font-size:13px;color:var(--text)}
.link-url{font-size:10px;color:var(--text3);font-family:var(--font-mono)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:500;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-ov.active{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:24px;width:100%;max-width:440px;max-height:90vh;overflow-y:auto;animation:mIn .2s ease;position:relative}
.modal::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
.modal-title{font-family:var(--font-display);font-size:19px;color:var(--text);margin-bottom:16px}
.modal-actions{display:flex;gap:7px;justify-content:flex-end;margin-top:16px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.zen-ov{position:fixed;inset:0;background:var(--bg);z-index:1000;display:none;flex-direction:column;align-items:center;justify-content:center;gap:20px}
.zen-ov.active{display:flex}
.zen-ov::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,rgba(232,168,50,.06) 0%,transparent 60%);pointer-events:none}
.zen-task{font-family:var(--font-display);font-style:italic;font-size:18px;color:var(--text2);text-align:center;max-width:480px}
.zen-exit{position:absolute;top:20px;right:20px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KBD HUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.kbd-hud{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border);border-radius:100px;padding:6px 16px;font-family:var(--font-mono);font-size:10.5px;color:var(--text3);z-index:200;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;box-shadow:var(--shadow)}
.kbd-hud.show{opacity:1}
kbd{background:var(--bg4);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:10px;color:var(--text2)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTIF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.notif{position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;color:var(--text);font-size:13px;z-index:2000;transform:translateX(130%);transition:transform .3s ease;max-width:300px;box-shadow:var(--shadow-lg)}
.notif.show{transform:translateX(0)}
.notif.success{border-left:3px solid var(--green)}
.notif.info{border-left:3px solid var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CRASH BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.recovery-banner{background:var(--accent-dim);border:1px solid var(--accent);border-radius:var(--radius-sm);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;font-size:13px;color:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-wrap{position:relative;width:100%;min-height:190px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty{text-align:center;padding:22px;color:var(--text3);font-size:13px}
.empty-icon{font-size:24px;margin-bottom:6px;opacity:.35}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:900px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0);box-shadow:var(--shadow-lg)}
  .main{margin-left:0;max-width:100vw;padding:16px 14px}
  .hamburger{display:block}
  .grid-2{grid-template-columns:1fr}
  .grid-3{grid-template-columns:1fr 1fr}
  .timer-display{font-size:58px}
}
@media(max-width:560px){.grid-3{grid-template-columns:1fr}.timer-display{font-size:46px}}
.fade-in{animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT / STUDY LOUNGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lounge-layout{display:grid;grid-template-columns:1fr 260px;gap:12px;height:calc(100vh - 160px);min-height:500px}
@media(max-width:900px){.lounge-layout{grid-template-columns:1fr;height:auto}}
.chat-panel{display:flex;flex-direction:column;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.chat-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.chat-header-title{font-family:var(--font-mono);font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:1.5px;display:flex;align-items:center;gap:8px}
.online-count{background:var(--bg3);border:1px solid var(--border);border-radius:100px;padding:2px 8px;font-size:10px;color:var(--green);font-family:var(--font-mono)}
.chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:2px;scroll-behavior:smooth}
.chat-messages::-webkit-scrollbar{width:3px}
.chat-messages::-webkit-scrollbar-thumb{background:var(--bg4)}

/* Message bubble */
.msg-row{display:flex;gap:9px;padding:4px 0;animation:msgIn .2s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg-row.own{flex-direction:row-reverse}
.msg-avatar{width:28px;height:28px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#0e0d0b;flex-shrink:0;margin-top:2px}
.msg-body{max-width:72%;display:flex;flex-direction:column;gap:3px}
.msg-row.own .msg-body{align-items:flex-end}
.msg-meta{display:flex;align-items:center;gap:7px;font-family:var(--font-mono);font-size:9.5px;color:var(--text3)}
.msg-name{color:var(--text2);font-weight:500}
.msg-bubble{background:var(--bg3);border:1px solid var(--border);border-radius:12px 12px 12px 3px;padding:8px 12px;font-size:13px;color:var(--text);line-height:1.5;word-break:break-word;position:relative}
.msg-row.own .msg-bubble{background:var(--accent-dim);border-color:rgba(232,168,50,.25);border-radius:12px 12px 3px 12px;color:var(--text)}
.msg-bubble:hover .msg-actions{opacity:1}
.msg-actions{position:absolute;top:-14px;right:6px;display:flex;gap:3px;opacity:0;transition:opacity .15s;background:var(--bg2);border:1px solid var(--border);border-radius:100px;padding:2px 5px}
.msg-row.own .msg-actions{right:auto;left:6px}
.reaction-pick{display:flex;gap:3px}
.react-btn{background:none;border:none;cursor:pointer;font-size:13px;padding:2px;border-radius:3px;transition:transform .1s;line-height:1}
.react-btn:hover{transform:scale(1.3)}

/* Reactions on message */
.msg-reactions{display:flex;gap:4px;flex-wrap:wrap;margin-top:3px}
.reaction-chip{display:flex;align-items:center;gap:3px;background:var(--bg3);border:1px solid var(--border);border-radius:100px;padding:2px 8px;font-size:11px;cursor:pointer;transition:all .15s;user-select:none}
.reaction-chip:hover{border-color:var(--accent)}
.reaction-chip.mine{background:var(--accent-dim);border-color:rgba(232,168,50,.3)}
.reaction-chip-count{font-family:var(--font-mono);font-size:10px;color:var(--text2)}

/* System messages */
.sys-msg{text-align:center;font-family:var(--font-mono);font-size:10px;color:var(--text3);padding:5px 0;opacity:.7}

/* Banned/muted */
.msg-bubble.muted-msg{opacity:.35;font-style:italic}

/* Chat input */
.chat-input-area{padding:10px 12px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end;flex-shrink:0}
.chat-input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:20px;color:var(--text);font-family:var(--font-body);font-size:13px;padding:9px 14px;outline:none;resize:none;max-height:100px;min-height:38px;transition:border-color .2s;line-height:1.4}
.chat-input:focus{border-color:var(--accent)}
.chat-input::placeholder{color:var(--text3)}
.send-btn{background:var(--accent);border:none;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .2s;font-size:15px}
.send-btn:hover{background:var(--accent2);transform:scale(1.05)}
.send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* Sidebar panels */
.lounge-sidebar{display:flex;flex-direction:column;gap:12px;overflow-y:auto}
.lounge-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:14px}

/* Online users list */
.online-user{display:flex;align-items:center;gap:9px;padding:6px 0;border-bottom:1px solid var(--border)}
.online-user:last-child{border-bottom:none}
.online-av{width:28px;height:28px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--text2);flex-shrink:0;position:relative}
.online-av::after{content:'';position:absolute;bottom:0;right:0;width:8px;height:8px;border-radius:50%;background:var(--green);border:2px solid var(--bg2)}
.online-user-name{font-size:12px;color:var(--text);font-weight:500}
.online-user-sub{font-size:10px;color:var(--text3);font-family:var(--font-mono)}

/* Leaderboard */
.lb-row{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border)}
.lb-row:last-child{border-bottom:none}
.lb-rank{font-family:var(--font-mono);font-size:13px;font-weight:700;width:20px;color:var(--text3);flex-shrink:0}
.lb-rank.gold{color:#f0c84e}.lb-rank.silver{color:#c0c0c0}.lb-rank.bronze{color:#cd7f32}
.lb-av{width:26px;height:26px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--text2);flex-shrink:0}
.lb-name{flex:1;font-size:12px;color:var(--text);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lb-mins{font-family:var(--font-mono);font-size:11px;color:var(--accent);flex-shrink:0}

/* Firebase loading state */
.chat-loading{display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:10px;color:var(--text3);font-family:var(--font-mono);font-size:11px}
.firebase-setup-banner{background:rgba(232,168,50,.08);border:1px solid var(--accent);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:12px;font-size:13px;color:var(--accent);line-height:1.6}
.firebase-setup-banner code{background:var(--bg3);padding:2px 6px;border-radius:3px;font-family:var(--font-mono);font-size:11px;color:var(--text2)}

/* Mute/admin controls */
.msg-admin-btn{background:none;border:none;cursor:pointer;font-size:10px;color:var(--text3);padding:1px 4px;border-radius:3px;transition:color .15s}
.msg-admin-btn:hover{color:var(--red)}
</style>
</head>
<body>

<!-- AUTH GATE -->
<div id="authGate">
  <div class="gate-loader"></div>
  <div class="gate-text">Authenticatingâ€¦</div>
</div>

<!-- NOTIFICATION -->
<div class="notif" id="notif"></div>

<!-- KBD HUD -->
<div class="kbd-hud" id="kbdHud">
  <kbd>Space</kbd> Start/Pause &nbsp;
  <kbd>S</kbd> Stop &nbsp;
  <kbd>Z</kbd> Zen &nbsp;
  <kbd>M</kbd> Manual Log &nbsp;
  <kbd>?</kbd> Hide
</div>

<!-- ZEN -->
<div class="zen-ov" id="zenOv">
  <div class="timer-phase" id="zenPhase">FOCUS</div>
  <div class="timer-display" id="zenTimer">00:00</div>
  <div class="timer-bar" style="max-width:320px"><div class="timer-fill" id="zenBar" style="width:100%"></div></div>
  <div class="zen-task" id="zenTask">No task set</div>
  <div class="timer-controls">
    <button class="btn btn-secondary" onclick="toggleTimer()"><span id="zenIcon">â–¶</span> <span id="zenLbl">Start</span></button>
    <button class="btn btn-ghost" onclick="stopTimer()">Stop</button>
  </div>
  <div class="zen-exit"><button class="btn btn-ghost btn-sm" onclick="toggleZen()">âœ• Exit Zen</button></div>
</div>

<!-- PUBLIC PROFILE OVERLAY -->
<div id="pubProfileOv">
  <div class="pub-profile-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div class="card-title" style="margin-bottom:0">ğŸŒ Public Profile Preview</div>
      <button class="btn btn-ghost btn-sm" onclick="closePubProfile()">âœ•</button>
    </div>
    <div id="pubProfileContent"></div>
    <div style="margin-top:16px;display:flex;gap:8px">
      <button class="btn btn-primary" onclick="copyProfileLink()">ğŸ“‹ Copy Profile Link</button>
      <button class="btn btn-ghost" onclick="closePubProfile()">Close</button>
    </div>
  </div>
</div>

<!-- SESSION COMPLETE MODAL -->
<div class="modal-ov" id="sessionModal">
  <div class="modal">
    <div class="modal-title">ğŸ‰ Session Complete!</div>
    <div class="form-group"><label class="form-label">Subject</label><select class="inp" id="sm_subject" style="cursor:pointer"></select></div>
    <div class="form-group"><label class="form-label">Topic</label><input type="text" class="inp" id="sm_topic" placeholder="What did you study?"></div>
    <div class="form-group">
      <label class="form-label">Session Type</label>
      <select class="inp" id="sm_type" style="cursor:pointer">
        <option>General</option><option>Active Recall</option><option>Reading</option>
        <option>Problem Solving</option><option>Revision</option><option>Lecture</option>
        <option>Writing</option><option>Research</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Focus Rating</label><div class="rating-row" id="sm_focus"><div class="r-btn" onclick="rate('focus',1)">1</div><div class="r-btn" onclick="rate('focus',2)">2</div><div class="r-btn sel" onclick="rate('focus',3)">3</div><div class="r-btn" onclick="rate('focus',4)">4</div><div class="r-btn" onclick="rate('focus',5)">5</div></div></div>
    <div class="form-group"><label class="form-label">Energy Level</label><div class="rating-row" id="sm_energy"><div class="r-btn" onclick="rate('energy',1)">1</div><div class="r-btn" onclick="rate('energy',2)">2</div><div class="r-btn sel" onclick="rate('energy',3)">3</div><div class="r-btn" onclick="rate('energy',4)">4</div><div class="r-btn" onclick="rate('energy',5)">5</div></div></div>
    <div class="form-group"><label class="form-label">Notes</label><input type="text" class="inp" id="sm_notes" placeholder="Quick reflectionâ€¦"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="saveSession(true)">Skip</button>
      <button class="btn btn-primary" onclick="saveSession(false)">Log Session âœ“</button>
    </div>
  </div>
</div>

<!-- MANUAL LOG MODAL -->
<div class="modal-ov" id="manualModal">
  <div class="modal">
    <div class="modal-title">â• Add Manual Session</div>
    <div class="form-group"><label class="form-label">Date</label><input type="date" class="inp" id="ml_date"></div>
    <div class="form-group"><label class="form-label">Subject</label><select class="inp" id="ml_subject" style="cursor:pointer"></select></div>
    <div class="form-group"><label class="form-label">Topic</label><input type="text" class="inp" id="ml_topic" placeholder="Topic studied"></div>
    <div class="form-group"><label class="form-label">Duration (minutes)</label><input type="number" class="inp" id="ml_duration" placeholder="60" min="1"></div>
    <div class="form-group"><label class="form-label">Type</label><select class="inp" id="ml_type" style="cursor:pointer"><option>General</option><option>Active Recall</option><option>Reading</option><option>Problem Solving</option><option>Revision</option><option>Lecture</option><option>Writing</option><option>Research</option></select></div>
    <div class="form-group"><label class="form-label">Focus Rating</label><div class="rating-row" id="ml_focus"><div class="r-btn" onclick="rateML(1)">1</div><div class="r-btn" onclick="rateML(2)">2</div><div class="r-btn sel" onclick="rateML(3)">3</div><div class="r-btn" onclick="rateML(4)">4</div><div class="r-btn" onclick="rateML(5)">5</div></div></div>
    <div class="form-group"><label class="form-label">Notes</label><input type="text" class="inp" id="ml_notes" placeholder="Optional"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('manualModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveManualSession()">Add Session</button>
    </div>
  </div>
</div>

<!-- ADD SUBJECT MODAL -->
<div class="modal-ov" id="addSubjectModal">
  <div class="modal">
    <div class="modal-title">Add Subject</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="inp" id="ns_name" placeholder="e.g. Mathematics"></div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div style="display:flex;gap:7px;flex-wrap:wrap" id="colorPick">
        <div class="r-btn" style="background:#e8a832;border-color:#e8a832;color:#000;cursor:pointer" onclick="pickColor('#e8a832',this)">â—</div>
        <div class="r-btn" style="background:#68a8e8;border-color:#68a8e8;color:#fff;cursor:pointer" onclick="pickColor('#68a8e8',this)">â—</div>
        <div class="r-btn" style="background:#6fcf87;border-color:#6fcf87;color:#fff;cursor:pointer" onclick="pickColor('#6fcf87',this)">â—</div>
        <div class="r-btn" style="background:#a868e8;border-color:#a868e8;color:#fff;cursor:pointer" onclick="pickColor('#a868e8',this)">â—</div>
        <div class="r-btn" style="background:#e86868;border-color:#e86868;color:#fff;cursor:pointer" onclick="pickColor('#e86868',this)">â—</div>
        <div class="r-btn" style="background:#68e8c8;border-color:#68e8c8;color:#000;cursor:pointer" onclick="pickColor('#68e8c8',this)">â—</div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addSubjectModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSubject()">Add</button>
    </div>
  </div>
</div>

<!-- ADD EXAM MODAL -->
<div class="modal-ov" id="addExamModal">
  <div class="modal">
    <div class="modal-title">Add Exam / Deadline</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="inp" id="ne_name" placeholder="e.g. Physics Final"></div>
    <div class="form-group"><label class="form-label">Date</label><input type="date" class="inp" id="ne_date"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addExamModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExam()">Add</button>
    </div>
  </div>
</div>

<!-- ADD LINK MODAL -->
<div class="modal-ov" id="addLinkModal">
  <div class="modal">
    <div class="modal-title">Add Quick Link</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="inp" id="nl_name" placeholder="Resource name"></div>
    <div class="form-group"><label class="form-label">URL</label><input type="url" class="inp" id="nl_url" placeholder="https://..."></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addLinkModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveLink()">Add</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-wrapper" id="appWrapper" style="display:none">

  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-name">Focus</div>
      <div class="logo-user" id="sidebarEmail">â€”</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-label">Study</div>
        <button class="nav-item active" onclick="nav('dashboard',this)"><span class="nav-icon">âš¡</span>Dashboard</button>
        <button class="nav-item" onclick="nav('log',this)"><span class="nav-icon">ğŸ“‹</span>Study Log</button>
        <button class="nav-item" onclick="nav('tasks',this)"><span class="nav-icon">âœ…</span>Tasks</button>
        <button class="nav-item" onclick="nav('notes',this)"><span class="nav-icon">ğŸ“</span>Notes</button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Insights</div>
        <button class="nav-item" onclick="nav('analytics',this)"><span class="nav-icon">ğŸ“Š</span>Analytics</button>
        <button class="nav-item" onclick="nav('heatmap',this)"><span class="nav-icon">ğŸ—“</span>Calendar</button>
        <button class="nav-item" onclick="nav('badges',this)"><span class="nav-icon">ğŸ…</span>Badges</button>
        <button class="nav-item" onclick="nav('subjects',this)"><span class="nav-icon">ğŸ“š</span>Subjects</button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Plan</div>
        <button class="nav-item" onclick="nav('planner',this)"><span class="nav-icon">ğŸ“…</span>Planner</button>
        <button class="nav-item" onclick="nav('goals',this)"><span class="nav-icon">ğŸ¯</span>Goals</button>
        <button class="nav-item" onclick="nav('focus',this)"><span class="nav-icon">ğŸ§˜</span>Focus Tools</button>
        <button class="nav-item" onclick="nav('profile',this)"><span class="nav-icon">ğŸŒ</span>My Profile</button>
        <button class="nav-item" onclick="nav('lounge',this)"><span class="nav-icon">ğŸ’¬</span>Study Lounge <span id="unreadBadge" style="display:none;background:var(--red);color:#fff;font-size:9px;padding:1px 5px;border-radius:100px;font-family:var(--font-mono);margin-left:4px">0</span></button>
        <button class="nav-item" onclick="nav('settings',this)"><span class="nav-icon">âš™</span>Settings</button>
      </div>
    </div>
    <div class="sidebar-bottom">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">?</div>
        <div style="min-width:0">
          <div class="user-name" id="userName">User</div>
          <div class="user-email" id="userEmailFull">â€”</div>
        </div>
      </div>
      <div class="streak-row">
        <div class="streak-badge">ğŸ”¥ <span class="streak-num" id="streakNum">0</span> <span style="font-size:9px;color:var(--text3)">days</span></div>
        <div style="display:flex;gap:5px">
          <button class="btn-icon" onclick="cycleTheme()" id="themeBtn" title="Theme">â˜€</button>
          <button class="btn-icon" onclick="openModal('manualModal')" title="Manual log (M)">âœ</button>
          <button class="btn-icon" onclick="signOut()" title="Sign out">â¬¡</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
        <div class="page-title" id="pageTitle">Dashboard</div>
      </div>
      <div class="topbar-right">
        <div class="clock" id="topClock">00:00:00</div>
        <button class="btn btn-ghost btn-sm" onclick="toggleZen()">ğŸ§˜ Zen</button>
        <button class="btn btn-ghost btn-sm" onclick="exportCSV()">â†“ CSV</button>
      </div>
    </div>

    <div class="recovery-banner" id="recoveryBanner" style="display:none">
      âš¡ Unsaved session from last visit detected.
      <div style="display:flex;gap:7px">
        <button class="btn btn-primary btn-sm" onclick="restoreCrash()">Restore</button>
        <button class="btn btn-ghost btn-sm" onclick="dismissCrash()">Dismiss</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section class="page-section active fade-in" id="page-dashboard">
      <div class="timer-hero mb">
        <div class="mode-row">
          <button class="mode-btn active" onclick="setMode('p25',this)">25/5</button>
          <button class="mode-btn" onclick="setMode('p50',this)">50/10</button>
          <button class="mode-btn" onclick="setMode('sw',this)">Stopwatch</button>
          <button class="mode-btn" onclick="setMode('custom',this)">Custom</button>
        </div>
        <div class="pomo-dots" id="pomoDots"></div>
        <div class="timer-phase" id="timerPhase">FOCUS</div>
        <div class="timer-display" id="timerDisp">25:00</div>
        <div class="timer-bar"><div class="timer-fill" id="timerBar" style="width:100%"></div></div>
        <div class="timer-meta">
          <select class="meta-select" id="curSubject" onchange="onSubjectChange()"><option value="">Subjectâ€¦</option></select>
          <input type="text" class="inp" id="curTopic" placeholder="Topic / taskâ€¦" style="max-width:180px;font-size:12px" oninput="updateZenTask()">
          <select class="meta-select" id="curType"><option>General</option><option>Active Recall</option><option>Reading</option><option>Problem Solving</option><option>Revision</option><option>Lecture</option><option>Writing</option><option>Research</option></select>
        </div>
        <div class="timer-controls">
          <button class="btn btn-primary" id="startBtn" onclick="toggleTimer()">â–¶ Start</button>
          <button class="btn btn-secondary" onclick="stopTimer()">Stop</button>
          <button class="btn btn-ghost btn-sm" onclick="skipPhase()">Skip â†’</button>
        </div>
        <div class="quote-strip" id="quoteStrip">Loadingâ€¦</div>
      </div>

      <div class="grid-2 mb">
        <div class="card">
          <div class="card-title">Today at a Glance</div>
          <div class="stat-row">
            <div class="stat-item"><div class="stat-value" id="todayHrs">0m</div><div class="stat-label">Today</div></div>
            <div class="stat-div"></div>
            <div class="stat-item"><div class="stat-value" id="todaySess">0</div><div class="stat-label">Sessions</div></div>
            <div class="stat-div"></div>
            <div class="stat-item"><div class="stat-value" id="weekHrs">0h</div><div class="stat-label">This Week</div></div>
            <div class="stat-div"></div>
            <div class="stat-item"><div class="stat-value" id="prodMin">0m</div><div class="stat-label">Productive</div></div>
          </div>
          <div class="card-title" style="margin-top:6px">Due in 48h</div>
          <div id="due48List"></div>
        </div>
        <div class="card">
          <div class="card-title">Daily Goal Progress</div>
          <div class="ring-row">
            <div class="ring-wrap">
              <svg width="90" height="90">
                <circle cx="45" cy="45" r="38" fill="none" stroke="var(--bg4)" stroke-width="6"/>
                <circle id="ringCircle" cx="45" cy="45" r="38" fill="none" stroke="var(--accent)" stroke-width="6" stroke-dasharray="238.76" stroke-dashoffset="238.76" transform="rotate(-90 45 45)" style="transition:stroke-dashoffset .6s ease"/>
              </svg>
              <div class="ring-label"><span class="ring-pct" id="ringPct">0%</span><span class="ring-sub">of goal</span></div>
            </div>
            <div style="flex:1">
              <div class="goal-item"><div class="goal-hd"><span class="goal-name">Daily</span><span class="goal-txt" id="dailyGT">0/120m</span></div><div class="goal-bar"><div class="goal-fill" id="dailyGB" style="width:0%;background:var(--accent)"></div></div></div>
              <div class="goal-item"><div class="goal-hd"><span class="goal-name">Weekly</span><span class="goal-txt" id="weeklyGT">0/600m</span></div><div class="goal-bar"><div class="goal-fill" id="weeklyGB" style="width:0%;background:var(--blue)"></div></div></div>
              <div class="goal-item"><div class="goal-hd"><span class="goal-name">Tasks</span><span class="goal-txt" id="taskGT">0/0</span></div><div class="goal-bar"><div class="goal-fill" id="taskGB" style="width:0%;background:var(--green)"></div></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="review-card mb" id="weeklyReview"></div>

      <div class="card mb">
        <div class="card-title">Quick Add Task</div>
        <div style="display:flex;gap:7px;margin-bottom:7px;flex-wrap:wrap">
          <input type="text" class="inp" id="qaInput" placeholder="Taskâ€¦ (Enter to add)" onkeypress="if(event.key==='Enter')qaAdd()" style="flex:1;min-width:160px">
          <select class="inp" id="qaPri" style="max-width:90px;cursor:pointer"><option value="medium">Med</option><option value="high">High</option><option value="low">Low</option></select>
          <select class="inp" id="qaSubj" style="max-width:130px;cursor:pointer"><option value="">Subjectâ€¦</option></select>
          <button class="btn btn-primary btn-sm" onclick="qaAdd()">+ Add</button>
        </div>
        <div id="dashTaskList" class="task-list"></div>
      </div>
    </section>

    <!-- STUDY LOG -->
    <section class="page-section fade-in" id="page-log">
      <div class="card mb">
        <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
          Session History â€” click row to expand
          <div style="display:flex;gap:7px">
            <button class="btn btn-ghost btn-sm" onclick="openModal('manualModal')">+ Manual</button>
            <button class="btn btn-ghost btn-sm" onclick="exportCSV()">Export CSV</button>
          </div>
        </div>
        <div class="log-wrap">
          <table class="log-table">
            <thead><tr><th>Date</th><th>Subject</th><th>Topic</th><th>Type</th><th>Duration</th><th>Focus</th><th>Energy</th><th>Productive</th></tr></thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TASKS -->
    <section class="page-section fade-in" id="page-tasks">
      <div class="grid-2">
        <div>
          <div class="card mb">
            <div class="card-title">Add Task</div>
            <div class="form-group"><input type="text" class="inp" id="t_text" placeholder="Task descriptionâ€¦"></div>
            <div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:10px">
              <select class="inp" id="t_pri" style="flex:1;cursor:pointer"><option value="medium">Medium</option><option value="high">High</option><option value="low">Low</option></select>
              <select class="inp" id="t_subj" style="flex:1;cursor:pointer"><option value="">Subjectâ€¦</option></select>
              <input type="date" class="inp" id="t_due" style="flex:1">
            </div>
            <button class="btn btn-primary" onclick="addTaskFull()">+ Add Task</button>
          </div>
        </div>
        <div>
          <div class="card mb">
            <div class="card-title" style="display:flex;justify-content:space-between"><span>Pending</span><span id="pendCnt" style="font-family:var(--font-mono);font-size:10px;color:var(--text3)">0</span></div>
            <div id="allTasksList" class="task-list"></div>
          </div>
          <div class="card"><div class="card-title">âœ“ Completed</div><div id="doneTasksList" class="task-list"></div></div>
        </div>
      </div>
    </section>

    <!-- NOTES -->
    <section class="page-section fade-in" id="page-notes">
      <div class="grid-2">
        <div>
          <div class="card mb">
            <div class="card-title">New Note</div>
            <div class="form-group"><input type="text" class="inp" id="note_title" placeholder="Titleâ€¦"></div>
            <div class="form-group"><select class="inp" id="note_subj" style="cursor:pointer"><option value="">Subject (optional)</option></select></div>
            <div class="note-toolbar">
              <button class="note-tool" onclick="noteFmt('bold')"><b>B</b></button>
              <button class="note-tool" onclick="noteFmt('italic')"><i>I</i></button>
              <button class="note-tool" onclick="noteFmt('insertUnorderedList')">â€¢</button>
              <button class="note-tool" onclick="noteFmt('insertOrderedList')">1.</button>
              <button class="note-tool" onclick="noteFmt('h2')">H</button>
              <span style="flex:1"></span>
              <button class="note-tool" onclick="clearNoteEditor()" style="color:var(--red)">Clear</button>
            </div>
            <div class="note-area" id="noteEditor" contenteditable="true"></div>
            <div style="display:flex;gap:7px;margin-top:8px">
              <input type="text" class="inp" id="noteTagInput" placeholder="Add tagâ€¦" onkeypress="if(event.key==='Enter')addNoteTag()" style="flex:1">
              <button class="btn btn-ghost btn-sm" onclick="addNoteTag()">+ Tag</button>
            </div>
            <div class="note-tags" id="noteTagsDisplay"></div>
            <button class="btn btn-primary" style="margin-top:10px;width:100%" onclick="saveNote()">Save Note</button>
          </div>
        </div>
        <div>
          <div class="card">
            <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
              Saved Notes
              <input type="text" class="inp" id="noteSearch" placeholder="Searchâ€¦" style="max-width:150px;font-size:11px;padding:4px 8px" oninput="renderNotes()">
            </div>
            <div id="notesList"></div>
          </div>
        </div>
      </div>
      <div id="noteViewer" style="display:none;margin-top:12px" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="card-title" id="noteViewTitle" style="margin-bottom:0">Note</div>
          <div style="display:flex;gap:7px">
            <button class="btn btn-ghost btn-sm" onclick="editNote()">Edit</button>
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('noteViewer').style.display='none'">âœ•</button>
          </div>
        </div>
        <div id="noteViewBody" style="font-size:13.5px;line-height:1.7;color:var(--text2)"></div>
        <div class="note-tags" id="noteViewTags" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section class="page-section fade-in" id="page-analytics">
      <div class="grid-2 mb">
        <div class="card"><div class="card-title">Productive Minutes â€” 7 Days</div><div class="chart-wrap"><canvas id="wChart"></canvas></div></div>
        <div class="card"><div class="card-title">Subject Distribution</div><div class="chart-wrap" style="max-height:210px"><canvas id="pChart"></canvas></div></div>
      </div>
      <div class="grid-2 mb">
        <div class="card"><div class="card-title">Focus & Energy Trend</div><div class="chart-wrap"><canvas id="fChart"></canvas></div></div>
        <div class="card"><div class="card-title">Session Type Breakdown</div><div class="chart-wrap"><canvas id="tChart"></canvas></div></div>
      </div>
      <div class="card mb"><div class="card-title">Daily Report Explorer</div><div id="dailyReport"></div></div>
    </section>

    <!-- HEATMAP -->
    <section class="page-section fade-in" id="page-heatmap">
      <div class="card mb">
        <div class="card-title">Consistency Calendar â€” Last 52 Weeks</div>
        <div style="overflow-x:auto">
          <div style="display:flex;gap:2px">
            <div><div style="height:14px"></div><div id="hmDays" style="display:flex;flex-direction:column;gap:3px;margin-right:6px"></div></div>
            <div style="flex:1;overflow-x:auto"><div class="heatmap" id="heatmap"></div></div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;margin-top:10px;font-family:var(--font-mono);font-size:9px;color:var(--text3)">
            Less <div style="width:12px;height:12px;border-radius:2px;background:var(--bg4)"></div>
            <div class="hm-cell l1" style="width:12px;height:12px"></div>
            <div class="hm-cell l2" style="width:12px;height:12px"></div>
            <div class="hm-cell l3" style="width:12px;height:12px"></div>
            <div class="hm-cell l4" style="width:12px;height:12px"></div> More
          </div>
        </div>
      </div>
      <div class="grid-3">
        <div class="card"><div class="card-title">Best Study Day</div><div id="bestDay" style="font-family:var(--font-mono);font-size:16px;color:var(--accent)">â€”</div></div>
        <div class="card"><div class="card-title">Longest Streak</div><div id="longestStreak" style="font-family:var(--font-mono);font-size:22px;color:var(--accent)">0 days</div></div>
        <div class="card"><div class="card-title">Active Weeks</div><div id="activeWeeks" style="font-family:var(--font-mono);font-size:22px;color:var(--accent)">0</div></div>
      </div>
    </section>

    <!-- BADGES -->
    <section class="page-section fade-in" id="page-badges">
      <div class="card mb"><div class="card-title">Achievement Badges</div><div class="badges-grid" id="badgesGrid"></div></div>
    </section>

    <!-- SUBJECTS -->
    <section class="page-section fade-in" id="page-subjects">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <span style="color:var(--text2);font-size:13px">Track time per subject</span>
        <button class="btn btn-primary btn-sm" onclick="openModal('addSubjectModal')">+ Add Subject</button>
      </div>
      <div class="grid-auto" id="subjectCards"></div>
    </section>

    <!-- PLANNER -->
    <section class="page-section fade-in" id="page-planner">
      <div class="grid-2 mb">
        <div class="card"><div class="card-title" style="display:flex;justify-content:space-between;align-items:center">Exam Countdowns<button class="btn btn-ghost btn-sm" onclick="openModal('addExamModal')">+ Add</button></div><div id="examList"></div></div>
        <div class="card"><div class="card-title">This Week</div><div id="weekPlanner"></div></div>
      </div>
      <div class="card"><div class="card-title">Tasks by Due Date</div><div id="plannerTasks" class="task-list"></div></div>
    </section>

    <!-- GOALS -->
    <section class="page-section fade-in" id="page-goals">
      <div class="grid-2 mb">
        <div class="card">
          <div class="card-title">Set Goals</div>
          <div class="form-group"><label class="form-label">Daily Goal (min)</label><input type="number" class="inp" id="g_daily" placeholder="120"></div>
          <div class="form-group"><label class="form-label">Weekly Goal (min)</label><input type="number" class="inp" id="g_weekly" placeholder="600"></div>
          <button class="btn btn-primary" onclick="saveGoals()">Save Goals</button>
        </div>
        <div class="card"><div class="card-title">Summary</div><div id="goalsSummary"></div></div>
      </div>
    </section>

    <!-- FOCUS TOOLS -->
    <section class="page-section fade-in" id="page-focus">
      <div class="grid-2 mb">
        <div class="card">
          <div class="card-title">Ambient Sounds</div>
          <div class="sound-btns mb">
            <button class="sound-btn" onclick="toggleSound('rain',this)">ğŸŒ§ Rain</button>
            <button class="sound-btn" onclick="toggleSound('cafe',this)">â˜• CafÃ©</button>
            <button class="sound-btn" onclick="toggleSound('forest',this)">ğŸŒ² Forest</button>
            <button class="sound-btn" onclick="toggleSound('fire',this)">ğŸ”¥ Fire</button>
            <button class="sound-btn" onclick="toggleSound('ocean',this)">ğŸŒŠ Ocean</button>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:11px;color:var(--text2)">Volume</span>
            <input type="range" id="volSlider" min="0" max="1" step="0.05" value="0.3" style="flex:1;accent-color:var(--accent)" oninput="setVol(this.value)">
          </div>
        </div>
        <div class="card">
          <div class="card-title">Zen Mode</div>
          <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Hide everything except the timer.</p>
          <button class="btn btn-primary" onclick="toggleZen()">ğŸ§˜ Enter Zen Mode</button>
          <p style="font-size:11px;color:var(--text3);margin-top:8px"><kbd>Z</kbd> â€” Exit with Escape</p>
        </div>
      </div>
      <div class="card mb">
        <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">Quick Links<button class="btn btn-ghost btn-sm" onclick="openModal('addLinkModal')">+ Add</button></div>
        <div id="linksList"></div>
      </div>
      <div class="card">
        <div class="card-title">Lo-Fi / YouTube Embed</div>
        <div style="display:flex;gap:7px;margin-bottom:10px">
          <input type="url" class="inp" id="embedUrl" placeholder="https://www.youtube.com/embed/â€¦">
          <button class="btn btn-primary btn-sm" onclick="loadEmbed()">Load</button>
          <button class="btn btn-ghost btn-sm" onclick="clearEmbed()">Clear</button>
        </div>
        <div id="embedBox"></div>
      </div>
    </section>

    <!-- MY PROFILE -->
    <section class="page-section fade-in" id="page-profile">
      <div class="profile-banner mb">
        <div class="profile-avatar-lg" id="profileAvatarLg">?</div>
        <div class="profile-display-name" id="profileDisplayName">â€”</div>
        <div class="profile-handle" id="profileHandle">â€”</div>

        <div class="profile-currently mb" id="profileCurrently">
          <div class="live-dot"></div>
          <div>
            <div class="currently-text" id="currentlyText">Not currently studying</div>
            <div class="currently-sub" id="currentlySub">Start a timer session to go live</div>
          </div>
        </div>

        <div class="pub-stats" id="pubStats"></div>

        <button class="share-btn" onclick="showPubProfile()">ğŸŒ View & Share Public Profile</button>

        <div class="privacy-notice">
          Your profile visibility:
          <div class="privacy-row">
            <div class="privacy-item"><div class="privacy-dot pub"></div><span style="color:var(--green)">Public:</span> Current subject, streak, weekly hours, subject split</div>
            <div class="privacy-item"><div class="privacy-dot priv"></div><span style="color:var(--red)">Private:</span> Sessions, tasks, notes, goals, settings</div>
          </div>
        </div>
      </div>
    </section>

    <!-- STUDY LOUNGE -->
    <section class="page-section fade-in" id="page-lounge">
      <div id="firebaseSetupBanner" style="display:none" class="firebase-setup-banner">
        âš  Firebase not configured yet. Open <code>firebase-config.js</code> and paste your Firebase project keys to enable real-time chat.
        <a href="https://console.firebase.google.com" target="_blank" rel="noopener" style="color:var(--accent);margin-left:6px">Open Firebase Console â†’</a>
      </div>
      <div class="lounge-layout">
        <!-- CHAT -->
        <div class="chat-panel">
          <div class="chat-header">
            <div class="chat-header-title">
              ğŸ’¬ Study Lounge
              <span class="online-count" id="onlineCount">0 online</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
              <select id="chatFilter" class="meta-select" style="font-size:10px;padding:3px 7px" onchange="applyFilter()">
                <option value="all">All messages</option>
                <option value="studying">Studying now</option>
              </select>
              <button class="btn-icon" onclick="scrollChatBottom()" title="Scroll to bottom" style="font-size:11px;padding:4px 7px">â†“</button>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div class="chat-loading" id="chatLoading">
              <div class="gate-loader"></div>
              <span>Connecting to Study Loungeâ€¦</span>
            </div>
          </div>

          <!-- Typing / banned indicator -->
          <div id="bannedNotice" style="display:none;padding:8px 14px;background:rgba(232,104,104,.08);border-top:1px solid var(--border);font-size:12px;color:var(--red);font-family:var(--font-mono)">
            ğŸš« You have been banned from the Study Lounge.
          </div>

          <div class="chat-input-area" id="chatInputArea">
            <textarea class="chat-input" id="chatInput" placeholder="Message the Study Loungeâ€¦" rows="1"
              onkeydown="chatKeydown(event)" oninput="autoResize(this)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
          </div>
        </div>

        <!-- SIDEBAR PANELS -->
        <div class="lounge-sidebar">
          <!-- Who's studying now -->
          <div class="lounge-card">
            <div class="card-title" style="display:flex;align-items:center;gap:7px">
              <span>ğŸŸ¢ Studying Now</span>
            </div>
            <div id="onlineUsersList">
              <div style="font-size:11px;color:var(--text3);font-family:var(--font-mono)">No one online yet</div>
            </div>
          </div>

          <!-- Weekly Leaderboard -->
          <div class="lounge-card">
            <div class="card-title">ğŸ† This Week's Top</div>
            <div id="leaderboard">
              <div style="font-size:11px;color:var(--text3);font-family:var(--font-mono)">Loadingâ€¦</div>
            </div>
          </div>

          <!-- Your quick stats for the lounge -->
          <div class="lounge-card">
            <div class="card-title">ğŸ“Š Your Stats</div>
            <div id="loungeMyStats" style="font-size:13px;color:var(--text2);line-height:2"></div>
          </div>

          <!-- Admin panel (only visible to admins) -->
          <div class="lounge-card" id="adminPanel" style="display:none">
            <div class="card-title" style="color:var(--red)">ğŸ›¡ Admin</div>
            <div style="font-size:11px;color:var(--text3);margin-bottom:8px;font-family:var(--font-mono)">Ban a user by email:</div>
            <div style="display:flex;gap:6px">
              <input type="email" class="inp" id="banEmailInput" placeholder="user@email.com" style="font-size:11px;padding:5px 8px">
              <button class="btn btn-ghost btn-sm" onclick="adminBanUser()" style="color:var(--red);border-color:var(--red);white-space:nowrap">Ban</button>
            </div>
            <div style="margin-top:8px">
              <button class="btn btn-ghost btn-sm" onclick="adminClearChat()" style="color:var(--red);border-color:var(--red);width:100%">ğŸ—‘ Clear All Messages</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="page-section fade-in" id="page-settings">
      <div class="grid-2 mb">
        <div class="card">
          <div class="card-title">Timer Settings</div>
          <div class="form-group"><label class="form-label">Custom Focus (min)</label><input type="number" class="inp" id="s_focus" value="45"></div>
          <div class="form-group"><label class="form-label">Custom Break (min)</label><input type="number" class="inp" id="s_break" value="10"></div>
          <button class="btn btn-primary" onclick="saveSettings()">Save</button>
        </div>
        <div class="card">
          <div class="card-title">Appearance</div>
          <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
            <button class="btn btn-secondary" onclick="setTheme('dark')">ğŸŒ‘ Dark</button>
            <button class="btn btn-secondary" onclick="setTheme('dim')">ğŸŒ˜ Dim</button>
            <button class="btn btn-secondary" onclick="setTheme('light')">â˜€ Light</button>
          </div>
          <div class="card-title">Keyboard Shortcuts</div>
          <div style="font-family:var(--font-mono);font-size:11px;color:var(--text2);line-height:2.2">
            <div><kbd>Space</kbd> â€” Start / Pause</div>
            <div><kbd>S</kbd> â€” Stop</div>
            <div><kbd>Z</kbd> â€” Zen Mode</div>
            <div><kbd>M</kbd> â€” Manual Log</div>
            <div><kbd>?</kbd> â€” Toggle HUD</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Data</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-secondary" onclick="exportCSV()">â†“ Export CSV</button>
          <button class="btn btn-secondary" onclick="exportJSON()">â†“ Export JSON</button>
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">â†‘ Import JSON</button>
          <button class="btn btn-ghost" onclick="clearAll()" style="color:var(--red);border-color:var(--red)">ğŸ—‘ Clear All Data</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
        <div style="margin-top:14px">
          <button class="btn btn-ghost" onclick="signOut()" style="color:var(--text2)">â¬¡ Sign Out</button>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL VARIABLES â€” declared first to prevent
   ReferenceError from onclick handlers in HTML
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var currentUser = null;
var storageKey = '';
var state = null;
var crashData = null;
var firebaseReady = false;
var db = null;
var mutedUsers = [];
var unreadCount = 0;
var loungeVisible = false;
var presenceRef = null;
var messagesRef = null;
var onlineRef = null;
var leaderboardRef = null;
var chatFilter = 'all';
var lastMsgTimestamp = 0;
var charts = {};
var noteTags = [];
var editingNoteId = null;
var pickedColor = '#e8a832';
var audioCtx = null;
var activeSounds = {};
var soundVol = 0.3;
var kbdVisible = false;
var themes = ['dark','dim','light'];
var themeIdx = 0;
var quoteIdx = 0;
var mlFocusRating = 3;
var pendS = { focusRating:3, energyRating:3 };
var tmr = { mode:'p25', phase:'focus', running:false, paused:false, elapsed:0, total:25*60, interval:null, sessionStart:null, pomoCount:0 };
var PAGE_TITLES = {
  dashboard:'Dashboard', log:'Study Log', tasks:'Tasks', notes:'Notes',
  analytics:'Analytics', heatmap:'Calendar', badges:'Badges', subjects:'Subjects',
  planner:'Planner', goals:'Goals', focus:'Focus Tools', profile:'My Profile',
  lounge:'Study Lounge', settings:'Settings'
};
var MODES = { p25:{focus:25,brk:5}, p50:{focus:50,brk:10} };
var REACTIONS = ['ğŸ‘','ğŸ”¥','ğŸ’ª','ğŸ§ ','â¤ï¸','ğŸ˜‚'];
var MAX_MSG_LENGTH = 400;
var QUOTES = [
  "The secret of getting ahead is getting started.",
  "Focus on being productive instead of busy.",
  "One step at a time is all it takes.",
  "The beautiful thing about learning is that no one can take it away from you.",
  "An investment in knowledge pays the best interest.",
  "Push yourself, because no one else is going to do it for you.",
  "Great things never come from comfort zones.",
  "Dream it. Wish it. Do it.",
  "Study hard, for the well is deep and our brains are shallow.",
  "Consistency is the key to mastery."
];
var BADGES = [
  {id:'first_session',icon:'ğŸ¯',name:'First Step',desc:'Complete 1 session'},
  {id:'ten_sessions',icon:'ğŸ”Ÿ',name:'Ten Deep',desc:'Complete 10 sessions'},
  {id:'fifty_sessions',icon:'ğŸ’¯',name:'Half Century',desc:'Complete 50 sessions'},
  {id:'one_hour',icon:'â°',name:'One Hour',desc:'Study 1 hour total'},
  {id:'ten_hours',icon:'ğŸ“š',name:'10 Hours',desc:'Study 10 hours total'},
  {id:'fifty_hours',icon:'ğŸ›',name:'Scholar',desc:'Study 50 hours total'},
  {id:'streak_3',icon:'ğŸ”¥',name:'On Fire',desc:'3-day streak'},
  {id:'streak_7',icon:'âš¡',name:'Weekly Warrior',desc:'7-day streak'},
  {id:'streak_30',icon:'ğŸŒŸ',name:'Monthly Master',desc:'30-day streak'},
  {id:'night_owl',icon:'ğŸ¦‰',name:'Night Owl',desc:'Study after 10pm'},
  {id:'early_bird',icon:'ğŸŒ…',name:'Early Bird',desc:'Study before 7am'},
  {id:'five_subjects',icon:'ğŸ§ ',name:'Polymath',desc:'Study 5+ subjects'},
  {id:'perfect_focus',icon:'ğŸ’',name:'Perfect Focus',desc:'Rate 5/5 focus'},
  {id:'task_master',icon:'âœ…',name:'Task Master',desc:'Complete 20 tasks'},
  {id:'all_types',icon:'ğŸ¨',name:'Versatile',desc:'Use all session types'},
  {id:'note_taker',icon:'ğŸ“',name:'Note Taker',desc:'Save 5 notes'},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH & USER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

var netlifyIdentity = window.netlifyIdentity;

netlifyIdentity.on('init', user => {
  if (!user) {
    // Not logged in â€” redirect to login page
    window.location.href = '/index.html';
  } else {
    currentUser = user;
    storageKey = 'focus_v4_' + btoa(user.email).replace(/=/g,'');
    initApp();
  }
});

netlifyIdentity.on('logout', () => {
  window.location.href = '/index.html';
});

netlifyIdentity.init();

function signOut() {
  if (confirm('Sign out?')) netlifyIdentity.logout();
}

function getUserInitials(name, email) {
  if (name && name.trim()) {
    const parts = name.trim().split(' ');
    return parts.length >= 2 ? (parts[0][0] + parts[1][0]).toUpperCase() : parts[0][0].toUpperCase();
  }
  return email ? email[0].toUpperCase() : '?';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE â€” keyed by user
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */


function blankState() {
  return {
    sessions:[], tasks:[], subjects:[], exams:[], links:[], notes:[],
    goals:{daily:120, weekly:600},
    settings:{customFocus:45, customBreak:10},
    streak:0, lastStudyDate:null, earnedBadges:[],
    // Public profile fields
    displayName:'', currentSubject:'', currentTopic:''
  };
}

function loadState() {
  try {
    const raw = localStorage.getItem(storageKey);
    if (raw) state = JSON.parse(raw);
    else state = blankState();
    // Ensure all keys exist (upgrades)
    const blank = blankState();
    Object.keys(blank).forEach(k => { if (state[k] === undefined) state[k] = blank[k]; });
  } catch(e) { state = blankState(); }
}

function saveState() {
  try { localStorage.setItem(storageKey, JSON.stringify(state)); } catch(e) {}
  // Update live public data (safe subset only)
  updatePublicData();
}

// Public data is stored under a separate key with ONLY public info
// This key uses a hash of the email so it's not directly guessable
function publicKey() { return 'focus_pub_' + btoa(currentUser.email).replace(/=/g,''); }

function updatePublicData() {
  const now = new Date();
  const dow = (now.getDay()+6)%7;
  const wStart = new Date(now); wStart.setDate(now.getDate()-dow); wStart.setHours(0,0,0,0);
  const weekMins = state.sessions.filter(s=>new Date(s.date)>=wStart).reduce((a,s)=>a+s.durationMinutes,0);
  const subTotals = {};
  state.sessions.forEach(s=>{subTotals[s.subject||'General']=(subTotals[s.subject||'General']||0)+s.durationMinutes;});
  const pub = {
    displayName: state.displayName || currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
    email: currentUser.email,
    streak: state.streak || 0,
    weeklyMinutes: weekMins,
    totalSessions: state.sessions.length,
    topSubjects: Object.entries(subTotals).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([s,m])=>({subject:s,minutes:m})),
    currentSubject: state.currentSubject || '',
    currentTopic: state.currentTopic || '',
    lastActive: now.toISOString()
  };
  try { localStorage.setItem(publicKey(), JSON.stringify(pub)); } catch(e) {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CRASH RECOVERY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var crashData = null;
function crashKey() { return 'focus_crash_' + storageKey; }

function saveCrash() {
  if (!tmr.running) return;
  localStorage.setItem(crashKey(), JSON.stringify({
    subject: document.getElementById('curSubject').value,
    topic: document.getElementById('curTopic').value,
    type: document.getElementById('curType').value,
    startTime: tmr.sessionStart ? tmr.sessionStart.toISOString() : new Date().toISOString(),
    elapsed: tmr.elapsed
  }));
}

function checkCrash() {
  const raw = localStorage.getItem(crashKey());
  if (!raw) return;
  try { crashData = JSON.parse(raw); document.getElementById('recoveryBanner').style.display='flex'; } catch(e){}
}

function restoreCrash() {
  if (!crashData) return;
  const mins = Math.floor(crashData.elapsed/60);
  if (mins < 1) { dismissCrash(); return; }
  pendS = { focusRating:3, energyRating:3, durationMinutes:mins, subject:crashData.subject, topic:crashData.topic, type:crashData.type, startTime:crashData.startTime };
  document.getElementById('sm_subject').value = crashData.subject||'';
  document.getElementById('sm_topic').value = crashData.topic||'';
  openModal('sessionModal'); dismissCrash();
}

function dismissCrash() { localStorage.removeItem(crashKey()); document.getElementById('recoveryBanner').style.display='none'; crashData=null; }

setInterval(saveCrash, 30000);
window.addEventListener('beforeunload', saveCrash);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */


var mlFocusRating = 3;


function setMode(mode, btn) {
  if (tmr.running) return;
  tmr.mode=mode; tmr.phase='focus'; tmr.elapsed=0;
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const mins = mode==='sw' ? 0 : mode==='custom' ? (state.settings.customFocus||45) : MODES[mode].focus;
  tmr.total = mode==='sw' ? Infinity : mins*60;
  updDisp(0); setPhaseLabel(mode==='sw'?'STOPWATCH':'FOCUS'); updBar(); renderPomoDots();
}

function setPhaseLabel(t) { document.getElementById('timerPhase').textContent=t; document.getElementById('zenPhase').textContent=t; }

function updDisp(e) {
  const rem = tmr.total===Infinity ? e : Math.max(0,tmr.total-e);
  const t = `${String(Math.floor(rem/60)).padStart(2,'0')}:${String(rem%60).padStart(2,'0')}`;
  document.getElementById('timerDisp').textContent=t;
  document.getElementById('zenTimer').textContent=t;
}

function updBar() {
  const pct = tmr.total===Infinity ? 100 : Math.max(0,100*(1-tmr.elapsed/tmr.total));
  document.getElementById('timerBar').style.width=pct+'%';
  document.getElementById('zenBar').style.width=pct+'%';
}

function renderPomoDots() {
  const el=document.getElementById('pomoDots');
  if (tmr.mode==='sw'||tmr.mode==='custom') { el.innerHTML=''; return; }
  el.innerHTML=Array.from({length:4},(_,i)=>{
    let c='pomo-dot';
    if(i<tmr.pomoCount) c+=' done';
    else if(i===tmr.pomoCount&&tmr.phase==='focus') c+=' current';
    return `<div class="${c}"></div>`;
  }).join('');
}

function toggleTimer() {
  if (!tmr.running) {
    tmr.running=true; tmr.paused=false; tmr.sessionStart=new Date();
    document.getElementById('startBtn').textContent='â¸ Pause';
    document.getElementById('zenIcon').textContent='â¸'; document.getElementById('zenLbl').textContent='Pause';
    document.getElementById('timerDisp').classList.add('running');
    tmr.interval=setInterval(tick,1000);
    // Update live status
    state.currentSubject=document.getElementById('curSubject').value;
    state.currentTopic=document.getElementById('curTopic').value;
    updatePublicData();
    if(window._updatePresence) window._updatePresence();
  } else if (!tmr.paused) {
    tmr.paused=true; clearInterval(tmr.interval); tmr.interval=null;
    document.getElementById('startBtn').textContent='â–¶ Resume';
    document.getElementById('zenIcon').textContent='â–¶'; document.getElementById('zenLbl').textContent='Resume';
    document.getElementById('timerDisp').classList.remove('running');
    document.getElementById('timerDisp').classList.add('paused');
  } else {
    tmr.paused=false;
    document.getElementById('startBtn').textContent='â¸ Pause';
    document.getElementById('zenIcon').textContent='â¸'; document.getElementById('zenLbl').textContent='Pause';
    document.getElementById('timerDisp').classList.remove('paused');
    document.getElementById('timerDisp').classList.add('running');
    tmr.interval=setInterval(tick,1000);
  }
}

function tick() {
  tmr.elapsed++; updDisp(tmr.elapsed); updBar();
  if (tmr.total!==Infinity&&tmr.elapsed>=tmr.total) phaseComplete();
}

function stopTimer() {
  if (!tmr.running&&tmr.elapsed===0) return;
  clearInterval(tmr.interval); tmr.interval=null;
  const mins=Math.floor(tmr.elapsed/60);
  if (tmr.phase==='focus'&&mins>=1) promptSession(mins);
  resetTimer();
  // Clear live status
  state.currentSubject=''; state.currentTopic=''; updatePublicData();
  if(window._updatePresence) window._updatePresence();
}

function skipPhase() { stopTimer(); }

function resetTimer() {
  tmr.running=false; tmr.paused=false; tmr.elapsed=0; tmr.phase='focus';
  document.getElementById('startBtn').textContent='â–¶ Start';
  document.getElementById('zenIcon').textContent='â–¶'; document.getElementById('zenLbl').textContent='Start';
  document.getElementById('timerDisp').classList.remove('running','paused');
  setPhaseLabel('FOCUS'); setMode(tmr.mode,null);
}

function phaseComplete() {
  clearInterval(tmr.interval); tmr.interval=null; tmr.running=false; tmr.paused=false; beep();
  if (tmr.phase==='focus') {
    const mins=Math.floor(tmr.elapsed/60);
    if(mins>=1) promptSession(mins);
    tmr.pomoCount=Math.min(4,tmr.pomoCount+1); tmr.phase='break';
    setPhaseLabel('BREAK');
    const brkMins=tmr.mode==='custom'?(state.settings.customBreak||10):(MODES[tmr.mode]?.brk||5);
    tmr.total=brkMins*60;
    notify(`Focus done! ${brkMins}m break ğŸ‰`,'success');
  } else {
    tmr.phase='focus'; setPhaseLabel('FOCUS');
    const fMins=tmr.mode==='custom'?(state.settings.customFocus||45):(MODES[tmr.mode]?.focus||25);
    tmr.total=fMins*60;
    notify('Break over! Time to focus ğŸ’ª','info');
    if(tmr.pomoCount>=4){tmr.pomoCount=0;notify('ğŸ… 4 Pomodoros complete!','success');}
  }
  tmr.elapsed=0;
  document.getElementById('startBtn').textContent='â–¶ Start';
  document.getElementById('zenIcon').textContent='â–¶'; document.getElementById('zenLbl').textContent='Start';
  document.getElementById('timerDisp').classList.remove('running','paused');
  updDisp(0); updBar(); renderPomoDots();
  localStorage.removeItem(crashKey());
}

function promptSession(mins) {
  pendS = { focusRating:3, energyRating:3, durationMinutes:mins,
    subject:document.getElementById('curSubject').value,
    topic:document.getElementById('curTopic').value,
    type:document.getElementById('curType').value||'General',
    startTime:tmr.sessionStart?tmr.sessionStart.toISOString():new Date().toISOString() };
  document.getElementById('sm_subject').value=pendS.subject||'';
  document.getElementById('sm_topic').value=pendS.topic||'';
  document.getElementById('sm_type').value=pendS.type||'General';
  // Reset ratings UI
  ['sm_focus','sm_energy'].forEach(id=>document.querySelectorAll(`#${id} .r-btn`).forEach((b,i)=>b.classList.toggle('sel',i===2)));
  openModal('sessionModal');
}

function rate(type,val) {
  if(type==='focus'){pendS.focusRating=val;document.querySelectorAll('#sm_focus .r-btn').forEach((b,i)=>b.classList.toggle('sel',i+1===val));}
  else{pendS.energyRating=val;document.querySelectorAll('#sm_energy .r-btn').forEach((b,i)=>b.classList.toggle('sel',i+1===val));}
}

function rateML(val) { mlFocusRating=val; document.querySelectorAll('#ml_focus .r-btn').forEach((b,i)=>b.classList.toggle('sel',i+1===val)); }

function saveSession(skip) {
  const s = {
    id:Date.now(),
    date:new Date().toISOString().split('T')[0],
    startTime:pendS.startTime||new Date().toISOString(),
    durationMinutes:pendS.durationMinutes||0,
    subject:document.getElementById('sm_subject').value||pendS.subject||'General',
    topic:document.getElementById('sm_topic').value||pendS.topic||'',
    type:document.getElementById('sm_type').value||'General',
    focusRating:pendS.focusRating||3,
    energyRating:pendS.energyRating||3,
    notes:document.getElementById('sm_notes').value||'',
    hour:new Date().getHours()
  };
  s.productiveMinutes=Math.round(s.durationMinutes*s.focusRating/5);
  state.sessions.push(s); updateStreak(); saveState(); checkBadges();
  closeModal('sessionModal');
  document.getElementById('sm_notes').value='';
  pendS={focusRating:3,energyRating:3};
  refreshAll(); localStorage.removeItem(crashKey());
  notify(`Session logged! ${s.durationMinutes}m ğŸ“š`,'success');
  if(firebaseReady) pushLeaderboardEntry();
}

function saveManualSession() {
  const date=document.getElementById('ml_date').value||new Date().toISOString().split('T')[0];
  const duration=parseInt(document.getElementById('ml_duration').value)||0;
  if(duration<1){notify('Enter a duration!','info');return;}
  const s={id:Date.now(),date,startTime:date+'T00:00:00.000Z',durationMinutes:duration,
    subject:document.getElementById('ml_subject').value||'General',
    topic:document.getElementById('ml_topic').value||'',
    type:document.getElementById('ml_type').value||'General',
    focusRating:mlFocusRating||3,energyRating:3,
    notes:document.getElementById('ml_notes').value||'',hour:12,manual:true};
  s.productiveMinutes=Math.round(duration*s.focusRating/5);
  state.sessions.push(s); updateStreak(); saveState(); checkBadges();
  closeModal('manualModal'); refreshAll();
  notify(`Manual session added! ${duration}m`,'success');
}

/* â”€â”€â”€ STREAK â”€â”€â”€ */
function updateStreak() {
  const today=new Date().toISOString().split('T')[0];
  if(!state.sessions.some(s=>s.date===today)) return;
  if(!state.lastStudyDate){state.streak=1;}
  else{const diff=Math.floor((new Date(today)-new Date(state.lastStudyDate))/86400000);if(diff===1)state.streak++;else if(diff>1)state.streak=1;}
  state.lastStudyDate=today;
  document.getElementById('streakNum').textContent=state.streak;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function qaAdd(){const txt=document.getElementById('qaInput').value.trim();if(!txt)return;addTask(txt,document.getElementById('qaPri').value,document.getElementById('qaSubj').value,'');document.getElementById('qaInput').value='';}
function addTaskFull(){const txt=document.getElementById('t_text').value.trim();if(!txt)return;addTask(txt,document.getElementById('t_pri').value,document.getElementById('t_subj').value,document.getElementById('t_due').value);document.getElementById('t_text').value='';}
function addTask(text,priority='medium',subject='',dueDate=''){state.tasks.unshift({id:Date.now(),text,priority,subject,dueDate,done:false,createdAt:new Date().toISOString()});saveState();refreshTasks();notify('Task added!','info');}
function toggleTask(id){const t=state.tasks.find(t=>t.id===id);if(!t)return;t.done=!t.done;if(t.done)t.doneAt=new Date().toISOString();saveState();refreshTasks();checkBadges();}
function deleteTask(id){state.tasks=state.tasks.filter(t=>t.id!==id);saveState();refreshTasks();}

function makeTaskEl(task){
  const el=document.createElement('div');el.className='task-item'+(task.done?' done':'');
  el.innerHTML=`<div class="task-check ${task.done?'checked':''}" onclick="toggleTask(${task.id})"></div>
    <div class="pdot ${task.priority}"></div>
    <div style="flex:1"><div class="task-text">${esc(task.text)}</div>${task.subject||task.dueDate?`<div class="task-sub">${task.subject?esc(task.subject):''}${task.subject&&task.dueDate?' Â· ':''}${task.dueDate?fmtDate(task.dueDate):''}</div>`:''}</div>
    <button class="task-del" onclick="deleteTask(${task.id})">âœ•</button>`;
  return el;
}

function refreshTasks(){
  const pending=state.tasks.filter(t=>!t.done),done=state.tasks.filter(t=>t.done);
  const fill=(id,items,msg)=>{const el=document.getElementById(id);if(!el)return;el.innerHTML='';if(!items.length){el.innerHTML=`<div class="empty"><div class="empty-icon">âœ…</div>${msg}</div>`;return;}items.forEach(t=>el.appendChild(makeTaskEl(t)));};
  fill('dashTaskList',pending.slice(0,5),'No pending tasks!');
  fill('allTasksList',pending,'No pending tasks!');
  fill('doneTasksList',done.slice(0,10),'Complete tasks to see them here');
  const due48=document.getElementById('due48List');
  if(due48){const cutoff=new Date(Date.now()+48*3600000);const up=pending.filter(t=>t.dueDate&&new Date(t.dueDate+'T23:59:59')<=cutoff);due48.innerHTML='';if(!up.length)due48.innerHTML='<div style="font-size:11px;color:var(--text3)">None due soon</div>';else up.forEach(t=>due48.appendChild(makeTaskEl(t)));}
  const ptl=document.getElementById('plannerTasks');if(ptl){const s=pending.filter(t=>t.dueDate).sort((a,b)=>a.dueDate.localeCompare(b.dueDate));ptl.innerHTML='';if(!s.length)ptl.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“…</div>No tasks with due dates</div>';else s.forEach(t=>ptl.appendChild(makeTaskEl(t)));}
  const pc=document.getElementById('pendCnt');if(pc)pc.textContent=pending.length;
  const total=state.tasks.length,doneCount=done.length;
  sEl('taskGT',`${doneCount}/${total}`);styleEl('taskGB',`width:${total?doneCount/total*100:0}%`);
  refreshSubjectDrops();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var noteTags=[],editingNoteId=null;
function noteFmt(cmd){const ed=document.getElementById('noteEditor');ed.focus();if(cmd==='h2')document.execCommand('formatBlock',false,'<h3>');else document.execCommand(cmd,false,null);}
function addNoteTag(){const v=document.getElementById('noteTagInput').value.trim();if(!v||noteTags.includes(v))return;noteTags.push(v);document.getElementById('noteTagInput').value='';renderNoteTagsDisplay();}
function renderNoteTagsDisplay(){document.getElementById('noteTagsDisplay').innerHTML=noteTags.map((t,i)=>`<span class="note-tag">${esc(t)}<span class="note-tag-del" onclick="removeNoteTag(${i})">âœ•</span></span>`).join('');}
function removeNoteTag(i){noteTags.splice(i,1);renderNoteTagsDisplay();}
function clearNoteEditor(){document.getElementById('noteEditor').innerHTML='';document.getElementById('note_title').value='';noteTags=[];renderNoteTagsDisplay();editingNoteId=null;}
function saveNote(){const title=document.getElementById('note_title').value.trim()||'Untitled';const content=document.getElementById('noteEditor').innerHTML;const subject=document.getElementById('note_subj').value;if(!content||content==='<br>'){notify('Write something first!','info');return;}if(editingNoteId){const n=state.notes.find(n=>n.id===editingNoteId);if(n){n.title=title;n.content=content;n.subject=subject;n.tags=[...noteTags];n.updatedAt=new Date().toISOString();}}else{state.notes.unshift({id:Date.now(),title,content,subject,tags:[...noteTags],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});}saveState();clearNoteEditor();renderNotes();checkBadges();notify('Note saved!','success');}
function renderNotes(){const el=document.getElementById('notesList');if(!el)return;const q=(document.getElementById('noteSearch')?.value||'').toLowerCase();const notes=state.notes.filter(n=>!q||n.title.toLowerCase().includes(q)||n.content.toLowerCase().includes(q));el.innerHTML='';if(!notes.length){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“</div>No notes yet</div>';return;}notes.forEach(n=>{const div=document.createElement('div');div.className='note-card';div.innerHTML=`<div class="note-card-title">${esc(n.title)}</div><div class="note-card-preview">${n.content.replace(/<[^>]*>/g,' ')}</div><div class="note-card-meta">${n.subject?esc(n.subject)+' Â· ':''}${fmtDate(n.updatedAt?.split('T')[0]||'')}</div>`;div.onclick=()=>viewNote(n.id);el.appendChild(div);});}
function viewNote(id){const n=state.notes.find(n=>n.id===id);if(!n)return;const v=document.getElementById('noteViewer');v.style.display='block';document.getElementById('noteViewTitle').textContent=n.title;document.getElementById('noteViewBody').innerHTML=n.content;document.getElementById('noteViewTags').innerHTML=n.tags.map(t=>`<span class="note-tag">${esc(t)}</span>`).join('');v.scrollIntoView({behavior:'smooth'});editingNoteId=id;}
function editNote(){if(!editingNoteId)return;const n=state.notes.find(n=>n.id===editingNoteId);if(!n)return;document.getElementById('note_title').value=n.title;document.getElementById('noteEditor').innerHTML=n.content;document.getElementById('note_subj').value=n.subject||'';noteTags=[...n.tags];renderNoteTagsDisplay();document.getElementById('noteViewer').style.display='none';window.scrollTo({top:0,behavior:'smooth'});notify('Editing note â€” save to update','info');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUBJECTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var pickedColor='#e8a832';
function pickColor(c,el){pickedColor=c;document.querySelectorAll('#colorPick .r-btn').forEach(b=>b.style.opacity='.5');el.style.opacity='1';}
function saveSubject(){const name=document.getElementById('ns_name').value.trim();if(!name)return;state.subjects.push({id:Date.now(),name,color:pickedColor});document.getElementById('ns_name').value='';closeModal('addSubjectModal');saveState();refreshSubjects();refreshSubjectDrops();notify(`Subject "${name}" added!`,'success');}
function refreshSubjects(){const c=document.getElementById('subjectCards');if(!c)return;c.innerHTML='';if(!state.subjects.length){c.innerHTML='<div class="empty card"><div class="empty-icon">ğŸ“š</div>Add your first subject</div>';return;}const maxMins=Math.max(...state.subjects.map(s=>state.sessions.filter(x=>x.subject===s.name).reduce((a,x)=>a+x.durationMinutes,0)),1);state.subjects.forEach(s=>{const sess=state.sessions.filter(x=>x.subject===s.name);const mins=sess.reduce((a,x)=>a+x.durationMinutes,0);const avgF=sess.length?(sess.reduce((a,x)=>a+x.focusRating,0)/sess.length).toFixed(1):'â€”';const el=document.createElement('div');el.className='subject-card';el.style.setProperty('--subject-color',s.color);el.innerHTML=`<div class="subject-name">${esc(s.name)}</div><div class="s-stats"><div class="s-stat"><strong>${fmtMins(mins)}</strong> studied</div><div class="s-stat"><strong>${sess.length}</strong> sessions</div><div class="s-stat"><strong>${avgF}</strong> avg focus</div></div><div class="s-bar"><div class="s-bar-fill" style="width:${mins/maxMins*100}%;background:${s.color}"></div></div><div style="text-align:right;margin-top:8px"><button class="btn btn-ghost btn-sm" onclick="delSubject(${s.id})" style="color:var(--red);border-color:var(--red)">Remove</button></div>`;c.appendChild(el);});}
function delSubject(id){state.subjects=state.subjects.filter(s=>s.id!==id);saveState();refreshSubjects();refreshSubjectDrops();}
function refreshSubjectDrops(){['curSubject','qaSubj','t_subj','ml_subject','sm_subject','note_subj'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML=`<option value="">${id==='curSubject'?'Subjectâ€¦':'Subjectâ€¦'}</option>`+state.subjects.map(s=>`<option value="${esc(s.name)}"${s.name===cur?' selected':''}>${esc(s.name)}</option>`).join('');});}
function onSubjectChange(){state.lastSubject=document.getElementById('curSubject').value;updateZenTask();}

/* â”€â”€â”€ EXAMS â”€â”€â”€ */
function saveExam(){const name=document.getElementById('ne_name').value.trim(),date=document.getElementById('ne_date').value;if(!name||!date)return;state.exams.push({id:Date.now(),name,date});document.getElementById('ne_name').value='';document.getElementById('ne_date').value='';closeModal('addExamModal');saveState();refreshExams();notify('Exam added!','success');}
function refreshExams(){const el=document.getElementById('examList');if(!el)return;const today=new Date();today.setHours(0,0,0,0);const sorted=[...state.exams].sort((a,b)=>a.date.localeCompare(b.date));if(!sorted.length){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“…</div>No exams added</div>';return;}el.innerHTML=sorted.map(e=>{const d=new Date(e.date+'T00:00:00'),diff=Math.ceil((d-today)/86400000);return`<div class="exam-item"><div><div class="exam-name">${esc(e.name)}</div><div class="exam-date">${fmtDate(e.date)}</div></div><div style="display:flex;align-items:center;gap:10px"><div><div class="exam-days ${diff<=7?'urgent':''}">${diff<0?'PAST':diff}</div><div class="exam-days-lbl" style="font-family:var(--font-mono);font-size:9px;color:var(--text3);text-align:right">${diff>=0?'days left':''}</div></div><button class="task-del" style="opacity:1" onclick="delExam(${e.id})">âœ•</button></div></div>`;}).join('');}
function delExam(id){state.exams=state.exams.filter(e=>e.id!==id);saveState();refreshExams();}

/* â”€â”€â”€ LINKS â”€â”€â”€ */
function saveLink(){const name=document.getElementById('nl_name').value.trim(),url=document.getElementById('nl_url').value.trim();if(!name||!url)return;state.links.push({id:Date.now(),name,url});document.getElementById('nl_name').value='';document.getElementById('nl_url').value='';closeModal('addLinkModal');saveState();refreshLinks();}
function refreshLinks(){const el=document.getElementById('linksList');if(!el)return;if(!state.links.length){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ”—</div>No links added</div>';return;}el.innerHTML=state.links.map(l=>`<a href="${esc(l.url)}" target="_blank" rel="noopener" class="link-item"><div><div class="link-name">${esc(l.name)}</div><div class="link-url">${esc(l.url.replace(/^https?:\/\//,'').slice(0,50))}</div></div><span style="color:var(--text3)">â†—</span></a>`).join('');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANALYTICS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function refreshAnalytics(){
  const last7=[],labels=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);last7.push(d.toISOString().split('T')[0]);labels.push(['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()]);}
  const wData=last7.map(d=>state.sessions.filter(s=>s.date===d).reduce((a,s)=>a+s.productiveMinutes,0));
  rebuildChart('wChart','bar',{labels,datasets:[{label:'Productive Min',data:wData,backgroundColor:'rgba(232,168,50,.5)',borderColor:'#e8a832',borderWidth:1,borderRadius:5}]},cOpts());
  const subT={};state.sessions.forEach(s=>{subT[s.subject||'General']=(subT[s.subject||'General']||0)+s.durationMinutes;});
  const sN=Object.keys(subT);const sC=['#e8a832','#68a8e8','#6fcf87','#a868e8','#e86868','#68e8c8'];
  if(sN.length)rebuildChart('pChart','doughnut',{labels:sN,datasets:[{data:sN.map(n=>subT[n]),backgroundColor:sN.map((_,i)=>sC[i%sC.length]),borderWidth:0}]},{...cOpts(),cutout:'62%',plugins:{legend:{position:'right',labels:{color:'#a09880',font:{family:'DM Mono',size:10},boxWidth:10}}}});
  const last10=state.sessions.slice(-10);
  rebuildChart('fChart','line',{labels:last10.map((_,i)=>`#${i+1}`),datasets:[{label:'Focus',data:last10.map(s=>s.focusRating),borderColor:'#68a8e8',backgroundColor:'rgba(104,168,232,.1)',tension:.4,fill:true,pointRadius:3},{label:'Energy',data:last10.map(s=>s.energyRating),borderColor:'#6fcf87',backgroundColor:'rgba(111,207,135,.1)',tension:.4,fill:true,pointRadius:3}]},{...cOpts(),scales:{y:{min:0,max:5,...axS()},x:axS(true)}});
  const tT={};state.sessions.forEach(s=>{tT[s.type||'General']=(tT[s.type||'General']||0)+s.durationMinutes;});const tN=Object.keys(tT);
  rebuildChart('tChart','bar',{labels:tN,datasets:[{label:'Minutes',data:tN.map(n=>tT[n]),backgroundColor:'rgba(168,104,232,.5)',borderColor:'#a868e8',borderWidth:1,borderRadius:5}]},{...cOpts(),indexAxis:'y'});
  const byDay={};state.sessions.forEach(s=>{if(!byDay[s.date])byDay[s.date]=[];byDay[s.date].push(s);});
  const days=Object.keys(byDay).sort().reverse();const dr=document.getElementById('dailyReport');
  if(dr){if(!days.length){dr.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‹</div>No data yet</div>';return;}dr.innerHTML=days.slice(0,30).map(d=>{const sess=byDay[d],mins=sess.reduce((a,s)=>a+s.durationMinutes,0),prod=sess.reduce((a,s)=>a+s.productiveMinutes,0),avgF=(sess.reduce((a,s)=>a+s.focusRating,0)/sess.length).toFixed(1),subjs=[...new Set(sess.map(s=>s.subject))].join(', ');return`<div style="display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border)"><div><div style="font-size:13px;color:var(--text)">${d}</div><div style="font-size:10px;color:var(--text3);font-family:var(--font-mono)">${subjs}</div></div><div style="display:flex;gap:16px;text-align:right"><div><div style="font-family:var(--font-mono);font-size:14px;color:var(--text)">${fmtMins(mins)}</div><div style="font-size:9px;color:var(--text3)">studied</div></div><div><div style="font-family:var(--font-mono);font-size:14px;color:var(--accent)">${fmtMins(prod)}</div><div style="font-size:9px;color:var(--text3)">productive</div></div><div><div style="font-family:var(--font-mono);font-size:14px;color:var(--blue)">${avgF}</div><div style="font-size:9px;color:var(--text3)">focus</div></div></div></div>`;}).join('');}
}
function rebuildChart(id,type,data,options){if(charts[id]){charts[id].destroy();delete charts[id];}const c=document.getElementById(id);if(!c)return;charts[id]=new Chart(c.getContext('2d'),{type,data,options});}
function cOpts(){return{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},tooltip:{backgroundColor:'#161512',titleColor:'#f0ead8',bodyColor:'#a09880',borderColor:'#2e2c28',borderWidth:1}},scales:{y:axS(),x:axS(true)}};}
function axS(x=false){return{grid:{color:'rgba(90,85,72,.12)',drawBorder:false},ticks:{color:'#5a5548',font:{family:'DM Mono',size:9}},border:{display:false}};}

/* â”€â”€â”€ HEATMAP â”€â”€â”€ */
function refreshHeatmap(){
  const hm=document.getElementById('heatmap');if(!hm)return;hm.innerHTML='';
  const today=new Date();today.setHours(0,0,0,0);
  const start=new Date(today);start.setDate(today.getDate()-52*7);
  const dow=(start.getDay()+6)%7;start.setDate(start.getDate()-dow);
  const dayMap={};state.sessions.forEach(s=>{dayMap[s.date]=(dayMap[s.date]||0)+s.durationMinutes;});
  const maxMins=Math.max(...Object.values(dayMap),1);
  const numWeeks=Math.ceil((today-start)/(7*86400000))+1;
  for(let w=0;w<numWeeks;w++){const col=document.createElement('div');col.className='hm-col';for(let d=0;d<7;d++){const date=new Date(start);date.setDate(start.getDate()+w*7+d);if(date>today){const s=document.createElement('div');s.style.cssText='width:12px;height:12px';col.appendChild(s);continue;}const key=date.toISOString().split('T')[0],mins=dayMap[key]||0;let lvl=0;if(mins>0)lvl=mins<maxMins*.25?1:mins<maxMins*.5?2:mins<maxMins*.75?3:4;const cell=document.createElement('div');cell.className=`hm-cell${lvl?' l'+lvl:''}`;cell.setAttribute('data-tip',`${key}: ${fmtMins(mins)}`);col.appendChild(cell);}hm.appendChild(col);}
  const hmDays=document.getElementById('hmDays');if(hmDays)hmDays.innerHTML=['Mo','','We','','Fr','','Su'].map(l=>`<div class="hm-day-label">${l}</div>`).join('');
  let longest=0,cur=0,prev=null;const allDays=Object.keys(dayMap).sort();allDays.forEach(d=>{if(prev){const diff=Math.floor((new Date(d)-new Date(prev))/86400000);if(diff===1)cur++;else cur=1;}else cur=1;if(cur>longest)longest=cur;prev=d;});
  const best=allDays.length?allDays.reduce((a,b)=>(dayMap[a]||0)>(dayMap[b]||0)?a:b):null;
  sEl('bestDay',best?`${best} (${fmtMins(dayMap[best])})` : 'â€”');sEl('longestStreak',longest+' days');
  const wkSet=new Set();allDays.forEach(d=>{const dt=new Date(d);wkSet.add(dt.getFullYear()+'W'+Math.floor((dt-new Date(dt.getFullYear(),0,1))/(7*86400000)));});sEl('activeWeeks',wkSet.size);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BADGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */


















function checkBadges(){
  const s=state.sessions,tasks=state.tasks,earned=state.earnedBadges||[];
  const earn=id=>{if(!earned.includes(id)){earned.push(id);const b=BADGES.find(x=>x.id===id);if(b)notify(`ğŸ… Badge unlocked: ${b.name}!`,'success');}};
  const totalMins=s.reduce((a,x)=>a+x.durationMinutes,0);
  if(s.length>=1)earn('first_session');if(s.length>=10)earn('ten_sessions');if(s.length>=50)earn('fifty_sessions');
  if(totalMins>=60)earn('one_hour');if(totalMins>=600)earn('ten_hours');if(totalMins>=3000)earn('fifty_hours');
  if((state.streak||0)>=3)earn('streak_3');if((state.streak||0)>=7)earn('streak_7');if((state.streak||0)>=30)earn('streak_30');
  if(s.some(x=>x.hour>=22))earn('night_owl');if(s.some(x=>x.hour<7))earn('early_bird');
  if(new Set(s.map(x=>x.subject)).size>=5)earn('five_subjects');
  if(s.some(x=>x.focusRating===5))earn('perfect_focus');
  if(tasks.filter(t=>t.done).length>=20)earn('task_master');
  const allTypes=['Active Recall','Reading','Problem Solving','Revision','Lecture','Writing','Research'];
  if(allTypes.every(t=>s.some(x=>x.type===t)))earn('all_types');
  if((state.notes||[]).length>=5)earn('note_taker');
  state.earnedBadges=earned;saveState();
}
function renderBadges(){const el=document.getElementById('badgesGrid');if(!el)return;const earned=state.earnedBadges||[];el.innerHTML=BADGES.map(b=>`<div class="badge ${earned.includes(b.id)?'earned':''}" title="${b.desc}"><div class="badge-icon">${b.icon}</div><div class="badge-name">${b.name}</div><div class="badge-desc">${b.desc}</div></div>`).join('');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PUBLIC PROFILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function refreshProfilePage(){
  if(!currentUser) return;
  const name=state.displayName||currentUser.user_metadata?.full_name||currentUser.email.split('@')[0];
  const initials=getUserInitials(name,currentUser.email);
  sEl('profileAvatarLg',initials);sEl('profileDisplayName',name);
  sEl('profileHandle','@'+currentUser.email);

  // Currently studying
  if(state.currentSubject||state.currentTopic){
    sEl('currentlyText',`Studying: ${state.currentSubject||''}${state.currentTopic?' â€” '+state.currentTopic:''}`);
    sEl('currentlySub','Live now');
  } else {
    sEl('currentlyText','Not currently studying');
    sEl('currentlySub','Start a timer session to go live');
  }

  // Stats
  const now=new Date(),dow=(now.getDay()+6)%7;
  const wStart=new Date(now);wStart.setDate(now.getDate()-dow);wStart.setHours(0,0,0,0);
  const weekMins=state.sessions.filter(s=>new Date(s.date)>=wStart).reduce((a,s)=>a+s.durationMinutes,0);
  const ps=document.getElementById('pubStats');
  if(ps)ps.innerHTML=`
    <div class="pub-stat"><div class="pub-stat-val">${fmtMinsShort(weekMins)}</div><div class="pub-stat-lbl">This Week</div></div>
    <div class="pub-stat"><div class="pub-stat-val">${state.streak||0}ğŸ”¥</div><div class="pub-stat-lbl">Streak</div></div>
    <div class="pub-stat"><div class="pub-stat-val">${state.sessions.length}</div><div class="pub-stat-lbl">Sessions</div></div>`;
}

function showPubProfile(){
  // Build the public profile card HTML
  const pub=JSON.parse(localStorage.getItem(publicKey())||'{}');
  if(!pub.email){updatePublicData();return;}
  const initials=getUserInitials(pub.displayName,pub.email);
  const topSubs=pub.topSubjects||[];
  document.getElementById('pubProfileContent').innerHTML=`
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px">
      <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:#0e0d0b;flex-shrink:0">${esc(initials)}</div>
      <div><div style="font-family:var(--font-display);font-size:18px;color:var(--text)">${esc(pub.displayName||'Anonymous')}</div><div style="font-family:var(--font-mono);font-size:10px;color:var(--text3)">${esc(pub.email)}</div></div>
    </div>
    ${pub.currentSubject||pub.currentTopic?`<div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;display:flex;align-items:center;gap:10px;margin-bottom:14px"><div class="live-dot"></div><div><div style="font-size:13px;color:var(--text)">Studying: ${esc(pub.currentSubject||'')}${pub.currentTopic?' â€” '+esc(pub.currentTopic):''}</div><div style="font-size:10px;color:var(--text3);font-family:var(--font-mono)">Live now</div></div></div>`:''}
    <div style="display:flex;gap:20px;margin-bottom:14px">
      <div><div style="font-family:var(--font-mono);font-size:20px;color:var(--text)">${fmtMinsShort(pub.weeklyMinutes||0)}</div><div style="font-size:10px;color:var(--text3)">This Week</div></div>
      <div><div style="font-family:var(--font-mono);font-size:20px;color:var(--text)">${pub.streak||0}ğŸ”¥</div><div style="font-size:10px;color:var(--text3)">Day Streak</div></div>
      <div><div style="font-family:var(--font-mono);font-size:20px;color:var(--text)">${pub.totalSessions||0}</div><div style="font-size:10px;color:var(--text3)">Sessions</div></div>
    </div>
    ${topSubs.length?`<div style="margin-bottom:14px"><div style="font-family:var(--font-mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Top Subjects</div>${topSubs.map(s=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border)"><span style="font-size:13px;color:var(--text)">${esc(s.subject)}</span><span style="font-family:var(--font-mono);font-size:11px;color:var(--accent)">${fmtMins(s.minutes)}</span></div>`).join('')}</div>`:''}
    <div style="font-family:var(--font-mono);font-size:9px;color:var(--text3)">Last active: ${pub.lastActive?new Date(pub.lastActive).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):'Never'}</div>`;
  document.getElementById('pubProfileOv').classList.add('active');
}

function closePubProfile(){document.getElementById('pubProfileOv').classList.remove('active');}

function copyProfileLink(){
  // The "profile link" tells people to open the app and see your public data
  // In a real multi-user app this would be a real URL â€” here we explain the concept
  const handle=currentUser.email.split('@')[0];
  const fakeUrl=`${window.location.origin}/app.html?profile=${encodeURIComponent(currentUser.email)}`;
  navigator.clipboard.writeText(fakeUrl).then(()=>notify('Profile link copied! ğŸ“‹','success')).catch(()=>notify('Copy: '+fakeUrl,'info'));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function refreshDashboard(){
  const today=new Date().toISOString().split('T')[0];
  const todaySess=state.sessions.filter(s=>s.date===today);
  const todayMins=todaySess.reduce((a,s)=>a+s.durationMinutes,0);
  const todayProd=todaySess.reduce((a,s)=>a+s.productiveMinutes,0);
  const now=new Date(),dow=(now.getDay()+6)%7;
  const wStart=new Date(now);wStart.setDate(now.getDate()-dow);wStart.setHours(0,0,0,0);
  const weekMins=state.sessions.filter(s=>new Date(s.date)>=wStart).reduce((a,s)=>a+s.durationMinutes,0);
  sEl('todayHrs',fmtMins(todayMins));sEl('todaySess',todaySess.length);sEl('weekHrs',fmtMinsShort(weekMins));sEl('prodMin',fmtMins(todayProd));sEl('streakNum',state.streak||0);
  const dg=state.goals.daily||120,wg=state.goals.weekly||600;
  const dp=Math.min(100,Math.round(todayMins/dg*100)),wp=Math.min(100,Math.round(weekMins/wg*100));
  sEl('dailyGT',`${todayMins}/${dg}m`);sEl('weeklyGT',`${weekMins}/${wg}m`);
  styleEl('dailyGB',`width:${dp}%`);styleEl('weeklyGB',`width:${wp}%`);sEl('ringPct',dp+'%');
  const off=238.76-(dp/100*238.76);const rc=document.getElementById('ringCircle');if(rc)rc.style.strokeDashoffset=off;
  buildWeeklyReview();
  const gs=document.getElementById('goalsSummary');
  if(gs)gs.innerHTML=`<div class="goal-item"><div class="goal-hd"><span class="goal-name">Today</span><span class="goal-txt">${fmtMins(todayMins)}/${dg}m</span></div><div class="goal-bar"><div class="goal-fill" style="width:${dp}%;background:var(--accent)"></div></div></div><div class="goal-item"><div class="goal-hd"><span class="goal-name">This Week</span><span class="goal-txt">${fmtMins(weekMins)}/${wg}m</span></div><div class="goal-bar"><div class="goal-fill" style="width:${wp}%;background:var(--blue)"></div></div></div><div style="margin-top:12px;font-size:13px;color:var(--text2);line-height:2.1"><div>ğŸ”¥ Streak: <strong style="color:var(--accent)">${state.streak||0} days</strong></div><div>ğŸ“š Sessions: <strong>${state.sessions.length}</strong></div><div>â± Total: <strong>${fmtMins(state.sessions.reduce((a,s)=>a+s.durationMinutes,0))}</strong></div></div>`;
}

function buildWeeklyReview(){
  const el=document.getElementById('weeklyReview');if(!el)return;
  const now=new Date(),dow=(now.getDay()+6)%7;
  const wStart=new Date(now);wStart.setDate(now.getDate()-dow);wStart.setHours(0,0,0,0);
  const pStart=new Date(wStart);pStart.setDate(wStart.getDate()-7);
  const thisWeek=state.sessions.filter(s=>new Date(s.date)>=wStart);
  const lastWeek=state.sessions.filter(s=>{const d=new Date(s.date);return d>=pStart&&d<wStart;});
  const thisMins=thisWeek.reduce((a,s)=>a+s.durationMinutes,0);
  const lastMins=lastWeek.reduce((a,s)=>a+s.durationMinutes,0);
  const thisProd=thisWeek.reduce((a,s)=>a+s.productiveMinutes,0);
  const change=lastMins>0?Math.round((thisMins-lastMins)/lastMins*100):null;
  const subjects=[...new Set(thisWeek.map(s=>s.subject||'General'))];
  const topSubj=subjects.length?subjects.reduce((a,b)=>{const am=thisWeek.filter(s=>(s.subject||'General')===a).reduce((x,s)=>x+s.durationMinutes,0);const bm=thisWeek.filter(s=>(s.subject||'General')===b).reduce((x,s)=>x+s.durationMinutes,0);return am>bm?a:b;}):null;
  if(thisMins===0){el.innerHTML='<div class="review-headline">No sessions this week yet.</div><div class="review-body">Start a timer to begin tracking your progress!</div>';return;}
  const changeStr=change===null?'':change>0?` â€” <span class="review-highlight">â†‘${change}% vs last week</span>`:change<0?` â€” <span style="color:var(--blue)">â†“${Math.abs(change)}% vs last week</span>`:'';
  el.innerHTML=`<div class="review-headline">This week: <span class="review-highlight">${fmtMins(thisMins)}</span>${changeStr}</div><div class="review-body" style="margin-top:5px">${thisWeek.length} session${thisWeek.length!==1?'s':''} &nbsp;Â·&nbsp; <span class="review-highlight">${fmtMins(thisProd)}</span> productive &nbsp;Â·&nbsp;${topSubj?` Top: <span class="review-highlight">${esc(topSubj)}</span>`:''} ${(state.streak||0)>0?` &nbsp;Â·&nbsp; ğŸ”¥ ${state.streak}-day streak`:''}</div>`;
}

function refreshLog(){
  const el=document.getElementById('logBody');if(!el)return;
  if(!state.sessions.length){el.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--text3);padding:22px;font-family:var(--font-mono)">No sessions yet</td></tr>';return;}
  el.innerHTML=[...state.sessions].reverse().map(s=>`
    <tr class="log-row" onclick="toggleLogRow(${s.id})">
      <td style="color:var(--text);font-family:var(--font-mono);font-size:11px">${s.date}</td>
      <td style="color:var(--accent)">${esc(s.subject||'â€”')}</td>
      <td>${esc(s.topic||'â€”')}</td>
      <td><span class="type-badge">${esc(s.type||'General')}</span></td>
      <td style="font-family:var(--font-mono)">${s.durationMinutes}m</td>
      <td><span class="focus-stars">${'â˜…'.repeat(s.focusRating)}</span></td>
      <td><span class="focus-stars" style="color:var(--green)">${'â˜…'.repeat(s.energyRating)}</span></td>
      <td><div style="display:flex;align-items:center;gap:7px">
        <span style="font-family:var(--font-mono);color:var(--text2)">${s.productiveMinutes}m</span>
        <button onclick="event.stopPropagation();deleteSession(${s.id})" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:12px;padding:2px 5px;border-radius:3px" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--text3)'">âœ•</button>
      </div></td>
    </tr>
    <tr class="log-expand" id="expand-${s.id}">
      <td colspan="8">
        ${s.notes?`<div style="margin-bottom:5px"><strong style="color:var(--text)">Notes:</strong> ${esc(s.notes)}</div>`:'<em style="color:var(--text3)">No notes</em>'}
        ${s.manual?'<span style="font-family:var(--font-mono);font-size:9px;color:var(--text3);background:var(--bg4);padding:2px 7px;border-radius:100px">manually added</span>':''}
        <div style="margin-top:5px;font-size:10px;color:var(--text3);font-family:var(--font-mono)">Started: ${s.startTime?new Date(s.startTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'â€”'} Â· Hour: ${s.hour??'â€”'}:00</div>
      </td>
    </tr>`).join('');
}

function toggleLogRow(id){const el=document.getElementById('expand-'+id);if(el)el.classList.toggle('open');}
function deleteSession(id){if(!confirm('Delete this session?'))return;state.sessions=state.sessions.filter(s=>s.id!==id);saveState();refreshAll();notify('Session deleted.','info');}

function refreshWeekPlanner(){
  const el=document.getElementById('weekPlanner');if(!el)return;
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],now=new Date(),dow=(now.getDay()+6)%7;
  el.innerHTML=days.map((day,i)=>{const d=new Date(now);d.setDate(now.getDate()-dow+i);const key=d.toISOString().split('T')[0],mins=state.sessions.filter(s=>s.date===key).reduce((a,s)=>a+s.durationMinutes,0);const isToday=i===dow,pct=Math.min(100,mins/(state.goals.daily||120)*100);return`<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border)"><div style="width:28px;font-family:var(--font-mono);font-size:10px;color:${isToday?'var(--accent)':'var(--text3)'}">${day}</div><div style="flex:1;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${isToday?'var(--accent)':'var(--text3)'};border-radius:2px;transition:width .5s"></div></div><div style="font-family:var(--font-mono);font-size:10px;color:var(--text3);width:30px;text-align:right">${mins>0?fmtMinsShort(mins):''}</div></div>`;}).join('');
}

/* â”€â”€â”€ GOALS â”€â”€â”€ */
function saveGoals(){state.goals.daily=parseInt(document.getElementById('g_daily').value)||120;state.goals.weekly=parseInt(document.getElementById('g_weekly').value)||600;saveState();refreshDashboard();notify('Goals saved!','success');}
function saveSettings(){state.settings.customFocus=parseInt(document.getElementById('s_focus').value)||45;state.settings.customBreak=parseInt(document.getElementById('s_break').value)||10;saveState();notify('Settings saved!','success');}

/* â”€â”€â”€ SOUNDS â”€â”€â”€ */
var audioCtx=null,activeSounds={},soundVol=0.3;
function getCtx(){return audioCtx=audioCtx||new(window.AudioContext||window.webkitAudioContext)();}
function toggleSound(type,btn){if(activeSounds[type]){activeSounds[type].forEach(n=>{try{n.stop()}catch(e){}});delete activeSounds[type];btn.classList.remove('active');}else{btn.classList.add('active');playAmbient(type);}}
function playAmbient(type){const ctx=getCtx(),nodes=[];const noise=(dur=2,freq=800,gain=0.3)=>{const buf=ctx.createBuffer(1,ctx.sampleRate*dur,ctx.sampleRate),data=buf.getChannelData(0);for(let i=0;i<data.length;i++)data[i]=(Math.random()*2-1)*0.5;const src=ctx.createBufferSource();src.buffer=buf;src.loop=true;const f=ctx.createBiquadFilter();f.type='lowpass';f.frequency.value=freq;const g=ctx.createGain();g.gain.value=soundVol*gain;src.connect(f);f.connect(g);g.connect(ctx.destination);src.start();return src;};if(type==='rain'){nodes.push(noise(2,700,.4),noise(2,1200,.2),noise(2,400,.15));}else if(type==='fire'){nodes.push(noise(2,300,.35));}else if(type==='ocean'){nodes.push(noise(4,500,.4),noise(4,300,.2));}else if(type==='forest'){nodes.push(noise(3,2000,.15));}else if(type==='cafe'){for(let i=0;i<4;i++){const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=150+Math.random()*300;g.gain.value=0;o.connect(g);g.connect(ctx.destination);o.start();const m=()=>{const t=ctx.currentTime;g.gain.setTargetAtTime(soundVol*.02*Math.random(),t,.1);g.gain.setTargetAtTime(0,t+.3+Math.random()*.5,.1);setTimeout(m,500+Math.random()*1000)};m();nodes.push(o);}}activeSounds[type]=nodes;}
function setVol(v){soundVol=parseFloat(v);}
function beep(){try{const ctx=getCtx(),o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.setValueAtTime(880,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(440,ctx.currentTime+.3);g.gain.setValueAtTime(.2,ctx.currentTime);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.4);o.connect(g);g.connect(ctx.destination);o.start();o.stop(ctx.currentTime+.4);}catch(e){}}

/* â”€â”€â”€ EMBED â”€â”€â”€ */
function loadEmbed(){const url=document.getElementById('embedUrl').value.trim();if(!url)return;document.getElementById('embedBox').innerHTML=`<iframe src="${url}" width="100%" height="200" frameborder="0" allow="autoplay" style="border-radius:var(--radius-sm);border:1px solid var(--border)"></iframe>`;}
function clearEmbed(){document.getElementById('embedBox').innerHTML='';document.getElementById('embedUrl').value='';}

/* â”€â”€â”€ ZEN â”€â”€â”€ */
function toggleZen(){document.getElementById('zenOv').classList.toggle('active');updateZenTask();}
function updateZenTask(){const t=document.getElementById('curTopic').value||document.getElementById('curSubject').value||'No task set';document.getElementById('zenTask').textContent=t;}
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.getElementById('zenOv').classList.remove('active');});

/* â”€â”€â”€ KBD SHORTCUTS â”€â”€â”€ */
var kbdVisible=false;
document.addEventListener('keydown',e=>{
  const tag=document.activeElement.tagName.toLowerCase();
  if(['input','textarea','select'].includes(tag)||document.activeElement.contentEditable==='true')return;
  if(e.code==='Space'){e.preventDefault();toggleTimer();}
  if(e.key.toLowerCase()==='s')stopTimer();
  if(e.key.toLowerCase()==='z')toggleZen();
  if(e.key.toLowerCase()==='m')openModal('manualModal');
  if(e.key==='?'){kbdVisible=!kbdVisible;document.getElementById('kbdHud').classList.toggle('show',kbdVisible);}
});

/* â”€â”€â”€ THEME â”€â”€â”€ */

function setTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('focusTheme_v4',t);const icons={dark:'ğŸŒ‘',dim:'ğŸŒ˜',light:'â˜€'};document.getElementById('themeBtn').textContent=icons[t]||'â˜€';}
function cycleTheme(){themeIdx=(themeIdx+1)%themes.length;setTheme(themes[themeIdx]);}

/* â”€â”€â”€ NAVIGATION â”€â”€â”€ */

function nav(page,btn){
  document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  if(btn)btn.classList.add('active');
  document.getElementById('pageTitle').textContent=PAGE_TITLES[page]||page;
  if(window.innerWidth<=900)document.getElementById('sidebar').classList.remove('open');
  if(page==='analytics')setTimeout(refreshAnalytics,50);
  if(page==='heatmap')refreshHeatmap();
  if(page==='badges')renderBadges();
  if(page==='notes')renderNotes();
  if(page==='profile')refreshProfilePage();
  if(page==='lounge'){clearUnread();refreshLoungeStats();}
  if(page==='goals'){document.getElementById('g_daily').value=state.goals.daily||120;document.getElementById('g_weekly').value=state.goals.weekly||600;}
  if(page==='settings'){document.getElementById('s_focus').value=state.settings.customFocus||45;document.getElementById('s_break').value=state.settings.customBreak||10;}
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}

/* â”€â”€â”€ EXPORT / IMPORT â”€â”€â”€ */
function exportCSV(){const rows=[['Date','Subject','Topic','Type','Duration','Focus','Energy','Productive','Notes']];state.sessions.forEach(s=>rows.push([s.date,s.subject,s.topic,s.type||'General',s.durationMinutes,s.focusRating,s.energyRating,s.productiveMinutes,s.notes]));dl('focus-sessions.csv',rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n'),'text/csv');}
function exportJSON(){dl('focus-data.json',JSON.stringify(state,null,2),'application/json');}
function importJSON(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.sessions){const blank=blankState();Object.keys(blank).forEach(k=>{if(d[k]!==undefined)state[k]=d[k];});saveState();refreshAll();notify('Data imported!','success');}else{notify('Invalid file format','info');}}catch(err){notify('Import failed','info');}};reader.readAsText(file);e.target.value='';}
function dl(name,content,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=name;a.click();}
function clearAll(){if(!confirm('Clear ALL data? Cannot be undone.'))return;state=blankState();saveState();refreshAll();notify('Data cleared.','info');}

/* â”€â”€â”€ CLOCK + QUOTES â”€â”€â”€ */

var quoteIdx=Math.floor(Math.random()*QUOTES.length);
function updateClock(){const n=new Date(),t=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;const el=document.getElementById('topClock');if(el)el.textContent=t;}
function rotateQuote(){quoteIdx=(quoteIdx+1)%QUOTES.length;const el=document.getElementById('quoteStrip');if(el){el.style.opacity='0';setTimeout(()=>{el.textContent='"'+QUOTES[quoteIdx]+'"';el.style.opacity='1';},400);}}
setInterval(updateClock,1000);setInterval(rotateQuote,30000);updateClock();


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE CHAT â€” STUDY LOUNGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */



var unreadCount = 0;
var loungeVisible = false;
var presenceRef = null;
var messagesRef = null;
var onlineRef = null;
var leaderboardRef = null;
var chatFilter = 'all';
var lastMsgTimestamp = 0;

var MAX_MSG_LENGTH = 400;

function initFirebase() {
  try {
    // Check if config is filled in
    if (!window.FIREBASE_CONFIG || FIREBASE_CONFIG.apiKey === 'PASTE_YOUR_apiKey_HERE') {
      document.getElementById('firebaseSetupBanner').style.display = 'block';
      document.getElementById('chatLoading').innerHTML = '<span style="color:var(--text3);font-family:var(--font-mono);font-size:11px;text-align:center;padding:20px">âš  Firebase not configured.<br>See the banner above.</span>';
      document.getElementById('chatInputArea').style.display = 'none';
      return;
    }

    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.database();
    firebaseReady = true;

    messagesRef   = db.ref('lounge/messages');
    onlineRef     = db.ref('lounge/online');
    leaderboardRef= db.ref('lounge/leaderboard');

    // Check ban status
    db.ref(`lounge/banned/${emailToKey(currentUser.email)}`).get().then(snap => {
      if (snap.exists() && snap.val() === true) {
        showBanned(); return;
      }
      setupPresence();
      listenMessages();
      listenOnline();
      listenLeaderboard();
      pushLeaderboardEntry();
      // Show admin panel if admin
      if (isAdmin()) document.getElementById('adminPanel').style.display = 'block';
    });

  } catch(e) {
    console.error('Firebase init error:', e);
    document.getElementById('chatLoading').innerHTML = `<span style="color:var(--red);font-size:11px;font-family:var(--font-mono);text-align:center;padding:16px">Firebase error: ${esc(e.message)}</span>`;
  }
}

function emailToKey(email) {
  // Firebase keys can't have . @ chars
  return btoa(email).replace(/[.#$/[\]]/g,'_');
}

function isAdmin() {
  return typeof ADMIN_EMAILS !== 'undefined' && ADMIN_EMAILS.includes(currentUser.email);
}

/* â”€â”€ PRESENCE â”€â”€ */
function setupPresence() {
  const key = emailToKey(currentUser.email);
  presenceRef = onlineRef.child(key);
  const name = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
  const now = new Date();
  const dow = (now.getDay()+6)%7;
  const wStart = new Date(now); wStart.setDate(now.getDate()-dow); wStart.setHours(0,0,0,0);
  const weekMins = state.sessions.filter(s=>new Date(s.date)>=wStart).reduce((a,s)=>a+s.durationMinutes,0);

  const presenceData = {
    name, email: currentUser.email,
    initials: getUserInitials(name, currentUser.email),
    currentSubject: state.currentSubject || '',
    currentTopic: state.currentTopic || '',
    weekMins, streak: state.streak || 0,
    joinedAt: firebase.database.ServerValue.TIMESTAMP
  };

  presenceRef.set(presenceData);
  presenceRef.onDisconnect().remove();

  // Update presence when studying state changes
  window._updatePresence = () => {
    if (!presenceRef) return;
    presenceRef.update({
      currentSubject: state.currentSubject || '',
      currentTopic: state.currentTopic || ''
    });
  };
}

/* â”€â”€ MESSAGES LISTENER â”€â”€ */
function listenMessages() {
  document.getElementById('chatLoading').style.display = 'none';

  // Load last 80 messages
  messagesRef.limitToLast(80).on('value', snap => {
    const msgs = [];
    snap.forEach(child => {
      msgs.push({id: child.key, ...child.val()});
    });
    renderMessages(msgs);
  });

  // Listen for new messages (for unread badge)
  messagesRef.limitToLast(1).on('child_added', snap => {
    const msg = snap.val();
    if (!msg) return;
    if (msg.timestamp > lastMsgTimestamp && msg.email !== currentUser.email) {
      if (!loungeVisible) showUnread();
    }
    lastMsgTimestamp = msg.timestamp || Date.now();
  });
}

/* â”€â”€ RENDER MESSAGES â”€â”€ */
function renderMessages(msgs) {
  const el = document.getElementById('chatMessages');
  if (!el) return;
  const wasAtBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 60;

  // Apply filter
  const filtered = chatFilter === 'studying'
    ? msgs.filter(m => m.currentSubject)
    : msgs;

  el.innerHTML = '';

  if (!filtered.length) {
    el.innerHTML = '<div class="sys-msg" style="margin-top:40px">No messages yet. Say hello! ğŸ‘‹</div>';
    return;
  }

  let prevDate = '';
  filtered.forEach(msg => {
    // Date separator
    if (msg.timestamp) {
      const d = new Date(msg.timestamp).toLocaleDateString('en-US',{month:'short',day:'numeric'});
      if (d !== prevDate) {
        const sep = document.createElement('div');
        sep.className = 'sys-msg';
        sep.textContent = d;
        el.appendChild(sep);
        prevDate = d;
      }
    }

    // System messages
    if (msg.type === 'system') {
      const sys = document.createElement('div');
      sys.className = 'sys-msg';
      sys.textContent = msg.text;
      el.appendChild(sys);
      return;
    }

    // Skip muted users
    const isMuted = mutedUsers.includes(msg.email);
    const isBannedMsg = msg.banned === true;
    if (isBannedMsg && !isAdmin()) return; // hide banned msgs for non-admins

    const isOwn = msg.email === currentUser.email;
    const initials = msg.initials || (msg.name||'?')[0].toUpperCase();

    const row = document.createElement('div');
    row.className = 'msg-row' + (isOwn ? ' own' : '');
    row.id = 'msg-' + msg.id;

    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';

    // Build reactions HTML
    const reactHtml = buildReactionsHtml(msg.id, msg.reactions||{});

    // Admin/mute controls
    let adminControls = '';
    if (!isOwn) {
      if (isAdmin()) {
        adminControls = `<button class="msg-admin-btn" onclick="adminDeleteMsg('${msg.id}')" title="Delete">ğŸ—‘</button>
          <button class="msg-admin-btn" onclick="adminBanUserFromMsg('${esc(msg.email)}')" title="Ban user">ğŸš«</button>`;
      } else {
        adminControls = `<button class="msg-admin-btn" onclick="muteUser('${esc(msg.email)}')" title="Mute user">ğŸ”‡</button>`;
      }
    }

    row.innerHTML = `
      <div class="msg-avatar" style="background:${hashColor(msg.email)};color:#fff">${esc(initials)}</div>
      <div class="msg-body">
        <div class="msg-meta">
          <span class="msg-name">${esc(msg.name||'User')}</span>
          <span>${time}</span>
          ${msg.currentSubject ? `<span style="color:var(--green);font-size:9px">ğŸ“– ${esc(msg.currentSubject)}</span>` : ''}
          ${adminControls}
        </div>
        <div class="msg-bubble${isMuted?' muted-msg':''}" style="${isBannedMsg&&isAdmin()?'opacity:.4;border-color:var(--red)':''}">
          ${isMuted ? '<em>Message hidden (muted)</em>' : esc(msg.text)}
          <div class="msg-actions">
            ${REACTIONS.map(r=>`<button class="react-btn" onclick="addReaction('${msg.id}','${r}')" title="${r}">${r}</button>`).join('')}
          </div>
        </div>
        ${reactHtml ? `<div class="msg-reactions">${reactHtml}</div>` : ''}
      </div>`;
    el.appendChild(row);
  });

  if (wasAtBottom) scrollChatBottom();
}

function buildReactionsHtml(msgId, reactions) {
  if (!reactions || !Object.keys(reactions).length) return '';
  // Group by emoji
  const grouped = {};
  Object.entries(reactions).forEach(([userKey, emoji]) => {
    if (!grouped[emoji]) grouped[emoji] = {count:0, mine:false};
    grouped[emoji].count++;
    if (userKey === emailToKey(currentUser.email)) grouped[emoji].mine = true;
  });
  return Object.entries(grouped).map(([emoji, data]) =>
    `<div class="reaction-chip${data.mine?' mine':''}" onclick="addReaction('${msgId}','${emoji}')" title="Click to react">
      ${emoji} <span class="reaction-chip-count">${data.count}</span>
    </div>`
  ).join('');
}

function hashColor(str) {
  // Deterministic color from email string
  const colors = ['#e8a832','#68a8e8','#6fcf87','#a868e8','#e86868','#68e8c8','#e8681a','#1ae8c8'];
  let hash = 0;
  for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash<<5)-hash);
  return colors[Math.abs(hash) % colors.length];
}

/* â”€â”€ SEND MESSAGE â”€â”€ */
function sendMessage() {
  if (!firebaseReady || !db) return;
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || text.length > MAX_MSG_LENGTH) return;

  const btn = document.getElementById('sendBtn');
  btn.disabled = true;

  const name = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
  messagesRef.push({
    text,
    name,
    email: currentUser.email,
    initials: getUserInitials(name, currentUser.email),
    currentSubject: state.currentSubject || '',
    currentTopic: state.currentTopic || '',
    timestamp: firebase.database.ServerValue.TIMESTAMP,
    reactions: {}
  }).then(() => {
    input.value = '';
    input.style.height = 'auto';
    scrollChatBottom();
  }).catch(e => notify('Failed to send: '+e.message,'info'))
  .finally(() => { btn.disabled = false; input.focus(); });
}

function chatKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function scrollChatBottom() {
  const el = document.getElementById('chatMessages');
  if (el) el.scrollTop = el.scrollHeight;
}

function applyFilter() {
  chatFilter = document.getElementById('chatFilter').value;
  // Re-trigger listener which will call renderMessages
}

/* â”€â”€ REACTIONS â”€â”€ */
function addReaction(msgId, emoji) {
  if (!firebaseReady) return;
  const key = emailToKey(currentUser.email);
  const ref = messagesRef.child(`${msgId}/reactions/${key}`);
  ref.get().then(snap => {
    if (snap.exists() && snap.val() === emoji) {
      ref.remove(); // toggle off
    } else {
      ref.set(emoji);
    }
  });
}

/* â”€â”€ ONLINE USERS â”€â”€ */
function listenOnline() {
  onlineRef.on('value', snap => {
    const users = [];
    snap.forEach(child => users.push({id: child.key, ...child.val()}));
    renderOnlineUsers(users);
    document.getElementById('onlineCount').textContent = users.length + ' online';
  });
}

function renderOnlineUsers(users) {
  const el = document.getElementById('onlineUsersList');
  if (!el) return;
  if (!users.length) { el.innerHTML = '<div style="font-size:11px;color:var(--text3);font-family:var(--font-mono)">No one online yet</div>'; return; }
  el.innerHTML = users.slice(0,8).map(u => `
    <div class="online-user">
      <div class="online-av" style="background:${hashColor(u.email||'')};color:#fff">${esc(u.initials||'?')}</div>
      <div style="min-width:0">
        <div class="online-user-name">${esc(u.name||'User')}</div>
        <div class="online-user-sub">${u.currentSubject ? 'ğŸ“– '+esc(u.currentSubject) : 'Browsing'}</div>
      </div>
    </div>`).join('');
}

/* â”€â”€ LEADERBOARD â”€â”€ */
function pushLeaderboardEntry() {
  if (!firebaseReady) return;
  const now = new Date(), dow = (now.getDay()+6)%7;
  const wStart = new Date(now); wStart.setDate(now.getDate()-dow); wStart.setHours(0,0,0,0);
  const weekMins = state.sessions.filter(s=>new Date(s.date)>=wStart).reduce((a,s)=>a+s.durationMinutes,0);
  const name = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
  leaderboardRef.child(emailToKey(currentUser.email)).set({
    name, email: currentUser.email,
    initials: getUserInitials(name, currentUser.email),
    weekMins, streak: state.streak || 0,
    updatedAt: firebase.database.ServerValue.TIMESTAMP
  });
}

function listenLeaderboard() {
  leaderboardRef.orderByChild('weekMins').limitToLast(10).on('value', snap => {
    const entries = [];
    snap.forEach(child => entries.push(child.val()));
    entries.sort((a,b) => b.weekMins - a.weekMins);
    renderLeaderboard(entries);
  });
}

function renderLeaderboard(entries) {
  const el = document.getElementById('leaderboard');
  if (!el) return;
  if (!entries.length) { el.innerHTML = '<div style="font-size:11px;color:var(--text3);font-family:var(--font-mono)">No data yet</div>'; return; }
  const medals = ['gold','silver','bronze'];
  el.innerHTML = entries.slice(0,8).map((e,i) => `
    <div class="lb-row">
      <div class="lb-rank ${medals[i]||''}">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</div>
      <div class="lb-av" style="background:${hashColor(e.email||'')};color:#fff;font-size:10px">${esc(e.initials||'?')}</div>
      <div class="lb-name" title="${esc(e.email)}">${esc(e.name||'User')}</div>
      <div class="lb-mins">${fmtMinsShort(e.weekMins||0)}</div>
    </div>`).join('');
}

function refreshLoungeStats() {
  const el = document.getElementById('loungeMyStats');
  if (!el) return;
  const now = new Date(), dow = (now.getDay()+6)%7;
  const wStart = new Date(now); wStart.setDate(now.getDate()-dow); wStart.setHours(0,0,0,0);
  const weekMins = state.sessions.filter(s=>new Date(s.date)>=wStart).reduce((a,s)=>a+s.durationMinutes,0);
  el.innerHTML = `
    <div>ğŸ”¥ <strong>${state.streak||0}</strong> day streak</div>
    <div>ğŸ“š <strong>${fmtMinsShort(weekMins)}</strong> this week</div>
    <div>ğŸ¯ <strong>${state.sessions.length}</strong> total sessions</div>
    ${state.currentSubject ? `<div>ğŸ“– Studying: <strong>${esc(state.currentSubject)}</strong></div>` : ''}`;
}

/* â”€â”€ UNREAD BADGE â”€â”€ */
function showUnread() {
  unreadCount++;
  const badge = document.getElementById('unreadBadge');
  if (badge) { badge.style.display='inline'; badge.textContent = unreadCount > 9 ? '9+' : unreadCount; }
}
function clearUnread() {
  unreadCount = 0;
  const badge = document.getElementById('unreadBadge');
  if (badge) badge.style.display='none';
  loungeVisible = true;
}

/* â”€â”€ MUTE â”€â”€ */
function muteUser(email) {
  if (mutedUsers.includes(email)) return;
  if (!confirm(`Mute messages from ${email}? You can unmute in settings.`)) return;
  mutedUsers.push(email);
  localStorage.setItem('focus_muted', JSON.stringify(mutedUsers));
  notify(`${email} muted â€” refresh to apply`,'info');
}

/* â”€â”€ ADMIN â”€â”€ */
function adminDeleteMsg(msgId) {
  if (!isAdmin()) return;
  messagesRef.child(msgId).remove();
  notify('Message deleted','info');
}

function adminBanUser() {
  const email = document.getElementById('banEmailInput').value.trim();
  if (!email || !isAdmin()) return;
  adminBanUserFromMsg(email);
  document.getElementById('banEmailInput').value = '';
}

function adminBanUserFromMsg(email) {
  if (!isAdmin() || !confirm(`Ban ${email} from Study Lounge?`)) return;
  db.ref(`lounge/banned/${emailToKey(email)}`).set(true);
  // Mark their messages
  messagesRef.orderByChild('email').equalTo(email).get().then(snap => {
    snap.forEach(child => child.ref.update({banned:true}));
  });
  notify(`${email} banned`,'info');
}

function adminClearChat() {
  if (!isAdmin() || !confirm('Clear ALL chat messages? Cannot be undone.')) return;
  messagesRef.remove();
  notify('Chat cleared','info');
}

function showBanned() {
  document.getElementById('chatLoading').style.display = 'none';
  document.getElementById('bannedNotice').style.display = 'block';
  document.getElementById('chatInputArea').style.display = 'none';
}

/* â”€â”€ LOUNGE VISIBILITY TRACKING â”€â”€ */
document.addEventListener('visibilitychange', () => {
  if (document.hidden) loungeVisible = false;
});

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fmtMins(m){if(m<60)return m+'m';return Math.floor(m/60)+'h '+(m%60)+'m';}
function fmtMinsShort(m){if(m<60)return m+'m';return Math.floor(m/60)+'h';}
function fmtDate(s){if(!s)return '';try{const d=new Date(s+'T00:00:00');return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});}catch(e){return s;}}
function sEl(id,val){const e=document.getElementById(id);if(e)e.textContent=val;}
function styleEl(id,css){const e=document.getElementById(id);if(e)e.style.cssText+=';'+css;}
function openModal(id){document.getElementById(id).classList.add('active');}
function closeModal(id){document.getElementById(id).classList.remove('active');}
document.querySelectorAll('.modal-ov').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('active');}));
document.getElementById('pubProfileOv').addEventListener('click',e=>{if(e.target===document.getElementById('pubProfileOv'))closePubProfile();});
function notify(msg,type='info'){const el=document.getElementById('notif');el.textContent=msg;el.className='notif '+type+' show';clearTimeout(window._nt);window._nt=setTimeout(()=>el.classList.remove('show'),3200);}

/* â”€â”€â”€ REFRESH ALL â”€â”€â”€ */
function refreshAll(){refreshSubjectDrops();refreshDashboard();refreshTasks();refreshSubjects();refreshExams();refreshLinks();refreshLog();refreshWeekPlanner();renderNotes();sEl('streakNum',state.streak||0);}
function refreshSubjectDrops(){['curSubject','qaSubj','t_subj','ml_subject','sm_subject','note_subj'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML=`<option value="">Subjectâ€¦</option>`+state.subjects.map(s=>`<option value="${esc(s.name)}"${s.name===cur?' selected':''}>${esc(s.name)}</option>`).join('');});}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT APP â€” only runs after auth confirmed
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initApp(){
  // Hide gate, show app
  document.getElementById('authGate').style.display='none';
  document.getElementById('appWrapper').style.display='flex';

  // Load user-specific state
  loadState();

  // Theme
  const saved=localStorage.getItem('focusTheme_v4')||'dark';
  setTheme(saved); themeIdx=themes.indexOf(saved); if(themeIdx<0)themeIdx=0;

  // User UI
  const name=currentUser.user_metadata?.full_name||currentUser.email.split('@')[0];
  const initials=getUserInitials(name,currentUser.email);
  sEl('userAvatar',initials);sEl('userName',name);
  sEl('userEmailFull',currentUser.email);
  sEl('sidebarEmail',currentUser.email);

  // Quote
  const qs=document.getElementById('quoteStrip');if(qs)qs.textContent='"'+QUOTES[quoteIdx]+'"';

  // Timer default
  setMode('p25',document.querySelector('.mode-btn'));

  // Restore last subject
  if(state.lastSubject)setTimeout(()=>{const s=document.getElementById('curSubject');if(s)s.value=state.lastSubject;},100);

  refreshAll();checkCrash();
  updatePublicData();
  // Load muted users from localStorage
  mutedUsers = JSON.parse(localStorage.getItem('focus_muted')||'[]');
  // Init Firebase chat
  initFirebase();

  // Close sidebar on mobile click outside
  document.addEventListener('click',e=>{const sb=document.getElementById('sidebar');if(window.innerWidth<=900&&sb.classList.contains('open')&&!sb.contains(e.target)&&!e.target.closest('.hamburger'))sb.classList.remove('open');});
}
</script>
</body>
</html>
