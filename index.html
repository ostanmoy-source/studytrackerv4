<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Focus v4 â€” Personal Study Tracker</title>
<link rel="icon" type="image/png" href="https://image2url.com/r2/default/images/1771818142936-9b1a8720-b73c-4610-ab72-d509d850c752.ico">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES (same as your v4)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#0e0d0b; --bg2:#161512; --bg3:#1e1c19; --bg4:#252320;
  --border:#2e2c28; --text:#f0ead8; --text2:#a09880; --text3:#5a5548;
  --accent:#e8a832; --accent2:#c47f15;
  --accent-dim:rgba(232,168,50,0.12); --accent-glow:rgba(232,168,50,0.25);
  --green:#6fcf87; --red:#e86868; --blue:#68a8e8; --purple:#a868e8; --teal:#68e8c8;
  --radius:12px; --radius-sm:8px;
  --shadow:0 4px 24px rgba(0,0,0,0.4); --shadow-lg:0 8px 48px rgba(0,0,0,0.6);
  --transition:0.2s ease;
  --font-display:'DM Serif Display',serif;
  --font-body:'DM Sans',sans-serif;
  --font-mono:'DM Mono',monospace;
}
[data-theme="light"]{
  --bg:#f8f4ec; --bg2:#f0ead8; --bg3:#e8e0cc; --bg4:#ddd5be;
  --border:#d0c8b0; --text:#1a1810; --text2:#5a5040; --text3:#a09070;
  --accent:#c47f15; --accent2:#a06810;
  --accent-dim:rgba(196,127,21,0.12); --accent-glow:rgba(196,127,21,0.25);
  --shadow:0 4px 24px rgba(0,0,0,0.12); --shadow-lg:0 8px 48px rgba(0,0,0,0.2);
}
[data-theme="dim"]{
  --bg:#070707; --bg2:#0c0c0c; --bg3:#111111; --bg4:#161616;
  --border:#1f1f1f; --text:#c8c0a8; --text2:#706858; --text3:#3a3830;
  --accent:#c8881a; --accent2:#a06810;
  --accent-dim:rgba(200,136,26,0.1); --accent-glow:rgba(200,136,26,0.2);
  --shadow:0 4px 24px rgba(0,0,0,0.7); --shadow-lg:0 8px 48px rgba(0,0,0,0.9);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BASE (same as your v4)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;transition:background .3s,color .3s}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.35}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT (same as your v4)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-wrapper{display:flex;min-height:100vh}
.sidebar{width:224px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:100;transition:transform .3s ease}
.sidebar-logo{padding:22px 20px 18px;border-bottom:1px solid var(--border)}
.sidebar-logo h1{font-family:var(--font-display);font-size:22px;color:var(--accent);letter-spacing:-.5px}
.sidebar-logo span{font-family:var(--font-mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:2px}
.sidebar-nav{flex:1;padding:14px 0;overflow-y:auto}
.nav-section{padding:0 10px;margin-bottom:6px}
.nav-label{font-family:var(--font-mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;padding:5px 8px;margin-bottom:2px}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:var(--radius-sm);cursor:pointer;color:var(--text2);font-size:13.5px;font-weight:400;transition:all var(--transition);user-select:none;border:none;background:none;width:100%;text-align:left}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.active{background:var(--accent-dim);color:var(--accent);font-weight:500}
.nav-icon{font-size:15px;min-width:18px;text-align:center}
.sidebar-bottom{padding:14px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
.streak-badge{display:flex;align-items:center;gap:5px;font-family:var(--font-mono);font-size:12px;color:var(--accent)}
.streak-num{font-size:18px;font-weight:500}

/* Profile selector */
.profile-bar{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.profile-select{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:var(--font-body);font-size:12px;padding:5px 8px;outline:none;cursor:pointer}
.profile-add{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-size:12px;padding:5px 8px;cursor:pointer;transition:all var(--transition)}
.profile-add:hover{color:var(--accent);border-color:var(--accent)}

.main{margin-left:224px;flex:1;padding:28px 32px;max-width:calc(100vw - 224px)}
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:10px}
.topbar-left{display:flex;align-items:center;gap:14px}
.page-title{font-family:var(--font-display);font-size:26px;color:var(--text)}
.topbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.flip-clock{font-family:var(--font-mono);font-size:13px;color:var(--text2);background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:5px 11px;letter-spacing:1px}
.page-section{display:none}
.page-section.active{display:block}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS & GRID (same as your v4)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:border-color var(--transition)}
.card:hover{border-color:var(--text3)}
.card-title{font-family:var(--font-mono);font-size:10.5px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:13px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.grid-auto{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:14px}
.mb{margin-bottom:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS, INPUTS, TIMER, etc (same as your v4)
   (I'm truncating for brevity - keep all your existing CSS here)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* ... keep all your existing CSS from v4 here ... */

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH â€” LOGIN SCREEN (same as your v4)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#authScreen{position:fixed;inset:0;background:var(--bg);z-index:9000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0}
#authScreen.hidden{display:none}
.auth-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:40px 36px;width:100%;max-width:380px;text-align:center;box-shadow:var(--shadow-lg)}
.auth-logo{font-family:var(--font-display);font-size:28px;color:var(--accent);margin-bottom:6px}
.auth-sub{font-family:var(--font-mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:2px;margin-bottom:32px}
.auth-btn{width:100%;padding:12px;border-radius:100px;border:none;font-family:var(--font-body);font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px}
.auth-btn-primary{background:var(--accent);color:#0e0d0b}
.auth-btn-primary:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 14px var(--accent-glow)}
.auth-btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text2)}
.auth-btn-ghost:hover{border-color:var(--text2);color:var(--text)}
.auth-divider{display:flex;align-items:center;gap:10px;margin:16px 0;color:var(--text3);font-family:var(--font-mono);font-size:10px}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.auth-footer{font-size:11px;color:var(--text3);margin-top:20px;line-height:1.7}

/* User bar in sidebar */
.user-bar{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:9px;min-height:52px}
.user-avatar{width:30px;height:30px;border-radius:50%;background:var(--accent-dim);border:1px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;color:var(--accent);flex-shrink:0;font-family:var(--font-mono)}
.user-info{flex:1;min-width:0}
.user-name{font-size:12px;color:var(--text);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-email{font-family:var(--font-mono);font-size:9px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-logout{background:none;border:none;color:var(--text3);font-size:11px;cursor:pointer;padding:3px 6px;border-radius:4px;transition:all .2s;flex-shrink:0;font-family:var(--font-mono)}
.user-logout:hover{color:var(--red);background:rgba(232,104,104,.1)}

/* Loading overlay (NEW - fixes black screen) */
#loadingOverlay {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 9500;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 20px;
}
#loadingOverlay.active {
  display: flex;
}
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--bg3);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.loading-text {
  font-family: var(--font-mono);
  color: var(--text3);
  font-size: 13px;
}
</style>
</head>
<body>

<!-- â•â• LOADING OVERLAY (NEW) â•â• -->
<div id="loadingOverlay" class="active">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading Focus v4...</div>
</div>

<!-- â•â• AUTH SCREEN â•â• -->
<div id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">Focus</div>
    <div class="auth-sub">Study Tracker v4</div>

    <button class="auth-btn auth-btn-primary" onclick="netlifyIdentity.open('login')">
      ğŸ” Log In
    </button>
    <button class="auth-btn auth-btn-ghost" onclick="netlifyIdentity.open('signup')">
      âœ¦ Create Account
    </button>

    <div class="auth-divider">or continue as guest</div>
    <button class="auth-btn auth-btn-ghost" onclick="enterAsGuest()">
      ğŸ‘¤ Guest Mode (local only)
    </button>

    <div class="auth-footer">
      Your data is saved per account.<br>
      Log in on any device to access your sessions.
    </div>
  </div>
</div>

<!-- â”€â”€ NOTIFICATION â”€â”€ -->
<div class="notif" id="notif"></div>

<!-- â”€â”€ KBD HUD â”€â”€ -->
<div class="kbd-hud" id="kbdHud">
  <kbd>Space</kbd> Start/Pause &nbsp;
  <kbd>S</kbd> Stop &nbsp;
  <kbd>Z</kbd> Zen &nbsp;
  <kbd>M</kbd> Manual Log &nbsp;
  <kbd>?</kbd> Hide
</div>

<!-- â”€â”€ ZEN MODE â”€â”€ -->
<div class="zen-ov" id="zenOv">
  <div class="zen-time" id="zenClock"></div>
  <div class="timer-display" id="zenTimer">00:00</div>
  <div class="timer-phase" id="zenPhase">FOCUS</div>
  <div class="timer-bar" style="max-width:340px"><div class="timer-bar-fill" id="zenBar" style="width:100%"></div></div>
  <div class="zen-task" id="zenTask">No task set</div>
  <div class="timer-controls">
    <button class="btn btn-secondary" onclick="toggleTimer()"><span id="zenIcon">â–¶</span> <span id="zenLbl">Start</span></button>
    <button class="btn btn-ghost" onclick="stopTimer()">Stop</button>
  </div>
  <div class="zen-exit"><button class="btn btn-ghost btn-sm" onclick="toggleZen()">âœ• Exit Zen</button></div>
</div>

<!-- â”€â”€ SESSION COMPLETE MODAL â”€â”€ -->
<div class="modal-ov" id="sessionModal">
  <div class="modal">
    <div class="modal-title">ğŸ‰ Session Complete!</div>
    <div class="form-group">
      <label class="form-label">Subject</label>
      <select class="inp" id="sm_subject" style="cursor:pointer"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Topic</label>
      <input type="text" class="inp" id="sm_topic" placeholder="What did you study?">
    </div>
    <div class="form-group">
      <label class="form-label">Session Type</label>
      <select class="inp" id="sm_type" style="cursor:pointer">
        <option value="General">General</option>
        <option value="Active Recall">Active Recall</option>
        <option value="Reading">Reading</option>
        <option value="Problem Solving">Problem Solving</option>
        <option value="Revision">Revision</option>
        <option value="Lecture">Lecture</option>
        <option value="Writing">Writing</option>
        <option value="Research">Research</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Focus Rating</label>
      <div class="rating-row" id="sm_focus">
        <div class="r-btn" onclick="rate('focus',1)">1</div>
        <div class="r-btn" onclick="rate('focus',2)">2</div>
        <div class="r-btn sel" onclick="rate('focus',3)">3</div>
        <div class="r-btn" onclick="rate('focus',4)">4</div>
        <div class="r-btn" onclick="rate('focus',5)">5</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Energy Level</label>
      <div class="rating-row" id="sm_energy">
        <div class="r-btn" onclick="rate('energy',1)">1</div>
        <div class="r-btn" onclick="rate('energy',2)">2</div>
        <div class="r-btn sel" onclick="rate('energy',3)">3</div>
        <div class="r-btn" onclick="rate('energy',4)">4</div>
        <div class="r-btn" onclick="rate('energy',5)">5</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <input type="text" class="inp" id="sm_notes" placeholder="Quick reflectionâ€¦">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="saveSession(true)">Skip (auto-save)</button>
      <button class="btn btn-primary" onclick="saveSession(false)">Log Session âœ“</button>
    </div>
  </div>
</div>

<!-- â”€â”€ MANUAL LOG MODAL â”€â”€ -->
<div class="modal-ov" id="manualModal">
  <div class="modal">
    <div class="modal-title">â• Add Manual Session</div>
    <div class="form-group">
      <label class="form-label">Date</label>
      <input type="date" class="inp" id="ml_date">
    </div>
    <div class="form-group">
      <label class="form-label">Subject</label>
      <select class="inp" id="ml_subject" style="cursor:pointer"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Topic</label>
      <input type="text" class="inp" id="ml_topic" placeholder="Topic studied">
    </div>
    <div class="form-group">
      <label class="form-label">Duration (minutes)</label>
      <input type="number" class="inp" id="ml_duration" placeholder="60" min="1">
    </div>
    <div class="form-group">
      <label class="form-label">Session Type</label>
      <select class="inp" id="ml_type" style="cursor:pointer">
        <option>General</option><option>Active Recall</option><option>Reading</option>
        <option>Problem Solving</option><option>Revision</option><option>Lecture</option>
        <option>Writing</option><option>Research</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Focus Rating</label>
      <div class="rating-row" id="ml_focus">
        <div class="r-btn" onclick="rateML('focus',1)">1</div>
        <div class="r-btn" onclick="rateML('focus',2)">2</div>
        <div class="r-btn sel" onclick="rateML('focus',3)">3</div>
        <div class="r-btn" onclick="rateML('focus',4)">4</div>
        <div class="r-btn" onclick="rateML('focus',5)">5</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <input type="text" class="inp" id="ml_notes" placeholder="Optional notes">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('manualModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveManualSession()">Add Session</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ADD SUBJECT MODAL â”€â”€ -->
<div class="modal-ov" id="addSubjectModal">
  <div class="modal">
    <div class="modal-title">Add Subject</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="inp" id="ns_name" placeholder="e.g. Mathematics"></div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div style="display:flex;gap:7px;flex-wrap:wrap" id="colorPick">
        <div class="r-btn" style="background:#e8a832;border-color:#e8a832;color:#0e0d0b;cursor:pointer" onclick="pickColor('#e8a832',this)">â—</div>
        <div class="r-btn" style="background:#68a8e8;border-color:#68a8e8;color:#0e0d0b;cursor:pointer" onclick="pickColor('#68a8e8',this)">â—</div>
        <div class="r-btn" style="background:#6fcf87;border-color:#6fcf87;color:#0e0d0b;cursor:pointer" onclick="pickColor('#6fcf87',this)">â—</div>
        <div class="r-btn" style="background:#a868e8;border-color:#a868e8;color:#0e0d0b;cursor:pointer" onclick="pickColor('#a868e8',this)">â—</div>
        <div class="r-btn" style="background:#e86868;border-color:#e86868;color:#0e0d0b;cursor:pointer" onclick="pickColor('#e86868',this)">â—</div>
        <div class="r-btn" style="background:#68e8c8;border-color:#68e8c8;color:#0e0d0b;cursor:pointer" onclick="pickColor('#68e8c8',this)">â—</div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addSubjectModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSubject()">Add</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ADD EXAM MODAL â”€â”€ -->
<div class="modal-ov" id="addExamModal">
  <div class="modal">
    <div class="modal-title">Add Exam / Deadline</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="inp" id="ne_name" placeholder="e.g. Physics Final"></div>
    <div class="form-group"><label class="form-label">Date</label><input type="date" class="inp" id="ne_date"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addExamModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExam()">Add</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ADD LINK MODAL â”€â”€ -->
<div class="modal-ov" id="addLinkModal">
  <div class="modal">
    <div class="modal-title">Add Quick Link</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="inp" id="nl_name" placeholder="Lecture Notes"></div>
    <div class="form-group"><label class="form-label">URL</label><input type="url" class="inp" id="nl_url" placeholder="https://..."></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addLinkModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveLink()">Add</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ADD PROFILE MODAL â”€â”€ -->
<div class="modal-ov" id="addProfileModal">
  <div class="modal">
    <div class="modal-title">New Profile</div>
    <div class="form-group"><label class="form-label">Profile Name</label><input type="text" class="inp" id="np_name" placeholder="e.g. Exam Mode"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addProfileModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProfile()">Create</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP WRAPPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-wrapper">

  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <h1>Focus</h1>
      <span>Study Tracker v4</span>
    </div>

    <!-- User bar (shown when logged in) -->
    <div class="user-bar" id="userBar" style="display:none">
      <div class="user-avatar" id="userAvatar">?</div>
      <div class="user-info">
        <div class="user-name" id="userName">â€”</div>
        <div class="user-email" id="userEmail">â€”</div>
      </div>
      <button class="user-logout" onclick="logOut()" title="Log out">â†©</button>
    </div>

    <!-- Profile bar -->
    <div class="profile-bar">
      <select class="profile-select" id="profileSelect" onchange="switchProfile(this.value)"></select>
      <button class="profile-add" onclick="openModal('addProfileModal')" title="New profile">ï¼‹</button>
    </div>

    <div class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-label">Main</div>
        <button class="nav-item active" onclick="nav('dashboard',this)"><span class="nav-icon">âš¡</span>Dashboard</button>
        <button class="nav-item" onclick="nav('log',this)"><span class="nav-icon">ğŸ“‹</span>Study Log</button>
        <button class="nav-item" onclick="nav('tasks',this)"><span class="nav-icon">âœ…</span>Tasks</button>
        <button class="nav-item" onclick="nav('notes',this)"><span class="nav-icon">ğŸ“</span>Notes</button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Insights</div>
        <button class="nav-item" onclick="nav('analytics',this)"><span class="nav-icon">ğŸ“Š</span>Analytics</button>
        <button class="nav-item" onclick="nav('heatmap',this)"><span class="nav-icon">ğŸ—“</span>Calendar</button>
        <button class="nav-item" onclick="nav('badges',this)"><span class="nav-icon">ğŸ†</span>Badges</button>
        <button class="nav-item" onclick="nav('subjects',this)"><span class="nav-icon">ğŸ“š</span>Subjects</button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Plan</div>
        <button class="nav-item" onclick="nav('planner',this)"><span class="nav-icon">ğŸ“…</span>Planner</button>
        <button class="nav-item" onclick="nav('goals',this)"><span class="nav-icon">ğŸ¯</span>Goals</button>
        <button class="nav-item" onclick="nav('focus',this)"><span class="nav-icon">ğŸ§˜</span>Focus Tools</button>
        <button class="nav-item" onclick="nav('settings',this)"><span class="nav-icon">âš™</span>Settings</button>
      </div>
    </div>

    <div class="sidebar-bottom">
      <div class="streak-badge">ğŸ”¥<span class="streak-num" id="streakNum">0</span><span style="font-size:10px;color:var(--text3)">days</span></div>
      <div style="display:flex;gap:6px">
        <button class="btn-icon" onclick="cycleTheme()" title="Theme" id="themeBtn">â˜€</button>
        <button class="btn-icon" onclick="openModal('manualModal')" title="Manual log (M)">âœ</button>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
        <div class="page-title" id="pageTitle">Dashboard</div>
      </div>
      <div class="topbar-right">
        <div class="flip-clock" id="topClock">00:00:00</div>
        <button class="btn btn-ghost btn-sm" onclick="toggleZen()">ğŸ§˜ Zen</button>
        <button class="btn btn-ghost btn-sm" onclick="exportCSV()">â†“ CSV</button>
        <button class="btn btn-ghost btn-sm" onclick="exportJSON()">â†“ JSON</button>
      </div>
    </div>

    <!-- crash recovery banner -->
    <div class="recovery-banner" id="recoveryBanner" style="display:none">
      âš¡ Unsaved session detected from last visit.
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary btn-sm" onclick="restoreCrash()">Restore</button>
        <button class="btn btn-ghost btn-sm" onclick="dismissCrash()">Dismiss</button>
      </div>
    </div>

    <!-- â•â• DASHBOARD â•â• (keep all your existing page sections) -->
    <section class="page-section active fade-in" id="page-dashboard">
      <!-- ... your existing dashboard HTML ... -->
    </section>

    <!-- â•â• STUDY LOG â•â• -->
    <section class="page-section fade-in" id="page-log">
      <!-- ... your existing log HTML ... -->
    </section>

    <!-- â•â• TASKS â•â• -->
    <section class="page-section fade-in" id="page-tasks">
      <!-- ... your existing tasks HTML ... -->
    </section>

    <!-- â•â• NOTES â•â• -->
    <section class="page-section fade-in" id="page-notes">
      <!-- ... your existing notes HTML ... -->
    </section>

    <!-- â•â• ANALYTICS â•â• -->
    <section class="page-section fade-in" id="page-analytics">
      <!-- ... your existing analytics HTML ... -->
    </section>

    <!-- â•â• HEATMAP â•â• -->
    <section class="page-section fade-in" id="page-heatmap">
      <!-- ... your existing heatmap HTML ... -->
    </section>

    <!-- â•â• BADGES â•â• -->
    <section class="page-section fade-in" id="page-badges">
      <!-- ... your existing badges HTML ... -->
    </section>

    <!-- â•â• SUBJECTS â•â• -->
    <section class="page-section fade-in" id="page-subjects">
      <!-- ... your existing subjects HTML ... -->
    </section>

    <!-- â•â• PLANNER â•â• -->
    <section class="page-section fade-in" id="page-planner">
      <!-- ... your existing planner HTML ... -->
    </section>

    <!-- â•â• GOALS â•â• -->
    <section class="page-section fade-in" id="page-goals">
      <!-- ... your existing goals HTML ... -->
    </section>

    <!-- â•â• FOCUS TOOLS â•â• -->
    <section class="page-section fade-in" id="page-focus">
      <!-- ... your existing focus tools HTML ... -->
    </section>

    <!-- â•â• SETTINGS â•â• -->
    <section class="page-section fade-in" id="page-settings">
      <!-- ... your existing settings HTML ... -->
    </section>

  </main>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE - FIXED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// FIXED: Added missing storageKey declaration
let storageKey = 'focus_v3_guest';
let currentUser = null;
let profiles = {};
let currentProfile = 'Default';

function profileData() { return profiles[currentProfile]; }
function pd() { return profiles[currentProfile]; }

function blankProfile() {
  return {
    sessions: [], tasks: [], subjects: [], exams: [], links: [], notes: [],
    goals: { daily: 120, weekly: 600 },
    settings: { customFocus: 45, customBreak: 10 },
    streak: 0, lastStudyDate: null
  };
}

// FIXED: loadState now uses storageKey correctly
function loadState() {
  try {
    const raw = localStorage.getItem(storageKey);
    if (raw) {
      const d = JSON.parse(raw);
      profiles = d.profiles || { Default: blankProfile() };
      currentProfile = d.currentProfile || 'Default';
      if (!profiles[currentProfile]) profiles[currentProfile] = blankProfile();
    } else {
      profiles = { Default: blankProfile() };
      currentProfile = 'Default';
    }
  } catch(e) { 
    console.error('Error loading state:', e);
    profiles = { Default: blankProfile() }; 
  }
}

// FIXED: saveState now uses storageKey correctly
function saveState() {
  try {
    localStorage.setItem(storageKey, JSON.stringify({ profiles, currentProfile }));
  } catch(e) {
    console.error('Error saving state:', e);
  }
}

// Crash recovery
let crashData = null;
function saveCrash() {
  if (!tmr.running) return;
  const d = {
    subject: document.getElementById('curSubject')?.value || '',
    topic: document.getElementById('curTopic')?.value || '',
    type: document.getElementById('curType')?.value || 'General',
    startTime: tmr.sessionStart ? tmr.sessionStart.toISOString() : new Date().toISOString(),
    elapsed: tmr.elapsed,
    profile: currentProfile
  };
  localStorage.setItem(storageKey + '_crash', JSON.stringify(d));
}

function checkCrash() {
  const raw = localStorage.getItem(storageKey + '_crash');
  if (!raw) return;
  try {
    crashData = JSON.parse(raw);
    document.getElementById('recoveryBanner').style.display = 'flex';
  } catch(e) {}
}

function restoreCrash() {
  if (!crashData) return;
  const mins = Math.floor(crashData.elapsed / 60);
  if (mins < 1) { dismissCrash(); return; }
  pendS.durationMinutes = mins;
  pendS.subject = crashData.subject;
  pendS.topic = crashData.topic;
  pendS.type = crashData.type;
  pendS.startTime = crashData.startTime;
  document.getElementById('sm_subject').value = crashData.subject || '';
  document.getElementById('sm_topic').value = crashData.topic || '';
  openModal('sessionModal');
  dismissCrash();
}

function dismissCrash() {
  localStorage.removeItem(storageKey + '_crash');
  document.getElementById('recoveryBanner').style.display = 'none';
  crashData = null;
}

setInterval(saveCrash, 30000);
window.addEventListener('beforeunload', saveCrash);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER (keep all your existing timer code)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tmr = {
  mode: 'p25', phase: 'focus',
  running: false, paused: false,
  elapsed: 0, total: 25*60,
  interval: null, sessionStart: null,
  pomoCount: 0
};

let pendS = { focusRating: 3, energyRating: 3 };
let mlRatings = { focus: 3, energy: 3 };

const MODES = { p25:{focus:25,brk:5}, p50:{focus:50,brk:10} };

// ... keep ALL your existing timer functions (setMode, toggleTimer, tick, etc) here ...

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NETLIFY IDENTITY â€” AUTH (FIXED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getStorageKey(user) {
  if (!user) return 'focus_v3_guest';
  // Create a safe key from email
  const emailHash = btoa(user.email).replace(/[^a-z0-9]/gi, '').substring(0, 24);
  return 'focus_v3_' + emailHash;
}

function showApp() {
  document.getElementById('loadingOverlay').classList.remove('active');
  document.getElementById('authScreen').classList.add('hidden');
}

function onLogin(user) {
  console.log('User logged in:', user.email);
  currentUser = user;
  storageKey = getStorageKey(user);

  // Update user bar
  const name = user.user_metadata?.full_name || user.email.split('@')[0];
  const initials = name.split(' ').map(p => p[0]).join('').toUpperCase().substring(0, 2);
  document.getElementById('userAvatar').textContent = initials || '?';
  document.getElementById('userName').textContent = name;
  document.getElementById('userEmail').textContent = user.email;
  document.getElementById('userBar').style.display = 'flex';

  // Load this user's data
  loadState();
  
  // Setup theme and UI
  const savedTheme = localStorage.getItem('focusTheme') || 'dark';
  setTheme(savedTheme);
  themeIdx = themes.indexOf(savedTheme);
  if (themeIdx < 0) themeIdx = 0;
  
  const qs = document.getElementById('quoteStrip');
  if (qs) qs.textContent = '"' + QUOTES[quoteIdx] + '"';
  
  setMode('p25');
  
  // Restore last subject if any
  if (pd().lastSubject) {
    setTimeout(() => { 
      const s = document.getElementById('curSubject'); 
      if (s) s.value = pd().lastSubject; 
    }, 100);
  }
  
  refreshAll();
  checkCrash();
  showApp();
  notify(`Welcome back, ${name}! ğŸ‘‹`, 'success');
}

function onLogout() {
  console.log('User logged out');
  currentUser = null;
  storageKey = 'focus_v3_guest';
  document.getElementById('userBar').style.display = 'none';
  document.getElementById('authScreen').classList.remove('hidden');
  
  // Stop timer if running
  if (tmr.running) { 
    clearInterval(tmr.interval); 
    tmr.interval = null; 
    tmr.running = false; 
  }
  
  // Load guest data
  loadState();
  refreshAll();
}

function logOut() {
  netlifyIdentity.logout();
}

function enterAsGuest() {
  console.log('Entering as guest');
  currentUser = null;
  storageKey = 'focus_v3_guest';
  document.getElementById('userBar').style.display = 'none';
  
  loadState();
  
  const savedTheme = localStorage.getItem('focusTheme') || 'dark';
  setTheme(savedTheme);
  themeIdx = themes.indexOf(savedTheme);
  if (themeIdx < 0) themeIdx = 0;
  
  const qs = document.getElementById('quoteStrip');
  if (qs) qs.textContent = '"' + QUOTES[quoteIdx] + '"';
  
  setMode('p25');
  
  if (pd().lastSubject) {
    setTimeout(() => { 
      const s = document.getElementById('curSubject'); 
      if (s) s.value = pd().lastSubject; 
    }, 100);
  }
  
  refreshAll();
  checkCrash();
  showApp();
  notify('Running in guest mode â€” data is local only.', 'info');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME (keep your existing theme code)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const themes = ['dark','dim','light'];
let themeIdx = 0;

function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('focusTheme', t);
  const icons = { dark:'ğŸŒ‘', dim:'ğŸŒ˜', light:'â˜€' };
  document.getElementById('themeBtn').textContent = icons[t] || 'â˜€';
}

function cycleTheme() {
  themeIdx = (themeIdx+1) % themes.length;
  setTheme(themes[themeIdx]);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUOTES & CLOCK (keep your existing)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QUOTES = [
  "The secret of getting ahead is getting started.",
  "It always seems impossible until it's done.",
  "Focus on being productive instead of busy.",
  "One step at a time is all it takes.",
  "You don't have to be great to start, but you have to start to be great.",
  "Study hard, for the well is deep, and our brains are shallow.",
  "The more that you read, the more things you will know.",
  "Education is the passport to the future.",
  "An investment in knowledge pays the best interest.",
  "The beautiful thing about learning is that no one can take it away from you.",
  "Push yourself, because no one else is going to do it for you.",
  "Great things never come from comfort zones.",
  "Dream it. Wish it. Do it.",
];
let quoteIdx = Math.floor(Math.random() * QUOTES.length);

function updateClock() {
  const n = new Date();
  const t = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;
  const el = document.getElementById('topClock'); if (el) el.textContent = t;
  const ze = document.getElementById('zenClock'); if (ze) ze.textContent = t;
}

function rotateQuote() {
  quoteIdx = (quoteIdx+1) % QUOTES.length;
  const el = document.getElementById('quoteStrip');
  if (el) { 
    el.style.opacity='0'; 
    setTimeout(()=>{ 
      el.textContent='"'+QUOTES[quoteIdx]+'"'; 
      el.style.opacity='1'; 
    },400);
  }
}

setInterval(updateClock, 1000);
setInterval(rotateQuote, 30000);
updateClock();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REFRESH FUNCTIONS (placeholders - keep your existing ones)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function refreshAll() {
  // Keep your existing refreshAll implementation
  console.log('Refreshing all...');
  // ... your existing refresh code ...
}

function refreshSubjectDrops() {
  // ... your existing code ...
}

function refreshDashboard() {
  // ... your existing code ...
}

function refreshTasks() {
  // ... your existing code ...
}

function refreshSubjects() {
  // ... your existing code ...
}

function refreshExams() {
  // ... your existing code ...
}

function refreshLinks() {
  // ... your existing code ...
}

function refreshLog() {
  // ... your existing code ...
}

function refreshWeekPlanner() {
  // ... your existing code ...
}

function renderProfileSelect() {
  // ... your existing code ...
}

function renderNotes() {
  // ... your existing code ...
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION (keep your existing)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PAGE_TITLES = {
  dashboard:'Dashboard', log:'Study Log', tasks:'Tasks', notes:'Notes',
  analytics:'Analytics', heatmap:'Calendar', badges:'Badges', subjects:'Subjects',
  planner:'Planner', goals:'Goals', focus:'Focus Tools', settings:'Settings'
};

function nav(page, btn) {
  document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  if (btn) btn.classList.add('active');
  document.getElementById('pageTitle').textContent = PAGE_TITLES[page]||page;
  if (window.innerWidth<=900) document.getElementById('sidebar').classList.remove('open');

  // Lazy refresh
  if (page==='analytics') setTimeout(refreshAnalytics,50);
  if (page==='heatmap') { refreshHeatmap(); }
  if (page==='badges') renderBadges();
  if (page==='goals') {
    document.getElementById('g_daily').value = pd().goals.daily||120;
    document.getElementById('g_weekly').value = pd().goals.weekly||600;
  }
  if (page==='settings') {
    document.getElementById('s_focus').value = pd().settings.customFocus||45;
    document.getElementById('s_break').value = pd().settings.customBreak||10;
  }
  if (page==='notes') renderNotes();
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPER FUNCTIONS (keep your existing)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtMins(m) { if(m<60) return m+'m'; return Math.floor(m/60)+'h '+(m%60)+'m'; }
function fmtMinsShort(m) { if(m<60) return m+'m'; return Math.floor(m/60)+'h'; }
function fmtDate(s) { if(!s) return ''; try { const d=new Date(s+'T00:00:00'); return d.toLocaleDateString('en-US',{month:'short',day:'numeric'}); } catch(e){return s;} }
function sEl(id, val) { const e=document.getElementById(id); if(e) e.textContent=val; }
function styleEl(id, css) { const e=document.getElementById(id); if(e) e.style.cssText+= ';'+css; }
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

document.querySelectorAll('.modal-ov').forEach(m=>m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('active'); }));

function notify(msg, type='info') {
  const el=document.getElementById('notif');
  el.textContent=msg; el.className='notif '+type+' show';
  clearTimeout(window._notifT);
  window._notifT = setTimeout(()=>el.classList.remove('show'),3200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT/IMPORT (keep your existing)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportCSV() {
  const rows = [['Date','Subject','Topic','Type','Duration','Focus','Energy','Productive','Notes','Manual']];
  pd().sessions.forEach(s => rows.push([s.date,s.subject,s.topic,s.type||'General',s.durationMinutes,s.focusRating,s.energyRating,s.productiveMinutes,s.notes,s.manual?'yes':'no']));
  dl('focus-sessions.csv', rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n'), 'text/csv');
}

function exportJSON() { dl('focus-data.json', JSON.stringify({profiles,currentProfile},null,2),'application/json'); }

function importJSON(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const d = JSON.parse(ev.target.result);
      if (d.profiles) { profiles = d.profiles; currentProfile = d.currentProfile||Object.keys(d.profiles)[0]; }
      else if (d.sessions) { pd().sessions = d.sessions; }
      saveState(); refreshAll();
      notify('Data imported successfully!', 'success');
    } catch(err) { notify('Import failed: invalid JSON', 'info'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function dl(name, content, type) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content],{type}));
  a.download = name; a.click();
}

function clearAll() {
  if (!confirm('Clear ALL data for current profile? Cannot be undone.')) return;
  profiles[currentProfile] = blankProfile();
  saveState(); refreshAll();
  notify('Profile data cleared.', 'info');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANALYTICS & CHARTS (placeholders - keep your existing)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let charts = {};

function refreshAnalytics() {
  // ... your existing analytics code ...
}

function rebuildChart(id, type, data, options) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
  const canvas = document.getElementById(id);
  if (!canvas) return;
  charts[id] = new Chart(canvas.getContext('2d'), { type, data, options });
}

function chartOpts() {
  return {
    responsive: true, maintainAspectRatio: true,
    plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1e1c19', titleColor: '#f0ead8', bodyColor: '#a09880', borderColor: '#2e2c28', borderWidth: 1 } },
    scales: { y: axisS(), x: axisS(true) }
  };
}

function axisS(x=false) {
  return { grid:{ color:'rgba(90,85,72,.15)', drawBorder:false }, ticks:{ color:'#5a5548', font:{ family:'DM Mono', size:9 } }, border:{ display:false } };
}

function refreshHeatmap() {
  // ... your existing heatmap code ...
}

function renderBadges() {
  // ... your existing badges code ...
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT - FIXED with timeout fallback
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function init() {
  console.log('Initializing app...');
  
  // Set theme immediately
  const saved = localStorage.getItem('focusTheme') || 'dark';
  setTheme(saved);
  themeIdx = themes.indexOf(saved);
  if (themeIdx < 0) themeIdx = 0;

  setMode('p25');

  // Close sidebar on mobile when clicking outside
  document.addEventListener('click', e => {
    const sb = document.getElementById('sidebar');
    if (window.innerWidth <= 900 && sb.classList.contains('open') && !sb.contains(e.target) && !e.target.closest('.hamburger')) {
      sb.classList.remove('open');
    }
  });

  // FIXED: Add timeout fallback for Netlify Identity
  const authTimeout = setTimeout(() => {
    console.log('Auth timeout - falling back to guest mode');
    if (!currentUser && document.getElementById('authScreen') && !document.getElementById('authScreen').classList.contains('hidden')) {
      enterAsGuest();
    }
  }, 5000);

  // Initialize Netlify Identity
  try {
    netlifyIdentity.on('init', user => {
      clearTimeout(authTimeout);
      console.log('Netlify Identity initialized', user ? 'with user' : 'without user');
      if (user) {
        onLogin(user);
      } else {
        // Still show auth screen (don't auto-enter guest)
        document.getElementById('loadingOverlay').classList.remove('active');
      }
    });

    netlifyIdentity.on('login', user => {
      clearTimeout(authTimeout);
      onLogin(user);
    });

    netlifyIdentity.on('logout', () => {
      onLogout();
    });

    netlifyIdentity.on('error', err => {
      console.error('Netlify Identity error:', err);
      clearTimeout(authTimeout);
      // Fallback to guest on error
      enterAsGuest();
    });

    netlifyIdentity.init();
  } catch (e) {
    console.error('Failed to initialize Netlify Identity:', e);
    clearTimeout(authTimeout);
    // Fallback immediately
    enterAsGuest();
  }
}

// Start the app
init();
</script>
</body>
</html>