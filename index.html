<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Focus v4 â€” Personal Study Tracker</title>
<link rel="icon" type="image/png" href="https://image2url.com/r2/default/images/1771818142936-9b1a8720-b73c-4610-ab72-d509d850c752.ico">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#0e0d0b; --bg2:#161512; --bg3:#1e1c19; --bg4:#252320;
  --border:#2e2c28; --text:#f0ead8; --text2:#a09880; --text3:#5a5548;
  --accent:#e8a832; --accent2:#c47f15;
  --accent-dim:rgba(232,168,50,0.12); --accent-glow:rgba(232,168,50,0.25);
  --green:#6fcf87; --red:#e86868; --blue:#68a8e8; --purple:#a868e8; --teal:#68e8c8;
  --radius:12px; --radius-sm:8px;
  --shadow:0 4px 24px rgba(0,0,0,0.4); --shadow-lg:0 8px 48px rgba(0,0,0,0.6);
  --transition:0.2s ease;
  --font-display:'DM Serif Display',serif;
  --font-body:'DM Sans',sans-serif;
  --font-mono:'DM Mono',monospace;
}
[data-theme="light"]{
  --bg:#f8f4ec; --bg2:#f0ead8; --bg3:#e8e0cc; --bg4:#ddd5be;
  --border:#d0c8b0; --text:#1a1810; --text2:#5a5040; --text3:#a09070;
  --accent:#c47f15; --accent2:#a06810;
  --accent-dim:rgba(196,127,21,0.12); --accent-glow:rgba(196,127,21,0.25);
  --shadow:0 4px 24px rgba(0,0,0,0.12); --shadow-lg:0 8px 48px rgba(0,0,0,0.2);
}
[data-theme="dim"]{
  --bg:#070707; --bg2:#0c0c0c; --bg3:#111111; --bg4:#161616;
  --border:#1f1f1f; --text:#c8c0a8; --text2:#706858; --text3:#3a3830;
  --accent:#c8881a; --accent2:#a06810;
  --accent-dim:rgba(200,136,26,0.1); --accent-glow:rgba(200,136,26,0.2);
  --shadow:0 4px 24px rgba(0,0,0,0.7); --shadow-lg:0 8px 48px rgba(0,0,0,0.9);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;transition:background .3s,color .3s}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.35}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-wrapper{display:flex;min-height:100vh}
.sidebar{width:224px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:100;transition:transform .3s ease}
.sidebar-logo{padding:22px 20px 18px;border-bottom:1px solid var(--border)}
.sidebar-logo h1{font-family:var(--font-display);font-size:22px;color:var(--accent);letter-spacing:-.5px}
.sidebar-logo span{font-family:var(--font-mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:2px}
.sidebar-nav{flex:1;padding:14px 0;overflow-y:auto}
.nav-section{padding:0 10px;margin-bottom:6px}
.nav-label{font-family:var(--font-mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;padding:5px 8px;margin-bottom:2px}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:var(--radius-sm);cursor:pointer;color:var(--text2);font-size:13.5px;font-weight:400;transition:all var(--transition);user-select:none;border:none;background:none;width:100%;text-align:left}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.active{background:var(--accent-dim);color:var(--accent);font-weight:500}
.nav-icon{font-size:15px;min-width:18px;text-align:center}
.sidebar-bottom{padding:14px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
.streak-badge{display:flex;align-items:center;gap:5px;font-family:var(--font-mono);font-size:12px;color:var(--accent)}
.streak-num{font-size:18px;font-weight:500}

/* Profile selector */
.profile-bar{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.profile-select{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:var(--font-body);font-size:12px;padding:5px 8px;outline:none;cursor:pointer}
.profile-add{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-size:12px;padding:5px 8px;cursor:pointer;transition:all var(--transition)}
.profile-add:hover{color:var(--accent);border-color:var(--accent)}

.main{margin-left:224px;flex:1;padding:28px 32px;max-width:calc(100vw - 224px)}
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:10px}
.topbar-left{display:flex;align-items:center;gap:14px}
.page-title{font-family:var(--font-display);font-size:26px;color:var(--text)}
.topbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.flip-clock{font-family:var(--font-mono);font-size:13px;color:var(--text2);background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:5px 11px;letter-spacing:1px}
.page-section{display:none}
.page-section.active{display:block}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS & GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:border-color var(--transition)}
.card:hover{border-color:var(--text3)}
.card-title{font-family:var(--font-mono);font-size:10.5px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:13px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.grid-auto{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:14px}
.mb{margin-bottom:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font-body);font-weight:500;transition:all var(--transition);display:inline-flex;align-items:center;gap:7px}
.btn-primary{background:var(--accent);color:#0e0d0b;padding:10px 26px;font-size:14px;border-radius:100px}
.btn-primary:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 14px var(--accent-glow)}
.btn-primary:active{transform:translateY(0)}
.btn-secondary{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:9px 18px;font-size:13px;border-radius:100px}
.btn-secondary:hover{background:var(--bg4);color:var(--text)}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--text3);padding:7px 13px;font-size:12px;border-radius:var(--radius-sm)}
.btn-ghost:hover{border-color:var(--text2);color:var(--text2)}
.btn-sm{padding:5px 11px;font-size:12px}
.btn-icon{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:7px;border-radius:var(--radius-sm);font-size:15px;line-height:1}
.btn-icon:hover{background:var(--bg4);color:var(--text)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.inp{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:var(--font-body);font-size:13px;padding:9px 13px;outline:none;transition:border-color var(--transition);width:100%}
.inp:focus{border-color:var(--accent)}
.inp::placeholder{color:var(--text3)}
.form-label{display:block;font-family:var(--font-mono);font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:5px}
.form-group{margin-bottom:13px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER HERO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timer-hero{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:28px 24px;display:flex;flex-direction:column;align-items:center;gap:16px;position:relative;overflow:hidden}
.timer-hero::before{content:'';position:absolute;top:-80px;right:-80px;width:280px;height:280px;background:radial-gradient(circle,var(--accent-glow),transparent 70%);pointer-events:none}
.mode-row{display:flex;gap:6px;background:var(--bg3);border-radius:100px;padding:3px}
.mode-btn{background:none;border:none;padding:5px 14px;border-radius:100px;font-family:var(--font-mono);font-size:11px;color:var(--text2);cursor:pointer;transition:all var(--transition)}
.mode-btn.active{background:var(--accent);color:#0e0d0b;font-weight:500}
.timer-display{font-family:var(--font-mono);font-size:76px;font-weight:300;color:var(--text);letter-spacing:-2px;line-height:1;transition:color .3s}
.timer-display.running{color:var(--accent)}
.timer-display.paused{color:var(--text2)}
.timer-phase{font-family:var(--font-mono);font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text3)}
.pomo-dots{display:flex;gap:6px}
.pomo-dot{width:8px;height:8px;border-radius:50%;background:var(--bg4);border:1px solid var(--border);transition:all .3s}
.pomo-dot.done{background:var(--accent);border-color:var(--accent)}
.pomo-dot.current{background:var(--accent-dim);border-color:var(--accent);box-shadow:0 0 6px var(--accent-glow)}
.timer-bar{width:100%;max-width:380px;height:3px;background:var(--bg4);border-radius:2px;overflow:hidden}
.timer-bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 1s linear;box-shadow:0 0 8px var(--accent-glow)}
.timer-controls{display:flex;gap:10px;align-items:center}
.timer-meta{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}

/* session type badge */
.session-type-select{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-family:var(--font-mono);font-size:11px;padding:6px 10px;outline:none;cursor:pointer}
.session-type-select:focus{border-color:var(--accent)}

/* quote strip */
.quote-strip{width:100%;text-align:center;font-family:var(--font-display);font-style:italic;font-size:13px;color:var(--text3);padding:6px 0;border-top:1px solid var(--border);margin-top:4px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD SHORTCUT HUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.kbd-hud{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border);border-radius:100px;padding:6px 16px;font-family:var(--font-mono);font-size:11px;color:var(--text3);z-index:200;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap}
.kbd-hud.show{opacity:1}
kbd{background:var(--bg4);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-size:10px;color:var(--text2)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUICK ADD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.quick-add-row{display:flex;gap:7px}
.quick-add-row .inp{flex:1}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASK LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.task-list{display:flex;flex-direction:column;gap:5px}
.task-item{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);transition:all var(--transition);animation:slideIn .2s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.task-item:hover{border-color:var(--text3)}
.task-item.done{opacity:.45}
.task-item.done .task-text{text-decoration:line-through;color:var(--text3)}
.task-check{width:17px;height:17px;border:1.5px solid var(--border);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all var(--transition);background:transparent}
.task-check.checked{background:var(--green);border-color:var(--green)}
.task-check.checked::after{content:'âœ“';font-size:10px;color:#0e0d0b;font-weight:700}
.task-text{flex:1;font-size:13.5px;color:var(--text)}
.task-sub{font-size:11px;color:var(--text3);font-family:var(--font-mono)}
.pdot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.pdot.high{background:var(--red)}.pdot.medium{background:var(--accent)}.pdot.low{background:var(--text3)}
.task-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;padding:2px 4px;border-radius:4px;transition:all var(--transition);opacity:0}
.task-item:hover .task-del{opacity:1}
.task-del:hover{color:var(--red);background:rgba(232,104,104,.1)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAT ROW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stat-row{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:14px}
.stat-item{display:flex;flex-direction:column;gap:3px}
.stat-value{font-family:var(--font-mono);font-size:22px;font-weight:500;color:var(--text);line-height:1}
.stat-label{font-size:11px;color:var(--text3)}
.stat-div{width:1px;background:var(--border);margin:3px 0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS RING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ring-wrap{position:relative;display:flex;align-items:center;justify-content:center}
.ring-label{position:absolute;text-align:center}
.ring-pct{font-family:var(--font-mono);font-size:19px;font-weight:500;color:var(--text);display:block}
.ring-sub{font-size:10px;color:var(--text3)}
.ring-row{display:flex;align-items:center;gap:18px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOAL BARS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.goal-item{margin-bottom:13px}
.goal-hd{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px}
.goal-name{font-size:13px;color:var(--text)}
.goal-txt{font-family:var(--font-mono);font-size:11px;color:var(--text3)}
.goal-bar{height:5px;background:var(--bg4);border-radius:3px;overflow:hidden}
.goal-fill{height:100%;border-radius:3px;transition:width .5s ease}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RATING BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rating-row{display:flex;gap:6px}
.r-btn{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-family:var(--font-mono);font-size:12px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all var(--transition)}
.r-btn:hover{border-color:var(--accent);color:var(--accent)}
.r-btn.sel{background:var(--accent);border-color:var(--accent);color:#0e0d0b;font-weight:600}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOG TABLE â€” expandable rows
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.log-wrap{overflow-x:auto;border-radius:var(--radius-sm);border:1px solid var(--border)}
.log-table{width:100%;border-collapse:collapse;font-size:12.5px}
.log-table th{font-family:var(--font-mono);font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);text-align:left;padding:9px 14px;background:var(--bg3);border-bottom:1px solid var(--border);white-space:nowrap}
.log-table td{padding:9px 14px;border-bottom:1px solid var(--border);color:var(--text2);white-space:nowrap}
.log-table tr:last-child td{border-bottom:none}
.log-table tr.log-row:hover td{background:var(--bg3);color:var(--text);cursor:pointer}
.log-expand{display:none;background:var(--bg3);border-bottom:1px solid var(--border)}
.log-expand td{white-space:normal;font-size:13px;color:var(--text2);padding:10px 14px 14px}
.log-expand.open{display:table-row}
.focus-stars{color:var(--accent);letter-spacing:1px}
.type-badge{display:inline-block;font-family:var(--font-mono);font-size:10px;padding:2px 7px;border-radius:100px;background:var(--accent-dim);color:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSISTENCY HEATMAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.heatmap-wrap{overflow-x:auto}
.heatmap{display:flex;gap:3px;padding-bottom:4px}
.hm-col{display:flex;flex-direction:column;gap:3px}
.hm-cell{width:13px;height:13px;border-radius:2px;background:var(--bg4);transition:all .2s;cursor:default;position:relative}
.hm-cell:hover::after{content:attr(data-tip);position:absolute;bottom:18px;left:50%;transform:translateX(-50%);background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:11px;color:var(--text);white-space:nowrap;z-index:10;pointer-events:none;font-family:var(--font-mono)}
.hm-cell.l1{background:rgba(232,168,50,.2)}
.hm-cell.l2{background:rgba(232,168,50,.45)}
.hm-cell.l3{background:rgba(232,168,50,.7)}
.hm-cell.l4{background:rgba(232,168,50,.95)}
.hm-months{display:flex;gap:0;margin-bottom:4px}
.hm-month-label{font-family:var(--font-mono);font-size:10px;color:var(--text3)}
.hm-days{display:flex;flex-direction:column;gap:3px;margin-right:6px;padding-top:0}
.hm-day-label{font-family:var(--font-mono);font-size:9px;color:var(--text3);height:13px;line-height:13px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BADGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.badges-grid{display:flex;flex-wrap:wrap;gap:10px}
.badge{display:flex;flex-direction:column;align-items:center;gap:5px;padding:14px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);min-width:90px;transition:all .2s;opacity:.35;filter:grayscale(1)}
.badge.earned{opacity:1;filter:none;border-color:var(--accent);background:var(--accent-dim)}
.badge-icon{font-size:28px}
.badge-name{font-family:var(--font-mono);font-size:10px;color:var(--text3);text-align:center;text-transform:uppercase;letter-spacing:.5px}
.badge.earned .badge-name{color:var(--accent)}
.badge-desc{font-size:11px;color:var(--text3);text-align:center}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTE PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.note-panel{display:flex;flex-direction:column;gap:10px}
.note-toolbar{display:flex;gap:6px;flex-wrap:wrap;padding:6px 8px;background:var(--bg3);border-radius:var(--radius-sm) var(--radius-sm) 0 0;border:1px solid var(--border);border-bottom:none}
.note-tool{background:none;border:none;color:var(--text2);font-size:13px;padding:4px 7px;cursor:pointer;border-radius:4px;transition:all .2s;font-weight:500}
.note-tool:hover{background:var(--bg4);color:var(--text)}
.note-area{width:100%;min-height:320px;background:var(--bg2);border:1px solid var(--border);border-radius:0 0 var(--radius-sm) var(--radius-sm);color:var(--text);font-family:var(--font-body);font-size:14px;line-height:1.7;padding:16px;outline:none;resize:vertical;transition:border-color .2s}
.note-area:focus{border-color:var(--accent)}
.note-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.note-tag{display:inline-flex;align-items:center;gap:4px;background:var(--accent-dim);border:1px solid var(--accent);border-radius:100px;padding:2px 10px;font-size:11px;color:var(--accent);font-family:var(--font-mono)}
.note-tag-del{cursor:pointer;color:var(--accent2);font-size:12px}
.note-list{display:flex;flex-direction:column;gap:8px}
.note-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;cursor:pointer;transition:all .2s}
.note-card:hover{border-color:var(--accent)}
.note-card-title{font-size:14px;color:var(--text);margin-bottom:4px;font-weight:500}
.note-card-preview{font-size:12px;color:var(--text3);overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.note-card-meta{font-family:var(--font-mono);font-size:10px;color:var(--text3);margin-top:6px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUBJECT CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.subject-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;position:relative;overflow:hidden;transition:all .2s}
.subject-card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--subject-color,var(--accent))}
.subject-card:hover{border-color:var(--text3);transform:translateY(-1px);box-shadow:var(--shadow)}
.subject-name{font-family:var(--font-display);font-size:17px;color:var(--text);margin-bottom:10px}
.s-stats{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
.s-stat{font-size:12.5px;color:var(--text2)}
.s-stat strong{color:var(--text)}
.s-bar{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden}
.s-bar-fill{height:100%;border-radius:2px;transition:width .5s ease}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXAM COUNTDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.exam-item{display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-bottom:1px solid var(--border)}
.exam-item:last-child{border-bottom:none}
.exam-name{font-size:13.5px;color:var(--text)}
.exam-date{font-size:11px;color:var(--text3)}
.exam-days{font-family:var(--font-mono);font-size:20px;font-weight:500;color:var(--accent)}
.exam-days.urgent{color:var(--red)}
.exam-days-lbl{font-size:10px;color:var(--text3);text-align:right}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MANUAL LOG FORM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.manual-log-form{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-bottom:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:500;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-ov.active{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:26px;width:100%;max-width:440px;max-height:90vh;overflow-y:auto;animation:mIn .2s ease}
@keyframes mIn{from{opacity:0;transform:scale(.95) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-title{font-family:var(--font-display);font-size:20px;color:var(--text);margin-bottom:18px}
.modal-actions{display:flex;gap:7px;justify-content:flex-end;margin-top:18px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEEKLY REVIEW CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.review-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:22px;position:relative;overflow:hidden}
.review-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--accent-dim),transparent 60%);pointer-events:none}
.review-headline{font-family:var(--font-display);font-size:18px;color:var(--text);margin-bottom:6px}
.review-body{font-size:13.5px;color:var(--text2);line-height:1.6}
.review-highlight{color:var(--accent);font-weight:600}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZEN MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.zen-ov{position:fixed;inset:0;background:var(--bg);z-index:1000;display:none;flex-direction:column;align-items:center;justify-content:center;gap:22px}
.zen-ov.active{display:flex}
.zen-task{font-family:var(--font-display);font-style:italic;font-size:20px;color:var(--text2);text-align:center;max-width:480px}
.zen-exit{position:absolute;top:22px;right:22px}
.zen-time{font-family:var(--font-mono);font-size:15px;color:var(--text3)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTIFICATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.notif{position:fixed;bottom:22px;right:22px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;color:var(--text);font-size:13.5px;z-index:2000;transform:translateX(130%);transition:transform .3s ease;max-width:300px;box-shadow:var(--shadow-lg)}
.notif.show{transform:translateX(0)}
.notif.success{border-left:3px solid var(--green)}
.notif.info{border-left:3px solid var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOUND BTNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sound-btns{display:flex;gap:7px;flex-wrap:wrap}
.sound-btn{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-size:12.5px;padding:7px 13px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px}
.sound-btn:hover{border-color:var(--accent);color:var(--accent)}
.sound-btn.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LINKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.link-item{display:flex;align-items:center;justify-content:space-between;padding:9px 13px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:6px;transition:all .2s;text-decoration:none}
.link-item:hover{border-color:var(--accent);background:var(--accent-dim)}
.link-name{font-size:13.5px;color:var(--text)}
.link-url{font-size:11px;color:var(--text3);font-family:var(--font-mono)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-wrap{position:relative;width:100%;min-height:200px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty{text-align:center;padding:28px;color:var(--text3);font-size:13.5px}
.empty-icon{font-size:28px;margin-bottom:7px;opacity:.35}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLLBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text3)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hamburger{display:none;background:none;border:none;color:var(--text);font-size:19px;cursor:pointer;padding:3px}
@media(max-width:900px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0);box-shadow:var(--shadow-lg)}
  .main{margin-left:0;max-width:100vw;padding:18px 14px}
  .hamburger{display:block}
  .grid-2{grid-template-columns:1fr}
  .grid-3{grid-template-columns:1fr 1fr}
  .timer-display{font-size:56px}
}
@media(max-width:560px){.grid-3{grid-template-columns:1fr}.timer-display{font-size:46px}}

.fade-in{animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH â€” LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#authScreen{position:fixed;inset:0;background:var(--bg);z-index:9000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0}
#authScreen.hidden{display:none}
.auth-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:40px 36px;width:100%;max-width:380px;text-align:center;box-shadow:var(--shadow-lg)}
.auth-logo{font-family:var(--font-display);font-size:28px;color:var(--accent);margin-bottom:6px}
.auth-sub{font-family:var(--font-mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:2px;margin-bottom:32px}
.auth-btn{width:100%;padding:12px;border-radius:100px;border:none;font-family:var(--font-body);font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px}
.auth-btn-primary{background:var(--accent);color:#0e0d0b}
.auth-btn-primary:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 14px var(--accent-glow)}
.auth-btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text2)}
.auth-btn-ghost:hover{border-color:var(--text2);color:var(--text)}
.auth-divider{display:flex;align-items:center;gap:10px;margin:16px 0;color:var(--text3);font-family:var(--font-mono);font-size:10px}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.auth-footer{font-size:11px;color:var(--text3);margin-top:20px;line-height:1.7}

/* User bar in sidebar */
.user-bar{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:9px;min-height:52px}
.user-avatar{width:30px;height:30px;border-radius:50%;background:var(--accent-dim);border:1px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;color:var(--accent);flex-shrink:0;font-family:var(--font-mono)}
.user-info{flex:1;min-width:0}
.user-name{font-size:12px;color:var(--text);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-email{font-family:var(--font-mono);font-size:9px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-logout{background:none;border:none;color:var(--text3);font-size:11px;cursor:pointer;padding:3px 6px;border-radius:4px;transition:all .2s;flex-shrink:0;font-family:var(--font-mono)}
.user-logout:hover{color:var(--red);background:rgba(232,104,104,.1)}

</head>
<body>

<!-- â•â• AUTH SCREEN â•â• -->
<div id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">Focus</div>
    <div class="auth-sub">Study Tracker v4</div>

    <button class="auth-btn auth-btn-primary" onclick="netlifyIdentity.open('login')">
      ğŸ” Log In
    </button>
    <button class="auth-btn auth-btn-ghost" onclick="netlifyIdentity.open('signup')">
      âœ¦ Create Account
    </button>

    <div class="auth-divider">or continue as guest</div>
    <button class="auth-btn auth-btn-ghost" onclick="enterAsGuest()">
      ğŸ‘¤ Guest Mode (local only)
    </button>

    <div class="auth-footer">
      Your data is saved per account.<br>
      Log in on any device to access your sessions.
    </div>
  </div>
</div>

<!-- â”€â”€ NOTIFICATION â”€â”€ -->
<div class="notif" id="notif"></div>

<!-- â”€â”€ KBD HUD â”€â”€ -->
<div class="kbd-hud" id="kbdHud">
  <kbd>Space</kbd> Start/Pause &nbsp;
  <kbd>S</kbd> Stop &nbsp;
  <kbd>Z</kbd> Zen &nbsp;
  <kbd>M</kbd> Manual Log &nbsp;
  <kbd>?</kbd> Hide
</div>

<!-- â”€â”€ ZEN MODE â”€â”€ -->
<div class="zen-ov" id="zenOv">
  <div class="zen-time" id="zenClock"></div>
  <div class="timer-display" id="zenTimer">00:00</div>
  <div class="timer-phase" id="zenPhase">FOCUS</div>
  <div class="timer-bar" style="max-width:340px"><div class="timer-bar-fill" id="zenBar" style="width:100%"></div></div>
  <div class="zen-task" id="zenTask">No task set</div>
  <div class="timer-controls">
    <button class="btn btn-secondary" onclick="toggleTimer()"><span id="zenIcon">â–¶</span> <span id="zenLbl">Start</span></button>
    <button class="btn btn-ghost" onclick="stopTimer()">Stop</button>
  </div>
  <div class="zen-exit"><button class="btn btn-ghost btn-sm" onclick="toggleZen()">âœ• Exit Zen</button></div>
</div>

<!-- â”€â”€ SESSION COMPLETE MODAL â”€â”€ -->
<div class="modal-ov" id="sessionModal">
  <div class="modal">
    <div class="modal-title">ğŸ‰ Session Complete!</div>
    <div class="form-group">
      <label class="form-label">Subject</label>
      <select class="inp" id="sm_subject" style="cursor:pointer"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Topic</label>
      <input type="text" class="inp" id="sm_topic" placeholder="What did you study?">
    </div>
    <div class="form-group">
      <label class="form-label">Session Type</label>
      <select class="inp" id="sm_type" style="cursor:pointer">
        <option value="General">General</option>
        <option value="Active Recall">Active Recall</option>
        <option value="Reading">Reading</option>
        <option value="Problem Solving">Problem Solving</option>
        <option value="Revision">Revision</option>
        <option value="Lecture">Lecture</option>
        <option value="Writing">Writing</option>
        <option value="Research">Research</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Focus Rating</label>
      <div class="rating-row" id="sm_focus">
        <div class="r-btn" onclick="rate('focus',1)">1</div>
        <div class="r-btn" onclick="rate('focus',2)">2</div>
        <div class="r-btn sel" onclick="rate('focus',3)">3</div>
        <div class="r-btn" onclick="rate('focus',4)">4</div>
        <div class="r-btn" onclick="rate('focus',5)">5</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Energy Level</label>
      <div class="rating-row" id="sm_energy">
        <div class="r-btn" onclick="rate('energy',1)">1</div>
        <div class="r-btn" onclick="rate('energy',2)">2</div>
        <div class="r-btn sel" onclick="rate('energy',3)">3</div>
        <div class="r-btn" onclick="rate('energy',4)">4</div>
        <div class="r-btn" onclick="rate('energy',5)">5</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <input type="text" class="inp" id="sm_notes" placeholder="Quick reflectionâ€¦">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="saveSession(true)">Skip (auto-save)</button>
      <button class="btn btn-primary" onclick="saveSession(false)">Log Session âœ“</button>
    </div>
  </div>
</div>

<!-- â”€â”€ MANUAL LOG MODAL â”€â”€ -->
<div class="modal-ov" id="manualModal">
  <div class="modal">
    <div class="modal-title">â• Add Manual Session</div>
    <div class="form-group">
      <label class="form-label">Date</label>
      <input type="date" class="inp" id="ml_date">
    </div>
    <div class="form-group">
      <label class="form-label">Subject</label>
      <select class="inp" id="ml_subject" style="cursor:pointer"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Topic</label>
      <input type="text" class="inp" id="ml_topic" placeholder="Topic studied">
    </div>
    <div class="form-group">
      <label class="form-label">Duration (minutes)</label>
      <input type="number" class="inp" id="ml_duration" placeholder="60" min="1">
    </div>
    <div class="form-group">
      <label class="form-label">Session Type</label>
      <select class="inp" id="ml_type" style="cursor:pointer">
        <option>General</option><option>Active Recall</option><option>Reading</option>
        <option>Problem Solving</option><option>Revision</option><option>Lecture</option>
        <option>Writing</option><option>Research</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Focus Rating</label>
      <div class="rating-row" id="ml_focus">
        <div class="r-btn" onclick="rateML('focus',1)">1</div>
        <div class="r-btn" onclick="rateML('focus',2)">2</div>
        <div class="r-btn sel" onclick="rateML('focus',3)">3</div>
        <div class="r-btn" onclick="rateML('focus',4)">4</div>
        <div class="r-btn" onclick="rateML('focus',5)">5</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <input type="text" class="inp" id="ml_notes" placeholder="Optional notes">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('manualModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveManualSession()">Add Session</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ADD SUBJECT MODAL â”€â”€ -->
<div class="modal-ov" id="addSubjectModal">
  <div class="modal">
    <div class="modal-title">Add Subject</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="inp" id="ns_name" placeholder="e.g. Mathematics"></div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div style="display:flex;gap:7px;flex-wrap:wrap" id="colorPick">
        <div class="r-btn" style="background:#e8a832;border-color:#e8a832;color:#0e0d0b;cursor:pointer" onclick="pickColor('#e8a832',this)">â—</div>
        <div class="r-btn" style="background:#68a8e8;border-color:#68a8e8;color:#0e0d0b;cursor:pointer" onclick="pickColor('#68a8e8',this)">â—</div>
        <div class="r-btn" style="background:#6fcf87;border-color:#6fcf87;color:#0e0d0b;cursor:pointer" onclick="pickColor('#6fcf87',this)">â—</div>
        <div class="r-btn" style="background:#a868e8;border-color:#a868e8;color:#0e0d0b;cursor:pointer" onclick="pickColor('#a868e8',this)">â—</div>
        <div class="r-btn" style="background:#e86868;border-color:#e86868;color:#0e0d0b;cursor:pointer" onclick="pickColor('#e86868',this)">â—</div>
        <div class="r-btn" style="background:#68e8c8;border-color:#68e8c8;color:#0e0d0b;cursor:pointer" onclick="pickColor('#68e8c8',this)">â—</div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addSubjectModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSubject()">Add</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ADD EXAM MODAL â”€â”€ -->
<div class="modal-ov" id="addExamModal">
  <div class="modal">
    <div class="modal-title">Add Exam / Deadline</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="inp" id="ne_name" placeholder="e.g. Physics Final"></div>
    <div class="form-group"><label class="form-label">Date</label><input type="date" class="inp" id="ne_date"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addExamModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExam()">Add</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ADD LINK MODAL â”€â”€ -->
<div class="modal-ov" id="addLinkModal">
  <div class="modal">
    <div class="modal-title">Add Quick Link</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="inp" id="nl_name" placeholder="Lecture Notes"></div>
    <div class="form-group"><label class="form-label">URL</label><input type="url" class="inp" id="nl_url" placeholder="https://..."></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addLinkModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveLink()">Add</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ADD PROFILE MODAL â”€â”€ -->
<div class="modal-ov" id="addProfileModal">
  <div class="modal">
    <div class="modal-title">New Profile</div>
    <div class="form-group"><label class="form-label">Profile Name</label><input type="text" class="inp" id="np_name" placeholder="e.g. Exam Mode"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addProfileModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProfile()">Create</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP WRAPPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-wrapper">

  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <h1>Focus</h1>
      <span>Study Tracker v4</span>
    </div>

    <!-- User bar (shown when logged in) -->
    <div class="user-bar" id="userBar" style="display:none">
      <div class="user-avatar" id="userAvatar">?</div>
      <div class="user-info">
        <div class="user-name" id="userName">â€”</div>
        <div class="user-email" id="userEmail">â€”</div>
      </div>
      <button class="user-logout" onclick="logOut()" title="Log out">â†©</button>
    </div>

    <!-- Profile bar -->
    <div class="profile-bar">
      <select class="profile-select" id="profileSelect" onchange="switchProfile(this.value)"></select>
      <button class="profile-add" onclick="openModal('addProfileModal')" title="New profile">ï¼‹</button>
    </div>

    <div class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-label">Main</div>
        <button class="nav-item active" onclick="nav('dashboard',this)"><span class="nav-icon">âš¡</span>Dashboard</button>
        <button class="nav-item" onclick="nav('log',this)"><span class="nav-icon">ğŸ“‹</span>Study Log</button>
        <button class="nav-item" onclick="nav('tasks',this)"><span class="nav-icon">âœ…</span>Tasks</button>
        <button class="nav-item" onclick="nav('notes',this)"><span class="nav-icon">ğŸ“</span>Notes</button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Insights</div>
        <button class="nav-item" onclick="nav('analytics',this)"><span class="nav-icon">ğŸ“Š</span>Analytics</button>
        <button class="nav-item" onclick="nav('heatmap',this)"><span class="nav-icon">ğŸ—“</span>Calendar</button>
        <button class="nav-item" onclick="nav('badges',this)"><span class="nav-icon">ğŸ†</span>Badges</button>
        <button class="nav-item" onclick="nav('subjects',this)"><span class="nav-icon">ğŸ“š</span>Subjects</button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Plan</div>
        <button class="nav-item" onclick="nav('planner',this)"><span class="nav-icon">ğŸ“…</span>Planner</button>
        <button class="nav-item" onclick="nav('goals',this)"><span class="nav-icon">ğŸ¯</span>Goals</button>
        <button class="nav-item" onclick="nav('focus',this)"><span class="nav-icon">ğŸ§˜</span>Focus Tools</button>
        <button class="nav-item" onclick="nav('settings',this)"><span class="nav-icon">âš™</span>Settings</button>
      </div>
    </div>

    <div class="sidebar-bottom">
      <div class="streak-badge">ğŸ”¥<span class="streak-num" id="streakNum">0</span><span style="font-size:10px;color:var(--text3)">days</span></div>
      <div style="display:flex;gap:6px">
        <button class="btn-icon" onclick="cycleTheme()" title="Theme" id="themeBtn">â˜€</button>
        <button class="btn-icon" onclick="openModal('manualModal')" title="Manual log (M)">âœ</button>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
        <div class="page-title" id="pageTitle">Dashboard</div>
      </div>
      <div class="topbar-right">
        <div class="flip-clock" id="topClock">00:00:00</div>
        <button class="btn btn-ghost btn-sm" onclick="toggleZen()">ğŸ§˜ Zen</button>
        <button class="btn btn-ghost btn-sm" onclick="exportCSV()">â†“ CSV</button>
        <button class="btn btn-ghost btn-sm" onclick="exportJSON()">â†“ JSON</button>
      </div>
    </div>

    <!-- crash recovery banner -->
    <div class="recovery-banner" id="recoveryBanner" style="display:none">
      âš¡ Unsaved session detected from last visit.
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary btn-sm" onclick="restoreCrash()">Restore</button>
        <button class="btn btn-ghost btn-sm" onclick="dismissCrash()">Dismiss</button>
      </div>
    </div>

    <!-- â•â• DASHBOARD â•â• -->
    <section class="page-section active fade-in" id="page-dashboard">

      <!-- Timer Hero -->
      <div class="timer-hero mb">
        <div class="mode-row">
          <button class="mode-btn active" onclick="setMode('p25',this)">25/5</button>
          <button class="mode-btn" onclick="setMode('p50',this)">50/10</button>
          <button class="mode-btn" onclick="setMode('sw',this)">Stopwatch</button>
          <button class="mode-btn" onclick="setMode('custom',this)">Custom</button>
        </div>
        <div class="pomo-dots" id="pomoDots"></div>
        <div class="timer-phase" id="timerPhase">FOCUS</div>
        <div class="timer-display" id="timerDisp">25:00</div>
        <div class="timer-bar"><div class="timer-bar-fill" id="timerBar" style="width:100%"></div></div>
        <div class="timer-meta">
          <select class="session-type-select" id="curSubject" onchange="onSubjectChange()">
            <option value="">Subjectâ€¦</option>
          </select>
          <input type="text" class="inp" id="curTopic" placeholder="Topic / taskâ€¦" style="max-width:180px" oninput="updateZenTask()">
          <select class="session-type-select" id="curType">
            <option>General</option><option>Active Recall</option><option>Reading</option>
            <option>Problem Solving</option><option>Revision</option><option>Lecture</option>
            <option>Writing</option><option>Research</option>
          </select>
        </div>
        <div class="timer-controls">
          <button class="btn btn-primary" id="startBtn" onclick="toggleTimer()">â–¶ Start</button>
          <button class="btn btn-secondary" onclick="stopTimer()">Stop</button>
          <button class="btn btn-ghost btn-sm" onclick="skipPhase()">Skip â†’</button>
        </div>
        <div class="quote-strip" id="quoteStrip">Loading quoteâ€¦</div>
      </div>

      <div class="grid-2 mb">
        <!-- Today at a Glance -->
        <div class="card">
          <div class="card-title">Today at a Glance</div>
          <div class="stat-row">
            <div class="stat-item"><div class="stat-value" id="todayHrs">0m</div><div class="stat-label">Today</div></div>
            <div class="stat-div"></div>
            <div class="stat-item"><div class="stat-value" id="todaySess">0</div><div class="stat-label">Sessions</div></div>
            <div class="stat-div"></div>
            <div class="stat-item"><div class="stat-value" id="weekHrs">0h</div><div class="stat-label">This Week</div></div>
            <div class="stat-div"></div>
            <div class="stat-item"><div class="stat-value" id="prodMin">0m</div><div class="stat-label">Productive</div></div>
          </div>
          <div class="card-title" style="margin-top:8px">Due in 48h</div>
          <div id="due48List"></div>
        </div>

        <!-- Progress Ring -->
        <div class="card">
          <div class="card-title">Daily Goal Progress</div>
          <div class="ring-row">
            <div class="ring-wrap">
              <svg width="96" height="96">
                <circle cx="48" cy="48" r="40" fill="none" stroke="var(--bg4)" stroke-width="7"/>
                <circle id="ringCircle" cx="48" cy="48" r="40" fill="none" stroke="var(--accent)" stroke-width="7"
                  stroke-dasharray="251.33" stroke-dashoffset="251.33" transform="rotate(-90 48 48)"
                  style="transition:stroke-dashoffset .6s ease"/>
              </svg>
              <div class="ring-label"><span class="ring-pct" id="ringPct">0%</span><span class="ring-sub">of goal</span></div>
            </div>
            <div style="flex:1">
              <div class="goal-item">
                <div class="goal-hd"><span class="goal-name">Daily</span><span class="goal-txt" id="dailyGT">0/120m</span></div>
                <div class="goal-bar"><div class="goal-fill" id="dailyGB" style="width:0%;background:var(--accent)"></div></div>
              </div>
              <div class="goal-item">
                <div class="goal-hd"><span class="goal-name">Weekly</span><span class="goal-txt" id="weeklyGT">0/600m</span></div>
                <div class="goal-bar"><div class="goal-fill" id="weeklyGB" style="width:0%;background:var(--blue)"></div></div>
              </div>
              <div class="goal-item">
                <div class="goal-hd"><span class="goal-name">Tasks</span><span class="goal-txt" id="taskGT">0/0</span></div>
                <div class="goal-bar"><div class="goal-fill" id="taskGB" style="width:0%;background:var(--green)"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Weekly Review -->
      <div class="review-card mb" id="weeklyReview"></div>

      <!-- Quick Add -->
      <div class="card mb">
        <div class="card-title">Quick Add Task</div>
        <div class="quick-add-row mb" style="margin-bottom:7px">
          <input type="text" class="inp" id="qaInput" placeholder='Taskâ€¦ (Enter to add)' onkeypress="if(event.key==='Enter')qaAdd()">
          <select class="inp" id="qaPri" style="max-width:100px;cursor:pointer">
            <option value="medium">Med</option>
            <option value="high">High</option>
            <option value="low">Low</option>
          </select>
          <select class="inp" id="qaSubj" style="max-width:130px;cursor:pointer"><option value="">Subjectâ€¦</option></select>
          <button class="btn btn-primary btn-sm" onclick="qaAdd()">+ Add</button>
        </div>
        <div id="dashTaskList" class="task-list"></div>
      </div>
    </section>

    <!-- â•â• STUDY LOG â•â• -->
    <section class="page-section fade-in" id="page-log">
      <div class="card mb">
        <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
          <span>Session History â€” click row to expand notes</span>
          <div style="display:flex;gap:7px">
            <button class="btn btn-ghost btn-sm" onclick="openModal('manualModal')">+ Manual</button>
            <button class="btn btn-ghost btn-sm" onclick="exportCSV()">Export CSV</button>
          </div>
        </div>
        <div class="log-wrap">
          <table class="log-table">
            <thead>
              <tr>
                <th>Date</th><th>Subject</th><th>Topic</th><th>Type</th>
                <th>Duration</th><th>Focus</th><th>Energy</th><th>Productive</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- â•â• TASKS â•â• -->
    <section class="page-section fade-in" id="page-tasks">
      <div class="grid-2">
        <div>
          <div class="card mb">
            <div class="card-title">Add Task</div>
            <div class="form-group"><input type="text" class="inp" id="t_text" placeholder="Task descriptionâ€¦"></div>
            <div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:10px">
              <select class="inp" id="t_pri" style="flex:1;cursor:pointer">
                <option value="medium">Medium</option><option value="high">High</option><option value="low">Low</option>
              </select>
              <select class="inp" id="t_subj" style="flex:1;cursor:pointer"><option value="">Subjectâ€¦</option></select>
              <input type="date" class="inp" id="t_due" style="flex:1">
            </div>
            <button class="btn btn-primary" onclick="addTaskFull()">+ Add Task</button>
          </div>
        </div>
        <div>
          <div class="card mb">
            <div class="card-title" style="display:flex;justify-content:space-between">
              <span>Pending</span>
              <span id="pendCnt" style="font-family:var(--font-mono);font-size:10px;color:var(--text3)">0</span>
            </div>
            <div id="allTasksList" class="task-list"></div>
          </div>
          <div class="card">
            <div class="card-title">âœ“ Completed</div>
            <div id="doneTasksList" class="task-list"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- â•â• NOTES â•â• -->
    <section class="page-section fade-in" id="page-notes">
      <div class="grid-2">
        <div>
          <div class="card mb">
            <div class="card-title">New Note</div>
            <div class="form-group"><input type="text" class="inp" id="note_title" placeholder="Titleâ€¦"></div>
            <div class="form-group">
              <select class="inp" id="note_subj" style="cursor:pointer;margin-bottom:7px"><option value="">Subject (optional)</option></select>
            </div>
            <div class="note-panel">
              <div class="note-toolbar">
                <button class="note-tool" onclick="noteFmt('bold')" title="Bold"><b>B</b></button>
                <button class="note-tool" onclick="noteFmt('italic')" title="Italic"><i>I</i></button>
                <button class="note-tool" onclick="noteFmt('insertUnorderedList')" title="Bullet">â€¢</button>
                <button class="note-tool" onclick="noteFmt('insertOrderedList')" title="Numbered">1.</button>
                <button class="note-tool" onclick="noteFmt('h2')" title="Heading">H</button>
                <button class="note-tool" onclick="noteFmt('code')" title="Code">&lt;/&gt;</button>
                <button class="note-tool" onclick="noteFmt('hr')" title="Divider">â€”</button>
                <span style="flex:1"></span>
                <button class="note-tool" onclick="clearNoteEditor()" style="color:var(--red)">Clear</button>
              </div>
              <div class="note-area" id="noteEditor" contenteditable="true" style="font-size:14px;line-height:1.7" placeholder="Start typing your notesâ€¦"></div>
            </div>
            <div style="display:flex;gap:7px;margin-top:10px">
              <input type="text" class="inp" id="noteTagInput" placeholder="Add tagâ€¦" onkeypress="if(event.key==='Enter')addNoteTag()" style="flex:1">
              <button class="btn btn-ghost btn-sm" onclick="addNoteTag()">+ Tag</button>
            </div>
            <div class="note-tags" id="noteTagsDisplay"></div>
            <button class="btn btn-primary" style="margin-top:10px;width:100%" onclick="saveNote()">Save Note</button>
          </div>
        </div>
        <div>
          <div class="card">
            <div class="card-title" style="display:flex;justify-content:space-between">
              Saved Notes
              <input type="text" class="inp" id="noteSearch" placeholder="Searchâ€¦" style="max-width:160px;font-size:12px;padding:5px 9px" oninput="renderNotes()">
            </div>
            <div id="notesList" class="note-list"></div>
          </div>
        </div>
      </div>

      <!-- Note viewer modal area (inline) -->
      <div id="noteViewer" style="display:none" class="card" style="margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div class="card-title" id="noteViewTitle" style="margin-bottom:0">Note</div>
          <div style="display:flex;gap:7px">
            <button class="btn btn-ghost btn-sm" onclick="editNote()">Edit</button>
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('noteViewer').style.display='none'">âœ•</button>
          </div>
        </div>
        <div id="noteViewBody" style="font-size:14px;line-height:1.7;color:var(--text2)"></div>
        <div class="note-tags" id="noteViewTags" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- â•â• ANALYTICS â•â• -->
    <section class="page-section fade-in" id="page-analytics">
      <div class="grid-2 mb">
        <div class="card"><div class="card-title">Daily Productive Minutes (7 Days)</div><div class="chart-wrap"><canvas id="wChart"></canvas></div></div>
        <div class="card"><div class="card-title">Subject Distribution</div><div class="chart-wrap" style="max-height:220px"><canvas id="pChart"></canvas></div></div>
      </div>
      <div class="grid-2 mb">
        <div class="card"><div class="card-title">Focus & Energy Trend</div><div class="chart-wrap"><canvas id="fChart"></canvas></div></div>
        <div class="card"><div class="card-title">Session Type Breakdown</div><div class="chart-wrap"><canvas id="tChart"></canvas></div></div>
      </div>
      <div class="card mb">
        <div class="card-title" style="display:flex;justify-content:space-between">
          Daily Report Explorer
          <button class="btn btn-ghost btn-sm" onclick="exportJSON()">Export JSON</button>
        </div>
        <div id="dailyReport"></div>
      </div>
    </section>

    <!-- â•â• HEATMAP â•â• -->
    <section class="page-section fade-in" id="page-heatmap">
      <div class="card mb">
        <div class="card-title">Consistency Calendar â€” Last 52 Weeks</div>
        <div class="heatmap-wrap">
          <div style="display:flex;gap:2px">
            <div>
              <div style="height:16px"></div>
              <div class="hm-days" id="hmDays"></div>
            </div>
            <div style="flex:1;overflow-x:auto">
              <div id="hmMonths" class="hm-months" style="gap:0;margin-bottom:4px"></div>
              <div class="heatmap" id="heatmap"></div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;margin-top:10px;font-family:var(--font-mono);font-size:10px;color:var(--text3)">
            Less
            <div style="width:12px;height:12px;border-radius:2px;background:var(--bg4)"></div>
            <div class="hm-cell l1" style="width:12px;height:12px"></div>
            <div class="hm-cell l2" style="width:12px;height:12px"></div>
            <div class="hm-cell l3" style="width:12px;height:12px"></div>
            <div class="hm-cell l4" style="width:12px;height:12px"></div>
            More
          </div>
        </div>
      </div>
      <div class="grid-3">
        <div class="card"><div class="card-title">Best Study Day</div><div id="bestDay" style="font-family:var(--font-mono);font-size:22px;color:var(--accent)">â€”</div></div>
        <div class="card"><div class="card-title">Longest Streak</div><div id="longestStreak" style="font-family:var(--font-mono);font-size:22px;color:var(--accent)">0 days</div></div>
        <div class="card"><div class="card-title">Active Weeks</div><div id="activeWeeks" style="font-family:var(--font-mono);font-size:22px;color:var(--accent)">0</div></div>
      </div>
    </section>

    <!-- â•â• BADGES â•â• -->
    <section class="page-section fade-in" id="page-badges">
      <div class="card mb">
        <div class="card-title">Achievement Badges</div>
        <div class="badges-grid" id="badgesGrid"></div>
      </div>
    </section>

    <!-- â•â• SUBJECTS â•â• -->
    <section class="page-section fade-in" id="page-subjects">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <span style="color:var(--text2);font-size:13px">Track time per subject</span>
        <button class="btn btn-primary btn-sm" onclick="openModal('addSubjectModal')">+ Add Subject</button>
      </div>
      <div class="grid-auto" id="subjectCards"></div>
    </section>

    <!-- â•â• PLANNER â•â• -->
    <section class="page-section fade-in" id="page-planner">
      <div class="grid-2 mb">
        <div class="card">
          <div class="card-title" style="display:flex;justify-content:space-between">
            Exam Countdowns
            <button class="btn btn-ghost btn-sm" onclick="openModal('addExamModal')">+ Add</button>
          </div>
          <div id="examList"></div>
        </div>
        <div class="card">
          <div class="card-title">This Week</div>
          <div id="weekPlanner"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Tasks by Due Date</div>
        <div id="plannerTasks" class="task-list"></div>
      </div>
    </section>

    <!-- â•â• GOALS â•â• -->
    <section class="page-section fade-in" id="page-goals">
      <div class="grid-2 mb">
        <div class="card">
          <div class="card-title">Set Goals</div>
          <div class="form-group"><label class="form-label">Daily Goal (min)</label><input type="number" class="inp" id="g_daily" placeholder="120"></div>
          <div class="form-group"><label class="form-label">Weekly Goal (min)</label><input type="number" class="inp" id="g_weekly" placeholder="600"></div>
          <button class="btn btn-primary" onclick="saveGoals()">Save Goals</button>
        </div>
        <div class="card"><div class="card-title">Summary</div><div id="goalsSummary"></div></div>
      </div>
    </section>

    <!-- â•â• FOCUS TOOLS â•â• -->
    <section class="page-section fade-in" id="page-focus">
      <div class="grid-2 mb">
        <div class="card">
          <div class="card-title">Ambient Sounds</div>
          <div class="sound-btns mb" id="soundBtns">
            <button class="sound-btn" onclick="toggleSound('rain',this)">ğŸŒ§ Rain</button>
            <button class="sound-btn" onclick="toggleSound('cafe',this)">â˜• CafÃ©</button>
            <button class="sound-btn" onclick="toggleSound('forest',this)">ğŸŒ² Forest</button>
            <button class="sound-btn" onclick="toggleSound('fire',this)">ğŸ”¥ Fire</button>
            <button class="sound-btn" onclick="toggleSound('ocean',this)">ğŸŒŠ Ocean</button>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:12px;color:var(--text2)">Volume</span>
            <input type="range" id="volSlider" min="0" max="1" step="0.05" value="0.3" style="flex:1;accent-color:var(--accent)" oninput="setVol(this.value)">
          </div>
        </div>
        <div class="card">
          <div class="card-title">Zen Mode</div>
          <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Hide everything except the timer and current task.</p>
          <button class="btn btn-primary" onclick="toggleZen()">ğŸ§˜ Enter Zen Mode</button>
          <p style="font-size:11px;color:var(--text3);margin-top:8px">Shortcut: <kbd>Z</kbd> â€” Exit with Escape</p>
        </div>
      </div>
      <div class="card mb">
        <div class="card-title" style="display:flex;justify-content:space-between">
          Quick Links
          <button class="btn btn-ghost btn-sm" onclick="openModal('addLinkModal')">+ Add</button>
        </div>
        <div id="linksList"></div>
      </div>
      <div class="card">
        <div class="card-title">Lo-Fi / YouTube Embed</div>
        <div style="display:flex;gap:7px;margin-bottom:10px">
          <input type="url" class="inp" id="embedUrl" placeholder="https://www.youtube.com/embed/â€¦">
          <button class="btn btn-primary btn-sm" onclick="loadEmbed()">Load</button>
          <button class="btn btn-ghost btn-sm" onclick="clearEmbed()">Clear</button>
        </div>
        <div id="embedBox"></div>
      </div>
    </section>

    <!-- â•â• SETTINGS â•â• -->
    <section class="page-section fade-in" id="page-settings">
      <div class="grid-2 mb">
        <div class="card">
          <div class="card-title">Timer Settings</div>
          <div class="form-group"><label class="form-label">Custom Focus (min)</label><input type="number" class="inp" id="s_focus" value="45"></div>
          <div class="form-group"><label class="form-label">Custom Break (min)</label><input type="number" class="inp" id="s_break" value="10"></div>
          <button class="btn btn-primary" onclick="saveSettings()">Save</button>
        </div>
        <div class="card">
          <div class="card-title">Theme</div>
          <div style="display:flex;gap:8px;margin-bottom:14px">
            <button class="btn btn-secondary" onclick="setTheme('dark')">ğŸŒ‘ Dark</button>
            <button class="btn btn-secondary" onclick="setTheme('dim')">ğŸŒ˜ Dim</button>
            <button class="btn btn-secondary" onclick="setTheme('light')">â˜€ Light</button>
          </div>
          <div class="card-title">Keyboard Shortcuts</div>
          <div style="font-family:var(--font-mono);font-size:12px;color:var(--text2);line-height:2">
            <div><kbd>Space</kbd> â€” Start / Pause timer</div>
            <div><kbd>S</kbd> â€” Stop timer</div>
            <div><kbd>Z</kbd> â€” Toggle Zen mode</div>
            <div><kbd>M</kbd> â€” Open manual log</div>
            <div><kbd>?</kbd> â€” Toggle shortcut HUD</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Data</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-secondary" onclick="exportCSV()">â†“ Export CSV</button>
          <button class="btn btn-secondary" onclick="exportJSON()">â†“ Export JSON</button>
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">â†‘ Import JSON</button>
          <button class="btn btn-ghost" onclick="clearAll()" style="color:var(--red);border-color:var(--red)">ğŸ—‘ Clear All Data</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
      </div>
    </section>

  </main>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Multi-profile: each profile is an independent dataset
let profiles = {};  // { profileName: {sessions, tasks, subjects, exams, links, notes, goals, settings, streak, lastStudyDate} }
let currentProfile = 'Default';

function profileData() { return profiles[currentProfile]; }
function pd() { return profiles[currentProfile]; }

function blankProfile() {
  return {
    sessions: [], tasks: [], subjects: [], exams: [], links: [], notes: [],
    goals: { daily: 120, weekly: 600 },
    settings: { customFocus: 45, customBreak: 10 },
    streak: 0, lastStudyDate: null
  };
}

function loadState() {
  try {
    const raw = localStorage.getItem(storageKey);
    if (raw) {
      const d = JSON.parse(raw);
      profiles = d.profiles || { Default: blankProfile() };
      currentProfile = d.currentProfile || 'Default';
      if (!profiles[currentProfile]) profiles[currentProfile] = blankProfile();
    } else {
      profiles = { Default: blankProfile() };
      currentProfile = 'Default';
    }
  } catch(e) { profiles = { Default: blankProfile() }; }
}

function saveState() {
  try {
    localStorage.setItem(storageKey, JSON.stringify({ profiles, currentProfile }));
  } catch(e) {}
}

// Crash recovery: save in-progress session every 30s
let crashData = null;
function saveCrash() {
  if (!tmr.running) return;
  const d = {
    subject: document.getElementById('curSubject').value,
    topic: document.getElementById('curTopic').value,
    type: document.getElementById('curType').value,
    startTime: tmr.sessionStart ? tmr.sessionStart.toISOString() : new Date().toISOString(),
    elapsed: tmr.elapsed,
    profile: currentProfile
  };
  localStorage.setItem(storageKey + '_crash', JSON.stringify(d));
}

function checkCrash() {
  const raw = localStorage.getItem(storageKey + '_crash');
  if (!raw) return;
  try {
    crashData = JSON.parse(raw);
    document.getElementById('recoveryBanner').style.display = 'flex';
  } catch(e) {}
}

function restoreCrash() {
  if (!crashData) return;
  const mins = Math.floor(crashData.elapsed / 60);
  if (mins < 1) { dismissCrash(); return; }
  pendS.durationMinutes = mins;
  pendS.subject = crashData.subject;
  pendS.topic = crashData.topic;
  pendS.type = crashData.type;
  pendS.startTime = crashData.startTime;
  document.getElementById('sm_subject').value = crashData.subject || '';
  document.getElementById('sm_topic').value = crashData.topic || '';
  openModal('sessionModal');
  dismissCrash();
}

function dismissCrash() {
  localStorage.removeItem(storageKey + '_crash');
  document.getElementById('recoveryBanner').style.display = 'none';
  crashData = null;
}

setInterval(saveCrash, 30000);
window.addEventListener('beforeunload', saveCrash);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderProfileSelect() {
  const sel = document.getElementById('profileSelect');
  sel.innerHTML = Object.keys(profiles).map(p =>
    `<option value="${esc(p)}" ${p === currentProfile ? 'selected' : ''}>${esc(p)}</option>`
  ).join('');
}

function switchProfile(name) {
  if (!profiles[name]) return;
  currentProfile = name;
  saveState();
  refreshAll();
  notify(`Switched to "${name}"`, 'info');
}

function saveProfile() {
  const name = document.getElementById('np_name').value.trim();
  if (!name) return;
  if (!profiles[name]) profiles[name] = blankProfile();
  currentProfile = name;
  saveState();
  closeModal('addProfileModal');
  renderProfileSelect();
  refreshAll();
  notify(`Profile "${name}" created!`, 'success');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tmr = {
  mode: 'p25', phase: 'focus',
  running: false, paused: false,
  elapsed: 0, total: 25*60,
  interval: null, sessionStart: null,
  pomoCount: 0
};

let pendS = { focusRating: 3, energyRating: 3 };
let mlRatings = { focus: 3, energy: 3 };

const MODES = { p25:{focus:25,brk:5}, p50:{focus:50,brk:10} };

function setMode(mode, btn) {
  if (tmr.running) return;
  tmr.mode = mode;
  tmr.phase = 'focus';
  tmr.elapsed = 0;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (mode === 'sw') {
    tmr.total = Infinity;
    updDisp(0); setPhaseLabel('STOPWATCH');
  } else {
    const mins = mode === 'custom' ? (pd().settings.customFocus || 45) : MODES[mode].focus;
    tmr.total = mins * 60;
    updDisp(0); setPhaseLabel('FOCUS');
  }
  updBar(); renderPomoDots();
}

function setPhaseLabel(t) {
  document.getElementById('timerPhase').textContent = t;
  document.getElementById('zenPhase').textContent = t;
}

function updDisp(elapsed) {
  const rem = tmr.total === Infinity ? elapsed : Math.max(0, tmr.total - elapsed);
  const t = `${String(Math.floor(rem/60)).padStart(2,'0')}:${String(rem%60).padStart(2,'0')}`;
  document.getElementById('timerDisp').textContent = t;
  document.getElementById('zenTimer').textContent = t;
}

function updBar() {
  const pct = tmr.total === Infinity ? 100 : Math.max(0, 100*(1 - tmr.elapsed/tmr.total));
  document.getElementById('timerBar').style.width = pct + '%';
  document.getElementById('zenBar').style.width = pct + '%';
}

function renderPomoDots() {
  const el = document.getElementById('pomoDots');
  if (tmr.mode === 'sw' || tmr.mode === 'custom') { el.innerHTML = ''; return; }
  el.innerHTML = Array.from({length:4},(_,i) => {
    let cls = 'pomo-dot';
    if (i < tmr.pomoCount) cls += ' done';
    else if (i === tmr.pomoCount && tmr.phase === 'focus') cls += ' current';
    return `<div class="${cls}"></div>`;
  }).join('');
}

function toggleTimer() {
  if (!tmr.running) {
    tmr.running = true; tmr.paused = false;
    tmr.sessionStart = new Date();
    document.getElementById('startBtn').textContent = 'â¸ Pause';
    document.getElementById('zenIcon').textContent = 'â¸';
    document.getElementById('zenLbl').textContent = 'Pause';
    document.getElementById('timerDisp').classList.add('running');
    tmr.interval = setInterval(tick, 1000);
  } else if (!tmr.paused) {
    tmr.paused = true;
    clearInterval(tmr.interval); tmr.interval = null;
    document.getElementById('startBtn').textContent = 'â–¶ Resume';
    document.getElementById('zenIcon').textContent = 'â–¶';
    document.getElementById('zenLbl').textContent = 'Resume';
    document.getElementById('timerDisp').classList.remove('running');
    document.getElementById('timerDisp').classList.add('paused');
  } else {
    tmr.paused = false;
    document.getElementById('startBtn').textContent = 'â¸ Pause';
    document.getElementById('zenIcon').textContent = 'â¸';
    document.getElementById('zenLbl').textContent = 'Pause';
    document.getElementById('timerDisp').classList.remove('paused');
    document.getElementById('timerDisp').classList.add('running');
    tmr.interval = setInterval(tick, 1000);
  }
}

function tick() {
  tmr.elapsed++;
  updDisp(tmr.elapsed); updBar();
  if (tmr.total !== Infinity && tmr.elapsed >= tmr.total) phaseComplete();
}

function stopTimer() {
  if (!tmr.running && tmr.elapsed === 0) return;
  clearInterval(tmr.interval); tmr.interval = null;
  const wasFocus = tmr.phase === 'focus';
  const mins = Math.floor(tmr.elapsed / 60);
  if (wasFocus && mins >= 1) promptSession(mins);
  resetTimer();
}

function skipPhase() { stopTimer(); }

function resetTimer() {
  tmr.running = false; tmr.paused = false; tmr.elapsed = 0; tmr.phase = 'focus';
  document.getElementById('startBtn').textContent = 'â–¶ Start';
  document.getElementById('zenIcon').textContent = 'â–¶';
  document.getElementById('zenLbl').textContent = 'Start';
  document.getElementById('timerDisp').classList.remove('running','paused');
  setPhaseLabel('FOCUS');
  setMode(tmr.mode, null);
}

function phaseComplete() {
  clearInterval(tmr.interval); tmr.interval = null;
  tmr.running = false; tmr.paused = false;
  beep();
  if (tmr.phase === 'focus') {
    const mins = Math.floor(tmr.elapsed / 60);
    if (mins >= 1) promptSession(mins);
    tmr.pomoCount = Math.min(4, tmr.pomoCount + 1);
    tmr.phase = 'break';
    setPhaseLabel('BREAK');
    const brkMins = tmr.mode === 'custom' ? (pd().settings.customBreak||10) : (MODES[tmr.mode]?.brk || 5);
    tmr.total = brkMins * 60;
    notify(`Focus done! ${brkMins}m break ğŸ‰`, 'success');
  } else {
    tmr.phase = 'focus';
    setPhaseLabel('FOCUS');
    const fMins = tmr.mode === 'custom' ? (pd().settings.customFocus||45) : (MODES[tmr.mode]?.focus || 25);
    tmr.total = fMins * 60;
    notify('Break over! Time to focus ğŸ’ª', 'info');
    if (tmr.pomoCount >= 4) { tmr.pomoCount = 0; notify('ğŸ… 4 Pomodoros complete! Great work.', 'success'); }
  }
  tmr.elapsed = 0;
  document.getElementById('startBtn').textContent = 'â–¶ Start';
  document.getElementById('zenIcon').textContent = 'â–¶';
  document.getElementById('zenLbl').textContent = 'Start';
  document.getElementById('timerDisp').classList.remove('running','paused');
  updDisp(0); updBar(); renderPomoDots();
  localStorage.removeItem(storageKey + '_crash');
}

function promptSession(mins) {
  pendS.durationMinutes = mins;
  pendS.subject = document.getElementById('curSubject').value;
  pendS.topic = document.getElementById('curTopic').value;
  pendS.type = document.getElementById('curType').value || 'General';
  pendS.startTime = tmr.sessionStart ? tmr.sessionStart.toISOString() : new Date().toISOString();
  // Pre-fill modal
  document.getElementById('sm_subject').value = pendS.subject || '';
  document.getElementById('sm_topic').value = pendS.topic || '';
  document.getElementById('sm_type').value = pendS.type || 'General';
  openModal('sessionModal');
}

function rate(type, val) {
  if (type === 'focus') {
    pendS.focusRating = val;
    document.querySelectorAll('#sm_focus .r-btn').forEach((b,i) => b.classList.toggle('sel', i+1===val));
  } else {
    pendS.energyRating = val;
    document.querySelectorAll('#sm_energy .r-btn').forEach((b,i) => b.classList.toggle('sel', i+1===val));
  }
}

function rateML(type, val) {
  mlRatings[type] = val;
  const id = type === 'focus' ? 'ml_focus' : 'ml_energy';
  // no ml_energy exists for energy but we track both via focus id pattern
  document.querySelectorAll(`#${id} .r-btn`).forEach((b,i) => b.classList.toggle('sel', i+1===val));
}

function saveSession(skip) {
  const subject = document.getElementById('sm_subject').value || pendS.subject || 'General';
  const topic = document.getElementById('sm_topic').value || pendS.topic || '';
  const type = document.getElementById('sm_type').value || pendS.type || 'General';
  const notes = document.getElementById('sm_notes').value || '';
  const session = {
    id: Date.now(),
    date: new Date().toISOString().split('T')[0],
    startTime: pendS.startTime || new Date().toISOString(),
    durationMinutes: pendS.durationMinutes || 0,
    subject, topic, type,
    focusRating: pendS.focusRating || 3,
    energyRating: pendS.energyRating || 3,
    notes,
    hour: new Date().getHours()
  };
  session.productiveMinutes = Math.round(session.durationMinutes * session.focusRating / 5);
  pd().sessions.push(session);
  updateStreak();
  saveState();
  checkBadges();
  closeModal('sessionModal');
  document.getElementById('sm_notes').value = '';
  pendS = { focusRating: 3, energyRating: 3 };
  refreshAll();
  localStorage.removeItem(storageKey + '_crash');
  notify(`Session logged! ${session.durationMinutes}m of ${subject} ğŸ“š`, 'success');
}

function saveManualSession() {
  const date = document.getElementById('ml_date').value || new Date().toISOString().split('T')[0];
  const subject = document.getElementById('ml_subject').value || 'General';
  const topic = document.getElementById('ml_topic').value || '';
  const duration = parseInt(document.getElementById('ml_duration').value) || 0;
  const type = document.getElementById('ml_type').value || 'General';
  const notes = document.getElementById('ml_notes').value || '';
  if (duration < 1) { notify('Enter a duration!', 'info'); return; }
  const session = {
    id: Date.now(),
    date, startTime: date + 'T00:00:00.000Z',
    durationMinutes: duration,
    subject, topic, type,
    focusRating: mlRatings.focus || 3,
    energyRating: mlRatings.energy || 3,
    notes, hour: 12, manual: true
  };
  session.productiveMinutes = Math.round(duration * session.focusRating / 5);
  pd().sessions.push(session);
  updateStreak();
  saveState();
  checkBadges();
  closeModal('manualModal');
  refreshAll();
  notify(`Manual session added! ${duration}m of ${subject}`, 'success');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STREAK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateStreak() {
  const today = new Date().toISOString().split('T')[0];
  const sessions = pd().sessions;
  if (!sessions.some(s => s.date === today)) return;
  if (!pd().lastStudyDate) {
    pd().streak = 1;
  } else {
    const diff = Math.floor((new Date(today) - new Date(pd().lastStudyDate)) / 86400000);
    if (diff === 1) pd().streak++;
    else if (diff > 1) pd().streak = 1;
  }
  pd().lastStudyDate = today;
  document.getElementById('streakNum').textContent = pd().streak;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function qaAdd() {
  const txt = document.getElementById('qaInput').value.trim();
  if (!txt) return;
  addTask(txt, document.getElementById('qaPri').value, document.getElementById('qaSubj').value, '');
  document.getElementById('qaInput').value = '';
}

function addTaskFull() {
  const txt = document.getElementById('t_text').value.trim();
  if (!txt) return;
  addTask(txt, document.getElementById('t_pri').value, document.getElementById('t_subj').value, document.getElementById('t_due').value);
  document.getElementById('t_text').value = '';
}

function addTask(text, priority='medium', subject='', dueDate='') {
  pd().tasks.unshift({ id: Date.now(), text, priority, subject, dueDate, done: false, createdAt: new Date().toISOString() });
  saveState(); refreshTasks();
  notify('Task added!', 'info');
}

function toggleTask(id) {
  const t = pd().tasks.find(t => t.id === id);
  if (!t) return;
  t.done = !t.done;
  if (t.done) t.doneAt = new Date().toISOString();
  saveState(); refreshTasks(); checkBadges();
}

function deleteTask(id) {
  pd().tasks = pd().tasks.filter(t => t.id !== id);
  saveState(); refreshTasks();
}

function makeTaskEl(task) {
  const el = document.createElement('div');
  el.className = 'task-item' + (task.done ? ' done' : '');
  el.innerHTML = `
    <div class="task-check ${task.done?'checked':''}" onclick="toggleTask(${task.id})"></div>
    <div class="pdot ${task.priority}"></div>
    <div style="flex:1">
      <div class="task-text">${esc(task.text)}</div>
      ${task.subject||task.dueDate ? `<div class="task-sub">${task.subject?esc(task.subject):''}${task.subject&&task.dueDate?' Â· ':''}${task.dueDate?fmtDate(task.dueDate):''}</div>` : ''}
    </div>
    <button class="task-del" onclick="deleteTask(${task.id})">âœ•</button>`;
  return el;
}

function refreshTasks() {
  const pending = pd().tasks.filter(t => !t.done);
  const done = pd().tasks.filter(t => t.done);

  const fill = (id, items, emptyMsg) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = '';
    if (items.length === 0) { el.innerHTML = `<div class="empty"><div class="empty-icon">âœ…</div>${emptyMsg}</div>`; return; }
    items.forEach(t => el.appendChild(makeTaskEl(t)));
  };

  fill('dashTaskList', pending.slice(0,5), 'No pending tasks!');
  fill('allTasksList', pending, 'No pending tasks!');
  fill('doneTasksList', done.slice(0,10), 'Complete tasks to see them here');

  // Due 48h
  const due48 = document.getElementById('due48List');
  if (due48) {
    const cutoff = new Date(Date.now() + 48*3600000);
    const upcoming = pending.filter(t => t.dueDate && new Date(t.dueDate+'T23:59:59') <= cutoff);
    due48.innerHTML = '';
    if (!upcoming.length) { due48.innerHTML = '<div style="font-size:12px;color:var(--text3)">None due soon</div>'; }
    else upcoming.forEach(t => due48.appendChild(makeTaskEl(t)));
  }

  // Planner tasks
  const ptl = document.getElementById('plannerTasks');
  if (ptl) {
    const sorted = pending.filter(t=>t.dueDate).sort((a,b)=>a.dueDate.localeCompare(b.dueDate));
    ptl.innerHTML = '';
    if (!sorted.length) ptl.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“…</div>No tasks with due dates</div>';
    else sorted.forEach(t => ptl.appendChild(makeTaskEl(t)));
  }

  // Counts
  const pc = document.getElementById('pendCnt');
  if (pc) pc.textContent = pending.length;

  const total = pd().tasks.length, doneCount = done.length;
  sEl('taskGT', `${doneCount}/${total}`);
  styleEl('taskGB', `width:${total?doneCount/total*100:0}%`);

  refreshSubjectDrops();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let noteTags = [];
let editingNoteId = null;

function noteFmt(cmd) {
  const ed = document.getElementById('noteEditor');
  ed.focus();
  if (cmd === 'h2') {
    document.execCommand('formatBlock', false, '<h3>');
  } else if (cmd === 'code') {
    document.execCommand('insertHTML', false, '<code style="background:var(--bg4);padding:2px 5px;border-radius:3px;font-family:var(--font-mono);font-size:12px">&nbsp;</code>');
  } else if (cmd === 'hr') {
    document.execCommand('insertHTML', false, '<hr style="border:none;border-top:1px solid var(--border);margin:12px 0">');
  } else {
    document.execCommand(cmd, false, null);
  }
}

function addNoteTag() {
  const v = document.getElementById('noteTagInput').value.trim();
  if (!v || noteTags.includes(v)) return;
  noteTags.push(v);
  document.getElementById('noteTagInput').value = '';
  renderNoteTagsDisplay();
}

function renderNoteTagsDisplay() {
  document.getElementById('noteTagsDisplay').innerHTML = noteTags.map((t,i) =>
    `<span class="note-tag">${esc(t)}<span class="note-tag-del" onclick="removeNoteTag(${i})">âœ•</span></span>`
  ).join('');
}

function removeNoteTag(i) { noteTags.splice(i,1); renderNoteTagsDisplay(); }

function clearNoteEditor() {
  document.getElementById('noteEditor').innerHTML = '';
  document.getElementById('note_title').value = '';
  noteTags = [];
  renderNoteTagsDisplay();
  editingNoteId = null;
}

function saveNote() {
  const title = document.getElementById('note_title').value.trim() || 'Untitled';
  const content = document.getElementById('noteEditor').innerHTML;
  const subject = document.getElementById('note_subj').value;
  if (!content || content === '<br>') { notify('Write something first!', 'info'); return; }

  if (editingNoteId) {
    const n = pd().notes.find(n => n.id === editingNoteId);
    if (n) { n.title = title; n.content = content; n.subject = subject; n.tags = [...noteTags]; n.updatedAt = new Date().toISOString(); }
  } else {
    pd().notes.unshift({ id: Date.now(), title, content, subject, tags: [...noteTags], createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
  }
  saveState(); clearNoteEditor(); renderNotes();
  notify('Note saved!', 'success');
}

function renderNotes() {
  const el = document.getElementById('notesList');
  if (!el) return;
  const q = (document.getElementById('noteSearch')?.value || '').toLowerCase();
  const notes = pd().notes.filter(n => !q || n.title.toLowerCase().includes(q) || n.content.toLowerCase().includes(q));
  el.innerHTML = '';
  if (!notes.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“</div>No notes yet</div>'; return; }
  notes.forEach(n => {
    const div = document.createElement('div');
    div.className = 'note-card';
    div.innerHTML = `
      <div class="note-card-title">${esc(n.title)}</div>
      <div class="note-card-preview">${n.content.replace(/<[^>]*>/g,' ')}</div>
      <div class="note-card-meta">${n.subject?esc(n.subject)+' Â· ':''}${fmtDate(n.updatedAt?.split('T')[0]||n.createdAt?.split('T')[0]||'')}</div>`;
    div.onclick = () => viewNote(n.id);
    el.appendChild(div);
  });
}

function viewNote(id) {
  const n = pd().notes.find(n => n.id === id);
  if (!n) return;
  const v = document.getElementById('noteViewer');
  v.style.display = 'block';
  v.style.marginTop = '14px';
  document.getElementById('noteViewTitle').textContent = n.title;
  document.getElementById('noteViewBody').innerHTML = n.content;
  document.getElementById('noteViewTags').innerHTML = n.tags.map(t => `<span class="note-tag">${esc(t)}</span>`).join('');
  v.scrollIntoView({ behavior: 'smooth' });
  editingNoteId = id;
}

function editNote() {
  if (!editingNoteId) return;
  const n = pd().notes.find(n => n.id === editingNoteId);
  if (!n) return;
  document.getElementById('note_title').value = n.title;
  document.getElementById('noteEditor').innerHTML = n.content;
  document.getElementById('note_subj').value = n.subject || '';
  noteTags = [...n.tags];
  renderNoteTagsDisplay();
  document.getElementById('noteViewer').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
  notify('Editing note â€” save to update', 'info');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUBJECTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let pickedColor = '#e8a832';

function pickColor(c, el) {
  pickedColor = c;
  document.querySelectorAll('#colorPick .r-btn').forEach(b => b.style.opacity = '.5');
  el.style.opacity = '1';
}

function saveSubject() {
  const name = document.getElementById('ns_name').value.trim();
  if (!name) return;
  pd().subjects.push({ id: Date.now(), name, color: pickedColor });
  document.getElementById('ns_name').value = '';
  closeModal('addSubjectModal');
  saveState(); refreshSubjects(); refreshSubjectDrops();
  notify(`Subject "${name}" added!`, 'success');
}

function refreshSubjects() {
  const c = document.getElementById('subjectCards');
  if (!c) return;
  c.innerHTML = '';
  if (!pd().subjects.length) { c.innerHTML = '<div class="empty card"><div class="empty-icon">ğŸ“š</div>Add your first subject</div>'; return; }
  const maxMins = Math.max(...pd().subjects.map(s => pd().sessions.filter(x=>x.subject===s.name).reduce((a,x)=>a+x.durationMinutes,0)), 1);
  pd().subjects.forEach(s => {
    const sess = pd().sessions.filter(x => x.subject === s.name);
    const mins = sess.reduce((a,x)=>a+x.durationMinutes,0);
    const avgF = sess.length ? (sess.reduce((a,x)=>a+x.focusRating,0)/sess.length).toFixed(1) : 'â€”';
    const el = document.createElement('div');
    el.className = 'subject-card';
    el.style.setProperty('--subject-color', s.color);
    el.innerHTML = `
      <div class="subject-name">${esc(s.name)}</div>
      <div class="s-stats">
        <div class="s-stat"><strong>${fmtMins(mins)}</strong> studied</div>
        <div class="s-stat"><strong>${sess.length}</strong> sessions</div>
        <div class="s-stat"><strong>${avgF}</strong> avg focus</div>
      </div>
      <div class="s-bar"><div class="s-bar-fill" style="width:${mins/maxMins*100}%;background:${s.color}"></div></div>
      <div style="text-align:right;margin-top:9px">
        <button class="btn btn-ghost btn-sm" onclick="delSubject(${s.id})" style="color:var(--red);border-color:var(--red)">Remove</button>
      </div>`;
    c.appendChild(el);
  });
}

function delSubject(id) {
  pd().subjects = pd().subjects.filter(s => s.id !== id);
  saveState(); refreshSubjects(); refreshSubjectDrops();
}

function refreshSubjectDrops() {
  ['curSubject','qaSubj','t_subj','ml_subject','sm_subject','note_subj'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const cur = el.value;
    const placeholder = id === 'curSubject' ? 'Subjectâ€¦' : id === 'sm_subject' ? '' : 'Subjectâ€¦';
    el.innerHTML = `<option value="">${placeholder}</option>` +
      pd().subjects.map(s => `<option value="${esc(s.name)}" ${s.name===cur?'selected':''}>${esc(s.name)}</option>`).join('');
  });
}

function onSubjectChange() {
  pd().lastSubject = document.getElementById('curSubject').value;
  updateZenTask();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXAMS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveExam() {
  const name = document.getElementById('ne_name').value.trim();
  const date = document.getElementById('ne_date').value;
  if (!name || !date) return;
  pd().exams.push({ id: Date.now(), name, date });
  document.getElementById('ne_name').value = '';
  document.getElementById('ne_date').value = '';
  closeModal('addExamModal');
  saveState(); refreshExams();
  notify('Exam added!', 'success');
}

function refreshExams() {
  const el = document.getElementById('examList');
  if (!el) return;
  const today = new Date(); today.setHours(0,0,0,0);
  const sorted = [...pd().exams].sort((a,b)=>a.date.localeCompare(b.date));
  if (!sorted.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“…</div>No exams added yet</div>'; return; }
  el.innerHTML = sorted.map(e => {
    const d = new Date(e.date+'T00:00:00');
    const diff = Math.ceil((d-today)/86400000);
    return `<div class="exam-item">
      <div><div class="exam-name">${esc(e.name)}</div><div class="exam-date">${fmtDate(e.date)}</div></div>
      <div style="text-align:right;display:flex;align-items:center;gap:10px">
        <div><div class="exam-days ${diff<=7?'urgent':''}">${diff<0?'PAST':diff}</div><div class="exam-days-lbl">${diff>=0?'days left':''}</div></div>
        <button class="task-del" style="opacity:1" onclick="delExam(${e.id})">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

function delExam(id) { pd().exams = pd().exams.filter(e=>e.id!==id); saveState(); refreshExams(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LINKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveLink() {
  const name = document.getElementById('nl_name').value.trim();
  const url = document.getElementById('nl_url').value.trim();
  if (!name||!url) return;
  pd().links.push({ id: Date.now(), name, url });
  document.getElementById('nl_name').value = '';
  document.getElementById('nl_url').value = '';
  closeModal('addLinkModal');
  saveState(); refreshLinks();
}

function refreshLinks() {
  const el = document.getElementById('linksList');
  if (!el) return;
  if (!pd().links.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ”—</div>Add links to resourcesâ€¦</div>'; return; }
  el.innerHTML = pd().links.map(l =>
    `<a href="${esc(l.url)}" target="_blank" rel="noopener" class="link-item">
      <div><div class="link-name">${esc(l.name)}</div><div class="link-url">${esc(l.url.replace(/^https?:\/\//,'').slice(0,50))}</div></div>
      <span style="color:var(--text3)">â†—</span>
    </a>`
  ).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANALYTICS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let charts = {};

function refreshAnalytics() {
  const last7 = [], labels = [];
  for (let i=6;i>=0;i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    last7.push(d.toISOString().split('T')[0]);
    labels.push(['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()]);
  }
  const weekData = last7.map(d => pd().sessions.filter(s=>s.date===d).reduce((a,s)=>a+s.productiveMinutes,0));

  rebuildChart('wChart','bar',{labels, datasets:[{label:'Productive Min',data:weekData,backgroundColor:'rgba(232,168,50,.55)',borderColor:'#e8a832',borderWidth:1,borderRadius:5}]}, chartOpts());

  // Pie
  const subTotals = {};
  pd().sessions.forEach(s => { subTotals[s.subject||'General'] = (subTotals[s.subject||'General']||0)+s.durationMinutes; });
  const sNames = Object.keys(subTotals);
  const sColors = ['#e8a832','#68a8e8','#6fcf87','#a868e8','#e86868','#68e8c8','#e8c168'];
  if (sNames.length) {
    rebuildChart('pChart','doughnut',{labels:sNames,datasets:[{data:sNames.map(n=>subTotals[n]),backgroundColor:sNames.map((_,i)=>sColors[i%sColors.length]),borderWidth:0}]},
      {...chartOpts(),cutout:'62%',plugins:{legend:{position:'right',labels:{color:'#a09880',font:{family:'DM Mono',size:10},boxWidth:10}}}});
  } else {
    const c = document.getElementById('pChart');
    if (c) c.parentElement.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“Š</div>No sessions yet</div>';
  }

  // Focus/Energy trend
  const last10 = pd().sessions.slice(-10);
  rebuildChart('fChart','line',{
    labels: last10.map((_,i)=>`#${i+1}`),
    datasets:[
      {label:'Focus',data:last10.map(s=>s.focusRating),borderColor:'#68a8e8',backgroundColor:'rgba(104,168,232,.1)',tension:.4,fill:true,pointRadius:3},
      {label:'Energy',data:last10.map(s=>s.energyRating),borderColor:'#6fcf87',backgroundColor:'rgba(111,207,135,.1)',tension:.4,fill:true,pointRadius:3}
    ]
  }, {...chartOpts(), scales:{y:{min:0,max:5,...axisS()},x:axisS(true)}});

  // Session type breakdown
  const typeTotals = {};
  pd().sessions.forEach(s => { typeTotals[s.type||'General'] = (typeTotals[s.type||'General']||0)+s.durationMinutes; });
  const tNames = Object.keys(typeTotals);
  rebuildChart('tChart','bar',{
    labels: tNames,
    datasets:[{label:'Minutes',data:tNames.map(n=>typeTotals[n]),backgroundColor:'rgba(168,104,232,.55)',borderColor:'#a868e8',borderWidth:1,borderRadius:5}]
  }, {...chartOpts(), indexAxis:'y'});

  // Daily report
  const byDay = {};
  pd().sessions.forEach(s => { if(!byDay[s.date]) byDay[s.date]=[]; byDay[s.date].push(s); });
  const days = Object.keys(byDay).sort().reverse();
  const dr = document.getElementById('dailyReport');
  if (dr) {
    if (!days.length) { dr.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“‹</div>No data yet</div>'; return; }
    dr.innerHTML = days.slice(0,30).map(d => {
      const sess = byDay[d];
      const mins = sess.reduce((a,s)=>a+s.durationMinutes,0);
      const prod = sess.reduce((a,s)=>a+s.productiveMinutes,0);
      const avgF = (sess.reduce((a,s)=>a+s.focusRating,0)/sess.length).toFixed(1);
      const subjs = [...new Set(sess.map(s=>s.subject))].join(', ');
      return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
        <div><div style="font-size:13.5px;color:var(--text)">${d}</div><div style="font-size:11px;color:var(--text3)">${subjs}</div></div>
        <div style="display:flex;gap:18px;text-align:right">
          <div><div style="font-family:var(--font-mono);font-size:15px;color:var(--text)">${fmtMins(mins)}</div><div style="font-size:10px;color:var(--text3)">studied</div></div>
          <div><div style="font-family:var(--font-mono);font-size:15px;color:var(--accent)">${fmtMins(prod)}</div><div style="font-size:10px;color:var(--text3)">productive</div></div>
          <div><div style="font-family:var(--font-mono);font-size:15px;color:var(--blue)">${avgF}</div><div style="font-size:10px;color:var(--text3)">focus</div></div>
        </div>
      </div>`;
    }).join('');
  }
}

function rebuildChart(id, type, data, options) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
  const canvas = document.getElementById(id);
  if (!canvas) return;
  charts[id] = new Chart(canvas.getContext('2d'), { type, data, options });
}

function chartOpts() {
  return {
    responsive: true, maintainAspectRatio: true,
    plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1e1c19', titleColor: '#f0ead8', bodyColor: '#a09880', borderColor: '#2e2c28', borderWidth: 1 } },
    scales: { y: axisS(), x: axisS(true) }
  };
}

function axisS(x=false) {
  return { grid:{ color:'rgba(90,85,72,.15)', drawBorder:false }, ticks:{ color:'#5a5548', font:{ family:'DM Mono', size:9 } }, border:{ display:false } };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEATMAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function refreshHeatmap() {
  const hm = document.getElementById('heatmap');
  if (!hm) return;
  hm.innerHTML = '';

  const today = new Date(); today.setHours(0,0,0,0);
  // Find start: go back to last Monday 52 weeks ago
  const start = new Date(today);
  start.setDate(today.getDate() - 52*7);
  // Align to Monday
  const dow = (start.getDay()+6)%7;
  start.setDate(start.getDate() - dow);

  // Build day map
  const dayMap = {};
  pd().sessions.forEach(s => { dayMap[s.date] = (dayMap[s.date]||0) + s.durationMinutes; });

  // Find max for level calc
  const maxMins = Math.max(...Object.values(dayMap), 1);

  // Generate columns (each = 1 week Mon-Sun)
  const numWeeks = Math.ceil((today - start) / (7*86400000)) + 1;
  const monthsSeen = [];

  for (let w = 0; w < numWeeks; w++) {
    const col = document.createElement('div');
    col.className = 'hm-col';
    for (let d = 0; d < 7; d++) {
      const date = new Date(start);
      date.setDate(start.getDate() + w*7 + d);
      if (date > today) { const spacer=document.createElement('div'); spacer.style.width='13px'; spacer.style.height='13px'; col.appendChild(spacer); continue; }
      const key = date.toISOString().split('T')[0];
      const mins = dayMap[key] || 0;
      let lvl = 0;
      if (mins > 0) lvl = mins < maxMins*0.25 ? 1 : mins < maxMins*0.5 ? 2 : mins < maxMins*0.75 ? 3 : 4;
      const cell = document.createElement('div');
      cell.className = `hm-cell${lvl?' l'+lvl:''}`;
      cell.setAttribute('data-tip', `${key}: ${fmtMins(mins)}`);
      col.appendChild(cell);
    }
    hm.appendChild(col);
  }

  // Day labels
  const daysEl = document.getElementById('hmDays');
  if (daysEl) {
    daysEl.innerHTML = ['Mo','','We','','Fr','','Su'].map(l =>
      `<div class="hm-day-label">${l}</div>`).join('');
  }

  // Stats
  let longestStrk = 0, curStrk = 0, prevDate = null;
  const allDays = Object.keys(dayMap).sort();
  allDays.forEach(d => {
    if (prevDate) {
      const diff = Math.floor((new Date(d) - new Date(prevDate))/86400000);
      if (diff === 1) curStrk++;
      else curStrk = 1;
    } else curStrk = 1;
    if (curStrk > longestStrk) longestStrk = curStrk;
    prevDate = d;
  });

  const bestDay = allDays.length ? allDays.reduce((a,b)=>(dayMap[a]||0)>(dayMap[b]||0)?a:b) : null;
  sEl('bestDay', bestDay ? `${bestDay} (${fmtMins(dayMap[bestDay])})` : 'â€”');
  sEl('longestStreak', longestStrk + ' days');

  // Active weeks
  const weekSet = new Set();
  allDays.forEach(d => { const dt=new Date(d); const wk=dt.getFullYear()+'W'+Math.floor((dt-new Date(dt.getFullYear(),0,1))/(7*86400000)); weekSet.add(wk); });
  sEl('activeWeeks', weekSet.size);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BADGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BADGES = [
  { id:'first_session', icon:'ğŸ¯', name:'First Step', desc:'Complete 1 session' },
  { id:'ten_sessions', icon:'ğŸ”Ÿ', name:'Ten Deep', desc:'Complete 10 sessions' },
  { id:'fifty_sessions', icon:'ğŸ’¯', name:'Half Century', desc:'Complete 50 sessions' },
  { id:'one_hour', icon:'â°', name:'One Hour', desc:'Study 1 hour total' },
  { id:'ten_hours', icon:'ğŸ“š', name:'10 Hours', desc:'Study 10 hours total' },
  { id:'fifty_hours', icon:'ğŸ›', name:'Scholar', desc:'Study 50 hours total' },
  { id:'streak_3', icon:'ğŸ”¥', name:'On Fire', desc:'3-day streak' },
  { id:'streak_7', icon:'âš¡', name:'Weekly Warrior', desc:'7-day streak' },
  { id:'streak_30', icon:'ğŸŒŸ', name:'Monthly Master', desc:'30-day streak' },
  { id:'night_owl', icon:'ğŸ¦‰', name:'Night Owl', desc:'Study after 10pm' },
  { id:'early_bird', icon:'ğŸŒ…', name:'Early Bird', desc:'Study before 7am' },
  { id:'five_subjects', icon:'ğŸ§ ', name:'Polymath', desc:'Study 5+ subjects' },
  { id:'perfect_focus', icon:'ğŸ’', name:'Perfect Focus', desc:'Rate 5/5 focus' },
  { id:'task_master', icon:'âœ…', name:'Task Master', desc:'Complete 20 tasks' },
  { id:'all_types', icon:'ğŸ¨', name:'Versatile', desc:'Use all session types' },
  { id:'note_taker', icon:'ğŸ“', name:'Note Taker', desc:'Save 5 notes' },
];

function checkBadges() {
  const s = pd().sessions;
  const tasks = pd().tasks;
  const earned = pd().earnedBadges || [];

  const earn = (id) => { if (!earned.includes(id)) { earned.push(id); notify(`ğŸ† Badge unlocked: ${BADGES.find(b=>b.id===id)?.name}!`, 'success'); } };

  const totalMins = s.reduce((a,x)=>a+x.durationMinutes,0);
  if (s.length >= 1) earn('first_session');
  if (s.length >= 10) earn('ten_sessions');
  if (s.length >= 50) earn('fifty_sessions');
  if (totalMins >= 60) earn('one_hour');
  if (totalMins >= 600) earn('ten_hours');
  if (totalMins >= 3000) earn('fifty_hours');
  if ((pd().streak||0) >= 3) earn('streak_3');
  if ((pd().streak||0) >= 7) earn('streak_7');
  if ((pd().streak||0) >= 30) earn('streak_30');
  if (s.some(x=>x.hour>=22)) earn('night_owl');
  if (s.some(x=>x.hour<7)) earn('early_bird');
  if (new Set(s.map(x=>x.subject)).size >= 5) earn('five_subjects');
  if (s.some(x=>x.focusRating===5)) earn('perfect_focus');
  if (tasks.filter(t=>t.done).length >= 20) earn('task_master');
  const allTypes = ['Active Recall','Reading','Problem Solving','Revision','Lecture','Writing','Research'];
  if (allTypes.every(t=>s.some(x=>x.type===t))) earn('all_types');
  if ((pd().notes||[]).length >= 5) earn('note_taker');

  pd().earnedBadges = earned;
  saveState();
}

function renderBadges() {
  const el = document.getElementById('badgesGrid');
  if (!el) return;
  const earned = pd().earnedBadges || [];
  el.innerHTML = BADGES.map(b => `
    <div class="badge ${earned.includes(b.id)?'earned':''}" title="${b.desc}">
      <div class="badge-icon">${b.icon}</div>
      <div class="badge-name">${b.name}</div>
      <div class="badge-desc">${b.desc}</div>
    </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEEKLY REVIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildWeeklyReview() {
  const el = document.getElementById('weeklyReview');
  if (!el) return;
  const now = new Date();
  const dow = (now.getDay()+6)%7;
  const wStart = new Date(now); wStart.setDate(now.getDate()-dow); wStart.setHours(0,0,0,0);
  const pStart = new Date(wStart); pStart.setDate(wStart.getDate()-7);

  const thisWeek = pd().sessions.filter(s=>new Date(s.date)>=wStart);
  const lastWeek = pd().sessions.filter(s=>{ const d=new Date(s.date); return d>=pStart && d<wStart; });
  const thisMins = thisWeek.reduce((a,s)=>a+s.durationMinutes,0);
  const lastMins = lastWeek.reduce((a,s)=>a+s.durationMinutes,0);
  const thisProductive = thisWeek.reduce((a,s)=>a+s.productiveMinutes,0);
  const change = lastMins>0 ? Math.round((thisMins-lastMins)/lastMins*100) : null;
  const subjects = [...new Set(thisWeek.map(s=>s.subject||'General'))];
  const topSubj = subjects.length ? subjects.reduce((a,b)=> {
    const am = thisWeek.filter(s=>(s.subject||'General')===a).reduce((x,s)=>x+s.durationMinutes,0);
    const bm = thisWeek.filter(s=>(s.subject||'General')===b).reduce((x,s)=>x+s.durationMinutes,0);
    return am>bm?a:b;
  }) : null;

  if (thisMins === 0) { el.innerHTML = '<div class="review-headline">No sessions this week yet.</div><div class="review-body">Start a timer to begin tracking your progress!</div>'; return; }

  const changeStr = change === null ? '' : change > 0
    ? ` â€” <span class="review-highlight">â†‘${change}% vs last week</span>`
    : change < 0
    ? ` â€” <span style="color:var(--red)">â†“${Math.abs(change)}% vs last week</span>`
    : ' â€” Same as last week';

  el.innerHTML = `
    <div class="review-headline">This week: <span style="color:var(--accent)">${fmtMins(thisMins)}</span>${changeStr}</div>
    <div class="review-body" style="margin-top:6px">
      ${thisWeek.length} session${thisWeek.length!==1?'s':''} &nbsp;Â·&nbsp; 
      <span class="review-highlight">${fmtMins(thisProductive)}</span> productive minutes &nbsp;Â·&nbsp;
      ${topSubj ? `Most studied: <span class="review-highlight">${esc(topSubj)}</span>` : ''}
      ${(pd().streak||0)>0 ? ` &nbsp;Â·&nbsp; ğŸ”¥ ${pd().streak}-day streak` : ''}
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function refreshDashboard() {
  const today = new Date().toISOString().split('T')[0];
  const todaySess = pd().sessions.filter(s=>s.date===today);
  const todayMins = todaySess.reduce((a,s)=>a+s.durationMinutes,0);
  const todayProd = todaySess.reduce((a,s)=>a+s.productiveMinutes,0);

  const now = new Date();
  const dow = (now.getDay()+6)%7;
  const wStart = new Date(now); wStart.setDate(now.getDate()-dow); wStart.setHours(0,0,0,0);
  const weekMins = pd().sessions.filter(s=>new Date(s.date)>=wStart).reduce((a,s)=>a+s.durationMinutes,0);

  sEl('todayHrs', fmtMins(todayMins));
  sEl('todaySess', todaySess.length);
  sEl('weekHrs', fmtMinsShort(weekMins));
  sEl('prodMin', fmtMins(todayProd));
  sEl('streakNum', pd().streak||0);

  const dg = pd().goals.daily||120, wg = pd().goals.weekly||600;
  const dp = Math.min(100,Math.round(todayMins/dg*100));
  const wp = Math.min(100,Math.round(weekMins/wg*100));
  sEl('dailyGT',`${todayMins}/${dg}m`);
  sEl('weeklyGT',`${weekMins}/${wg}m`);
  styleEl('dailyGB',`width:${dp}%`);
  styleEl('weeklyGB',`width:${wp}%`);
  sEl('ringPct',dp+'%');
  const off = 251.33 - (dp/100*251.33);
  const rc = document.getElementById('ringCircle');
  if (rc) rc.style.strokeDashoffset = off;

  buildWeeklyReview();

  // Goals page
  const gs = document.getElementById('goalsSummary');
  if (gs) {
    gs.innerHTML = `
      <div class="goal-item"><div class="goal-hd"><span class="goal-name">Today</span><span class="goal-txt">${fmtMins(todayMins)} / ${dg}m</span></div><div class="goal-bar"><div class="goal-fill" style="width:${dp}%;background:var(--accent)"></div></div></div>
      <div class="goal-item"><div class="goal-hd"><span class="goal-name">This Week</span><span class="goal-txt">${fmtMins(weekMins)} / ${wg}m</span></div><div class="goal-bar"><div class="goal-fill" style="width:${wp}%;background:var(--blue)"></div></div></div>
      <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);font-size:13px;color:var(--text2);line-height:2">
        <div>ğŸ”¥ Streak: <strong style="color:var(--accent)">${pd().streak||0} days</strong></div>
        <div>ğŸ“š Total Sessions: <strong style="color:var(--text)">${pd().sessions.length}</strong></div>
        <div>â± Total Studied: <strong style="color:var(--text)">${fmtMins(pd().sessions.reduce((a,s)=>a+s.durationMinutes,0))}</strong></div>
        <div>ğŸ§  Productive: <strong style="color:var(--accent)">${fmtMins(pd().sessions.reduce((a,s)=>a+s.productiveMinutes,0))}</strong></div>
      </div>`;
  }
}

function refreshLog() {
  const el = document.getElementById('logBody');
  if (!el) return;
  if (!pd().sessions.length) {
    el.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text3);padding:22px">No sessions yet. Complete a timer session or add one manually.</td></tr>';
    return;
  }
  el.innerHTML = [...pd().sessions].reverse().map(s => `
    <tr class="log-row" onclick="toggleLogRow(${s.id})">
      <td style="color:var(--text)">${s.date}</td>
      <td style="color:var(--accent)">${esc(s.subject||'â€”')}</td>
      <td>${esc(s.topic||'â€”')}</td>
      <td><span class="type-badge">${esc(s.type||'General')}</span></td>
      <td style="font-family:var(--font-mono)">${s.durationMinutes}m</td>
      <td><span class="focus-stars">${'â˜…'.repeat(s.focusRating)}</span></td>
      <td><span class="focus-stars" style="color:var(--green)">${'â˜…'.repeat(s.energyRating)}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-family:var(--font-mono);color:var(--text2)">${s.productiveMinutes}m</span>
          <button onclick="event.stopPropagation();deleteSession(${s.id})"
            style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;padding:2px 6px;border-radius:4px;transition:all .2s"
            onmouseover="this.style.color='#e86868'" onmouseout="this.style.color='var(--text3)'">âœ•</button>
        </div>
      </td>
    </tr>
    <tr class="log-expand" id="expand-${s.id}">
      <td colspan="8">
        ${s.notes ? `<div style="margin-bottom:6px"><strong style="color:var(--text)">Notes:</strong> ${esc(s.notes)}</div>` : '<em style="color:var(--text3)">No notes</em>'}
        ${s.manual ? '<span style="font-family:var(--font-mono);font-size:10px;color:var(--text3);background:var(--bg4);padding:2px 7px;border-radius:100px">manually added</span>' : ''}
        <div style="margin-top:6px;font-size:11px;color:var(--text3)">
          Started: ${s.startTime ? new Date(s.startTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : 'â€”'}
          &nbsp;Â·&nbsp; Hour: ${s.hour ?? 'â€”'}:00
        </div>
      </td>
    </tr>`).join('');
}
function deleteSession(id) {
  if (!confirm('Delete this session? This cannot be undone.')) return;
  pd().sessions = pd().sessions.filter(s => s.id !== id);
  saveState(); refreshAll();
  notify('Session deleted.', 'info');
}
function toggleLogRow(id) {
  const el = document.getElementById('expand-'+id);
  if (el) el.classList.toggle('open');
}

function refreshWeekPlanner() {
  const el = document.getElementById('weekPlanner');
  if (!el) return;
  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const now = new Date();
  const dow = (now.getDay()+6)%7;
  el.innerHTML = days.map((day,i) => {
    const d = new Date(now); d.setDate(now.getDate()-dow+i);
    const key = d.toISOString().split('T')[0];
    const mins = pd().sessions.filter(s=>s.date===key).reduce((a,s)=>a+s.durationMinutes,0);
    const isToday = i===dow;
    const pct = Math.min(100, mins/(pd().goals.daily||120)*100);
    return `<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border)">
      <div style="width:28px;font-family:var(--font-mono);font-size:11px;color:${isToday?'var(--accent)':'var(--text3)'}">${day}</div>
      <div style="flex:1;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${isToday?'var(--accent)':'var(--text3)'};border-radius:3px;transition:width .5s"></div></div>
      <div style="font-family:var(--font-mono);font-size:10px;color:var(--text3);width:34px;text-align:right">${mins>0?fmtMinsShort(mins):''}</div>
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOALS & SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveGoals() {
  pd().goals.daily = parseInt(document.getElementById('g_daily').value)||120;
  pd().goals.weekly = parseInt(document.getElementById('g_weekly').value)||600;
  saveState(); refreshDashboard();
  notify('Goals saved!', 'success');
}

function saveSettings() {
  pd().settings.customFocus = parseInt(document.getElementById('s_focus').value)||45;
  pd().settings.customBreak = parseInt(document.getElementById('s_break').value)||10;
  saveState();
  notify('Settings saved!', 'success');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOUNDS (Web Audio)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let audioCtx = null, activeSounds = {}, soundVol = 0.3;

function getCtx() { return audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)(); }

function toggleSound(type, btn) {
  if (activeSounds[type]) {
    activeSounds[type].forEach(n=>{try{n.stop()}catch(e){}});
    delete activeSounds[type];
    btn.classList.remove('active');
  } else {
    btn.classList.add('active');
    playAmbient(type);
  }
}

function playAmbient(type) {
  const ctx = getCtx(); const nodes = [];
  const noise = (dur=2, freq=800, gain=0.3) => {
    const buf = ctx.createBuffer(1, ctx.sampleRate*dur, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.5;
    const src = ctx.createBufferSource(); src.buffer=buf; src.loop=true;
    const f = ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=freq;
    const g = ctx.createGain(); g.gain.value=soundVol*gain;
    src.connect(f); f.connect(g); g.connect(ctx.destination); src.start();
    return src;
  };
  if (type==='rain') { nodes.push(noise(2,700,.4), noise(2,1200,.2), noise(2,400,.15)); }
  else if (type==='fire') { nodes.push(noise(2,300,.35)); }
  else if (type==='ocean') { nodes.push(noise(4,500,.4), noise(4,300,.2)); }
  else if (type==='forest') { nodes.push(noise(3,2000,.15)); }
  else if (type==='cafe') {
    for (let i=0;i<4;i++) {
      const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type='sine'; o.frequency.value=150+Math.random()*300;
      g.gain.value=0; o.connect(g); g.connect(ctx.destination); o.start();
      const m=()=>{const t=ctx.currentTime;g.gain.setTargetAtTime(soundVol*.02*Math.random(),t,.1);g.gain.setTargetAtTime(0,t+.3+Math.random()*.5,.1);setTimeout(m,500+Math.random()*1000)};
      m(); nodes.push(o);
    }
  }
  activeSounds[type] = nodes;
}

function setVol(v) { soundVol = parseFloat(v); }

function beep() {
  try {
    const ctx=getCtx(); const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(880,ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(440,ctx.currentTime+.3);
    g.gain.setValueAtTime(.25,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.4);
    o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+.4);
  } catch(e){}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMBED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadEmbed() {
  const url = document.getElementById('embedUrl').value.trim();
  if (!url) return;
  document.getElementById('embedBox').innerHTML = `<iframe src="${url}" width="100%" height="200" frameborder="0" allow="autoplay" style="border-radius:var(--radius-sm);border:1px solid var(--border)"></iframe>`;
}
function clearEmbed() { document.getElementById('embedBox').innerHTML=''; document.getElementById('embedUrl').value=''; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZEN MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleZen() { document.getElementById('zenOv').classList.toggle('active'); updateZenTask(); }
function updateZenTask() {
  const topic = document.getElementById('curTopic').value || document.getElementById('curSubject').value || 'No task set';
  document.getElementById('zenTask').textContent = topic;
}
document.addEventListener('keydown', e => { if(e.key==='Escape') document.getElementById('zenOv').classList.remove('active'); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD SHORTCUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let kbdHudVisible = false;
document.addEventListener('keydown', e => {
  const tag = document.activeElement.tagName.toLowerCase();
  if (['input','textarea','select'].includes(tag) || document.activeElement.contentEditable==='true') return;
  if (e.code==='Space') { e.preventDefault(); toggleTimer(); }
  if (e.key.toLowerCase()==='s') stopTimer();
  if (e.key.toLowerCase()==='z') toggleZen();
  if (e.key.toLowerCase()==='m') openModal('manualModal');
  if (e.key==='?') {
    kbdHudVisible = !kbdHudVisible;
    document.getElementById('kbdHud').classList.toggle('show', kbdHudVisible);
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const themes = ['dark','dim','light'];
let themeIdx = 0;

function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('focusTheme', t);
  const icons = { dark:'ğŸŒ‘', dim:'ğŸŒ˜', light:'â˜€' };
  document.getElementById('themeBtn').textContent = icons[t] || 'â˜€';
}

function cycleTheme() {
  themeIdx = (themeIdx+1) % themes.length;
  setTheme(themes[themeIdx]);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PAGE_TITLES = {
  dashboard:'Dashboard', log:'Study Log', tasks:'Tasks', notes:'Notes',
  analytics:'Analytics', heatmap:'Calendar', badges:'Badges', subjects:'Subjects',
  planner:'Planner', goals:'Goals', focus:'Focus Tools', settings:'Settings'
};

function nav(page, btn) {
  document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  if (btn) btn.classList.add('active');
  document.getElementById('pageTitle').textContent = PAGE_TITLES[page]||page;
  if (window.innerWidth<=900) document.getElementById('sidebar').classList.remove('open');

  // Lazy refresh
  if (page==='analytics') setTimeout(refreshAnalytics,50);
  if (page==='heatmap') { refreshHeatmap(); }
  if (page==='badges') renderBadges();
  if (page==='goals') {
    document.getElementById('g_daily').value = pd().goals.daily||120;
    document.getElementById('g_weekly').value = pd().goals.weekly||600;
  }
  if (page==='settings') {
    document.getElementById('s_focus').value = pd().settings.customFocus||45;
    document.getElementById('s_break').value = pd().settings.customBreak||10;
  }
  if (page==='notes') renderNotes();
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT / IMPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportCSV() {
  const rows = [['Date','Subject','Topic','Type','Duration','Focus','Energy','Productive','Notes','Manual']];
  pd().sessions.forEach(s => rows.push([s.date,s.subject,s.topic,s.type||'General',s.durationMinutes,s.focusRating,s.energyRating,s.productiveMinutes,s.notes,s.manual?'yes':'no']));
  dl('focus-sessions.csv', rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n'), 'text/csv');
}

function exportJSON() { dl('focus-data.json', JSON.stringify({profiles,currentProfile},null,2),'application/json'); }

function importJSON(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const d = JSON.parse(ev.target.result);
      if (d.profiles) { profiles = d.profiles; currentProfile = d.currentProfile||Object.keys(d.profiles)[0]; }
      else if (d.sessions) { pd().sessions = d.sessions; } // legacy import
      saveState(); refreshAll();
      notify('Data imported successfully!', 'success');
    } catch(err) { notify('Import failed: invalid JSON', 'info'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function dl(name, content, type) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content],{type}));
  a.download = name; a.click();
}

function clearAll() {
  if (!confirm('Clear ALL data for current profile? Cannot be undone.')) return;
  profiles[currentProfile] = blankProfile();
  saveState(); refreshAll();
  notify('Profile data cleared.', 'info');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLOCK + QUOTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QUOTES = [
  "The secret of getting ahead is getting started.",
  "It always seems impossible until it's done.",
  "Focus on being productive instead of busy.",
  "One step at a time is all it takes.",
  "You don't have to be great to start, but you have to start to be great.",
  "Study hard, for the well is deep, and our brains are shallow.",
  "The more that you read, the more things you will know.",
  "Education is the passport to the future.",
  "An investment in knowledge pays the best interest.",
  "The beautiful thing about learning is that no one can take it away from you.",
  "Push yourself, because no one else is going to do it for you.",
  "Great things never come from comfort zones.",
  "Dream it. Wish it. Do it.",
];
let quoteIdx = Math.floor(Math.random() * QUOTES.length);

function updateClock() {
  const n = new Date();
  const t = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;
  const el = document.getElementById('topClock'); if (el) el.textContent = t;
  const ze = document.getElementById('zenClock'); if (ze) ze.textContent = t;
}

function rotateQuote() {
  quoteIdx = (quoteIdx+1) % QUOTES.length;
  const el = document.getElementById('quoteStrip');
  if (el) { el.style.opacity='0'; setTimeout(()=>{ el.textContent='"'+QUOTES[quoteIdx]+'"'; el.style.opacity='1'; },400); }
}

setInterval(updateClock, 1000);
setInterval(rotateQuote, 30000);
updateClock();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtMins(m) { if(m<60) return m+'m'; return Math.floor(m/60)+'h '+(m%60)+'m'; }
function fmtMinsShort(m) { if(m<60) return m+'m'; return Math.floor(m/60)+'h'; }
function fmtDate(s) { if(!s) return ''; try { const d=new Date(s+'T00:00:00'); return d.toLocaleDateString('en-US',{month:'short',day:'numeric'}); } catch(e){return s;} }
function sEl(id, val) { const e=document.getElementById(id); if(e) e.textContent=val; }
function styleEl(id, css) { const e=document.getElementById(id); if(e) e.style.cssText+= ';'+css; }
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-ov').forEach(m=>m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('active'); }));

function notify(msg, type='info') {
  const el=document.getElementById('notif');
  el.textContent=msg; el.className='notif '+type+' show';
  clearTimeout(window._notifT);
  window._notifT = setTimeout(()=>el.classList.remove('show'),3200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REFRESH ALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function refreshAll() {
  refreshSubjectDrops();
  refreshDashboard();
  refreshTasks();
  refreshSubjects();
  refreshExams();
  refreshLinks();
  refreshLog();
  refreshWeekPlanner();
  renderProfileSelect();
  renderNotes();
  document.getElementById('streakNum').textContent = pd().streak||0;
}

function refreshSubjectDrops() {
  ['curSubject','qaSubj','t_subj','ml_subject','sm_subject','note_subj'].forEach(id => {
    const el=document.getElementById(id); if(!el) return;
    const cur=el.value;
    const isTimer = id==='curSubject';
    el.innerHTML = `<option value="">${isTimer?'Subjectâ€¦':'Subjectâ€¦'}</option>` +
      pd().subjects.map(s=>`<option value="${esc(s.name)}"${s.name===cur?' selected':''}>${esc(s.name)}</option>`).join('');
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NETLIFY IDENTITY â€” AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentUser = null; // holds netlify identity user object or null (guest)
let storageKey = 'focus_v3'; // overridden per-user on login

function getStorageKey(user) {
  // Each user gets their own localStorage key so data never mixes
  if (!user) return 'focus_v3_guest';
  return 'focus_v3_' + btoa(user.email).replace(/[^a-z0-9]/gi, '').substring(0, 24);
}

function onLogin(user) {
  currentUser = user;
  storageKey = getStorageKey(user);

  // Update user bar UI
  const name = user.user_metadata?.full_name || user.email.split('@')[0];
  const initials = name.split(' ').map(p => p[0]).join('').toUpperCase().substring(0, 2);
  document.getElementById('userAvatar').textContent = initials;
  document.getElementById('userName').textContent = name;
  document.getElementById('userEmail').textContent = user.email;
  document.getElementById('userBar').style.display = 'flex';

  // Hide auth screen, show app
  document.getElementById('authScreen').classList.add('hidden');

  // Load this user's data
  loadState();
  const savedTheme = localStorage.getItem('focusTheme') || 'dark';
  setTheme(savedTheme);
  themeIdx = themes.indexOf(savedTheme);
  if (themeIdx < 0) themeIdx = 0;
  const qs = document.getElementById('quoteStrip');
  if (qs) qs.textContent = '"' + QUOTES[quoteIdx] + '"';
  setMode('p25');
  if (pd().lastSubject) {
    setTimeout(() => { const s = document.getElementById('curSubject'); if (s) s.value = pd().lastSubject; }, 100);
  }
  refreshAll();
  checkCrash();
  notify(`Welcome back, ${name}! ğŸ‘‹`, 'success');
}

function onLogout() {
  currentUser = null;
  storageKey = 'focus_v3_guest';
  document.getElementById('userBar').style.display = 'none';
  document.getElementById('authScreen').classList.remove('hidden');
  // Reset timer if running
  if (tmr.running) { clearInterval(tmr.interval); tmr.interval = null; tmr.running = false; }
}

function logOut() {
  netlifyIdentity.logout();
}

function enterAsGuest() {
  currentUser = null;
  storageKey = 'focus_v3_guest';
  document.getElementById('userBar').style.display = 'none';
  document.getElementById('authScreen').classList.add('hidden');

  loadState();
  const savedTheme = localStorage.getItem('focusTheme') || 'dark';
  setTheme(savedTheme);
  themeIdx = themes.indexOf(savedTheme);
  if (themeIdx < 0) themeIdx = 0;
  const qs = document.getElementById('quoteStrip');
  if (qs) qs.textContent = '"' + QUOTES[quoteIdx] + '"';
  setMode('p25');
  if (pd().lastSubject) {
    setTimeout(() => { const s = document.getElementById('curSubject'); if (s) s.value = pd().lastSubject; }, 100);
  }
  refreshAll();
  checkCrash();
  notify('Running in guest mode â€” data is local only.', 'info');
}

// Wire up Netlify Identity events
netlifyIdentity.on('login', user => {
  netlifyIdentity.close();
  onLogin(user);
});

netlifyIdentity.on('logout', () => {
  onLogout();
});

// On page load â€” check if already logged in
netlifyIdentity.on('init', user => {
  if (user) {
    onLogin(user);
  }
  // If no user, auth screen stays visible (already shown by default)
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function init() {
  // Theme can load immediately (before auth) for a nicer experience
  const saved = localStorage.getItem('focusTheme') || 'dark';
  setTheme(saved);
  themeIdx = themes.indexOf(saved);
  if (themeIdx < 0) themeIdx = 0;

  setMode('p25');

  // Close sidebar on mobile when clicking outside
  document.addEventListener('click', e => {
    const sb = document.getElementById('sidebar');
    if (window.innerWidth <= 900 && sb.classList.contains('open') && !sb.contains(e.target) && !e.target.closest('.hamburger')) {
      sb.classList.remove('open');
    }
  });

  // Netlify Identity init handles the rest (calls onLogin if session exists)
  netlifyIdentity.init();
}

init();
</script>
</body>
</html>
